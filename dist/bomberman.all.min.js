(function(){var b=this,c=b._,g={},e=Array.prototype,k=Object.prototype,i=e.slice,l=e.unshift,n=k.toString,r=k.hasOwnProperty,o=e.forEach,w=e.map,u=e.reduce,t=e.reduceRight,m=e.filter,y=e.every,x=e.some,B=e.indexOf,A=e.lastIndexOf;k=Array.isArray;var G=Object.keys,f=function(a){return new C(a)};if(typeof module!=="undefined"&&module.exports){module.exports=f;f._=f}else b._=f;f.VERSION="1.1.4";var z=f.each=f.forEach=function(a,d,h){if(a!=null)if(o&&a.forEach===o)a.forEach(d,h);else if(f.isNumber(a.length))for(var j=
0,q=a.length;j<q;j++){if(d.call(h,a[j],j,a)===g)break}else for(j in a)if(r.call(a,j))if(d.call(h,a[j],j,a)===g)break};f.map=function(a,d,h){var j=[];if(a==null)return j;if(w&&a.map===w)return a.map(d,h);z(a,function(q,s,v){j[j.length]=d.call(h,q,s,v)});return j};f.reduce=f.foldl=f.inject=function(a,d,h,j){var q=h!==void 0;if(a==null)a=[];if(u&&a.reduce===u){if(j)d=f.bind(d,j);return q?a.reduce(d,h):a.reduce(d)}z(a,function(s,v,H){if(!q&&v===0){h=s;q=true}else h=d.call(j,h,s,v,H)});if(!q)throw new TypeError("Reduce of empty array with no initial value");
return h};f.reduceRight=f.foldr=function(a,d,h,j){if(a==null)a=[];if(t&&a.reduceRight===t){if(j)d=f.bind(d,j);return h!==void 0?a.reduceRight(d,h):a.reduceRight(d)}a=(f.isArray(a)?a.slice():f.toArray(a)).reverse();return f.reduce(a,d,h,j)};f.find=f.detect=function(a,d,h){var j;E(a,function(q,s,v){if(d.call(h,q,s,v)){j=q;return true}});return j};f.filter=f.select=function(a,d,h){var j=[];if(a==null)return j;if(m&&a.filter===m)return a.filter(d,h);z(a,function(q,s,v){if(d.call(h,q,s,v))j[j.length]=
q});return j};f.reject=function(a,d,h){var j=[];if(a==null)return j;z(a,function(q,s,v){d.call(h,q,s,v)||(j[j.length]=q)});return j};f.every=f.all=function(a,d,h){d=d||f.identity;var j=true;if(a==null)return j;if(y&&a.every===y)return a.every(d,h);z(a,function(q,s,v){if(!(j=j&&d.call(h,q,s,v)))return g});return j};var E=f.some=f.any=function(a,d,h){d=d||f.identity;var j=false;if(a==null)return j;if(x&&a.some===x)return a.some(d,h);z(a,function(q,s,v){if(j=d.call(h,q,s,v))return g});return j};f.include=
f.contains=function(a,d){var h=false;if(a==null)return h;if(B&&a.indexOf===B)return a.indexOf(d)!=-1;E(a,function(j){if(h=j===d)return true});return h};f.invoke=function(a,d){var h=i.call(arguments,2);return f.map(a,function(j){return(d?j[d]:j).apply(j,h)})};f.pluck=function(a,d){return f.map(a,function(h){return h[d]})};f.max=function(a,d,h){if(!d&&f.isArray(a))return Math.max.apply(Math,a);var j={computed:-Infinity};z(a,function(q,s,v){s=d?d.call(h,q,s,v):q;s>=j.computed&&(j={value:q,computed:s})});
return j.value};f.min=function(a,d,h){if(!d&&f.isArray(a))return Math.min.apply(Math,a);var j={computed:Infinity};z(a,function(q,s,v){s=d?d.call(h,q,s,v):q;s<j.computed&&(j={value:q,computed:s})});return j.value};f.sortBy=function(a,d,h){return f.pluck(f.map(a,function(j,q,s){return{value:j,criteria:d.call(h,j,q,s)}}).sort(function(j,q){var s=j.criteria,v=q.criteria;return s<v?-1:s>v?1:0}),"value")};f.sortedIndex=function(a,d,h){h=h||f.identity;for(var j=0,q=a.length;j<q;){var s=j+q>>1;h(a[s])<h(d)?
j=s+1:q=s}return j};f.toArray=function(a){if(!a)return[];if(a.toArray)return a.toArray();if(f.isArray(a))return a;if(f.isArguments(a))return i.call(a);return f.values(a)};f.size=function(a){return f.toArray(a).length};f.first=f.head=function(a,d,h){return d&&!h?i.call(a,0,d):a[0]};f.rest=f.tail=function(a,d,h){return i.call(a,f.isUndefined(d)||h?1:d)};f.last=function(a){return a[a.length-1]};f.compact=function(a){return f.filter(a,function(d){return!!d})};f.flatten=function(a){return f.reduce(a,function(d,
h){if(f.isArray(h))return d.concat(f.flatten(h));d[d.length]=h;return d},[])};f.without=function(a){var d=i.call(arguments,1);return f.filter(a,function(h){return!f.include(d,h)})};f.uniq=f.unique=function(a,d){return f.reduce(a,function(h,j,q){if(0==q||(d===true?f.last(h)!=j:!f.include(h,j)))h[h.length]=j;return h},[])};f.intersect=function(a){var d=i.call(arguments,1);return f.filter(f.uniq(a),function(h){return f.every(d,function(j){return f.indexOf(j,h)>=0})})};f.zip=function(){for(var a=i.call(arguments),
d=f.max(f.pluck(a,"length")),h=Array(d),j=0;j<d;j++)h[j]=f.pluck(a,""+j);return h};f.indexOf=function(a,d,h){if(a==null)return-1;var j;if(h){h=f.sortedIndex(a,d);return a[h]===d?h:-1}if(B&&a.indexOf===B)return a.indexOf(d);h=0;for(j=a.length;h<j;h++)if(a[h]===d)return h;return-1};f.lastIndexOf=function(a,d){if(a==null)return-1;if(A&&a.lastIndexOf===A)return a.lastIndexOf(d);for(var h=a.length;h--;)if(a[h]===d)return h;return-1};f.range=function(a,d,h){if(arguments.length<=1){d=a||0;a=0}h=arguments[2]||
1;for(var j=Math.max(Math.ceil((d-a)/h),0),q=0,s=Array(j);q<j;){s[q++]=a;a+=h}return s};f.bind=function(a,d){var h=i.call(arguments,2);return function(){return a.apply(d||{},h.concat(i.call(arguments)))}};f.bindAll=function(a){var d=i.call(arguments,1);if(d.length==0)d=f.functions(a);z(d,function(h){a[h]=f.bind(a[h],a)});return a};f.memoize=function(a,d){var h={};d=d||f.identity;return function(){var j=d.apply(this,arguments);return r.call(h,j)?h[j]:h[j]=a.apply(this,arguments)}};f.delay=function(a,
d){var h=i.call(arguments,2);return setTimeout(function(){return a.apply(a,h)},d)};f.defer=function(a){return f.delay.apply(f,[a,1].concat(i.call(arguments,1)))};var F=function(a,d,h){var j;return function(){var q=this,s=arguments,v=function(){j=null;a.apply(q,s)};h&&clearTimeout(j);if(h||!j)j=setTimeout(v,d)}};f.throttle=function(a,d){return F(a,d,false)};f.debounce=function(a,d){return F(a,d,true)};f.wrap=function(a,d){return function(){var h=[a].concat(i.call(arguments));return d.apply(this,h)}};
f.compose=function(){var a=i.call(arguments);return function(){for(var d=i.call(arguments),h=a.length-1;h>=0;h--)d=[a[h].apply(this,d)];return d[0]}};f.keys=G||function(a){var d=[],h;for(h in a)if(r.call(a,h))d[d.length]=h;return d};f.values=function(a){return f.map(a,f.identity)};f.functions=f.methods=function(a){return f.filter(f.keys(a),function(d){return f.isFunction(a[d])}).sort()};f.extend=function(a){z(i.call(arguments,1),function(d){for(var h in d)a[h]=d[h]});return a};f.clone=function(a){return f.isArray(a)?
a.slice():f.extend({},a)};f.tap=function(a,d){d(a);return a};f.isEqual=function(a,d){if(a===d)return true;var h=typeof a;if(h!=typeof d)return false;if(a==d)return true;if(!a&&d||a&&!d)return false;if(a._chain)a=a._wrapped;if(d._chain)d=d._wrapped;if(a.isEqual)return a.isEqual(d);if(f.isDate(a)&&f.isDate(d))return a.getTime()===d.getTime();if(f.isNaN(a)&&f.isNaN(d))return false;if(f.isRegExp(a)&&f.isRegExp(d))return a.source===d.source&&a.global===d.global&&a.ignoreCase===d.ignoreCase&&a.multiline===
d.multiline;if(h!=="object")return false;if(a.length&&a.length!==d.length)return false;h=f.keys(a);var j=f.keys(d);if(h.length!=j.length)return false;for(var q in a)if(!(q in d)||!f.isEqual(a[q],d[q]))return false;return true};f.isEmpty=function(a){if(f.isArray(a)||f.isString(a))return a.length===0;for(var d in a)if(r.call(a,d))return false;return true};f.isElement=function(a){return!!(a&&a.nodeType==1)};f.isArray=k||function(a){return n.call(a)==="[object Array]"};f.isArguments=function(a){return!!(a&&
r.call(a,"callee"))};f.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)};f.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};f.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)};f.isNaN=function(a){return a!==a};f.isBoolean=function(a){return a===true||a===false};f.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)};f.isRegExp=function(a){return!!(a&&a.test&&a.exec&&(a.ignoreCase||a.ignoreCase===false))};f.isNull=function(a){return a===
null};f.isUndefined=function(a){return a===void 0};f.noConflict=function(){b._=c;return this};f.identity=function(a){return a};f.times=function(a,d,h){for(var j=0;j<a;j++)d.call(h,j)};f.mixin=function(a){z(f.functions(a),function(d){I(d,f[d]=a[d])})};var J=0;f.uniqueId=function(a){var d=J++;return a?a+d:d};f.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g};f.template=function(a,d){var h=f.templateSettings;h="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+
a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(h.interpolate,function(j,q){return"',"+q.replace(/\\'/g,"'")+",'"}).replace(h.evaluate||null,function(j,q){return"');"+q.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');";h=new Function("obj",h);return d?h(d):h};var C=function(a){this._wrapped=a};f.prototype=C.prototype;var D=function(a,d){return d?f(a).chain():a},I=function(a,d){C.prototype[a]=function(){var h=
i.call(arguments);l.call(h,this._wrapped);return D(d.apply(f,h),this._chain)}};f.mixin(f);z(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var d=e[a];C.prototype[a]=function(){d.apply(this._wrapped,arguments);return D(this._wrapped,this._chain)}});z(["concat","join","slice"],function(a){var d=e[a];C.prototype[a]=function(){return D(d.apply(this._wrapped,arguments),this._chain)}});C.prototype.chain=function(){this._chain=true;return this};C.prototype.value=function(){return this._wrapped}})();
var OGE={};OGE.Direction=function(b,c){this.cos=typeof b!="undefined"?b:0;this.sin=typeof c!="undefined"?c:0};OGE.Direction.prototype.rotate=function(b){b=b*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+b);this.sin=Math.sin(Math.asin(this.sin)+b);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(b,c){this.x=typeof b!="undefined"?b:0;this.y=typeof c!="undefined"?c:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(b){for(var c=0;c<this.bodies.length;c++)if(this.bodies[c]===b)return;this.bodies.push(b)};OGE.Zone.prototype.removeBody=function(b){for(var c=0;c<this.bodies.length;c++)if(this.bodies[c]===b){this.bodies.splice(c,1);break}};
OGE.Body=function(b,c,g,e){this.x=typeof b!="undefined"?b:0;this.y=typeof c!="undefined"?c:0;this.width=typeof g!="undefined"?g:1;this.height=typeof e!="undefined"?e:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(b){this.onCollisions.push(b)};
OGE.Body.prototype.collide=function(b){for(var c=true,g=0;g<this.onCollisions.length;g++)if(this.onCollisions[g](b)===false)c=false;return c};OGE.Body.prototype.collide=function(b){for(var c=true,g=0;g<this.onCollisions.length;g++)if(this.onCollisions[g](b)===false)c=false;return c};OGE.Body.prototype.intersects=function(b,c,g,e){var k;k=b;if(arguments.length===1){k=b.x;c=b.y;g=b.width;e=b.height}return this.x<k+g&&this.x+this.width>k&&this.y<c+e&&this.y+this.height>c};
OGE.Body.prototype.intersection=function(b,c,g,e){var k;k=b;if(arguments.length===1){k=b.x;c=b.y;g=b.width;e=b.height}return((this.x+this.width<k+g?this.x+this.width:k+g)-(this.x>k?this.x:k))*((this.y+this.height<c+e?this.y+this.width:c+e)-(this.y>c?this.y:c))};
OGE.World=function(b,c,g){this.width=typeof b!="undefined"?b:640;this.height=typeof c!="undefined"?c:480;this.zoneSize=typeof g!="undefined"?g:10;this.activeBodies=[];b=b/this.zoneSize+1<<0;c=c/this.zoneSize+1<<0;this.zones=[];for(g=0;g<b;g++){this.zones[g]=[];for(var e=0;e<c;e++)this.zones[g][e]=new OGE.Zone(g,e)}};OGE.World.prototype.addBody=function(b,c){if(this.addBodyToZones(b)!==true)return false;if(arguments.length>=2)b.active=c;b.active&&this.activeBodies.push(b);return true};
OGE.World.prototype.removeBody=function(b){this.removeBodyFromZones(b);for(var c=0;c<this.activeBodies.length;c++)if(this.activeBodies[c]===b){this.activeBodies.splice(c,1);break}};
OGE.World.prototype.getBodies=function(b,c,g,e){var k,i;k=i=b;if(arguments.length===1){i=k.x;c=k.y;g=k.width;e=k.height}i=i<0?0:i;i=i+g>this.width?this.width-g:i;c=c<0?0:c;c=c+e>this.height?this.height-e:c;k=[];i=this.getZones(i,c,g,e);for(var l=0;l<i.length;l++)for(var n=i[l].bodies,r=0;r<n.length;r++){for(var o=n[r],w=false,u=0;u<k.length;u++)if(k[u]===o){w=true;break}w||k.push(o)}return k};
OGE.World.prototype.getZones=function(b,c,g,e){var k,i;k=i=b;if(arguments.length===1){i=k.x;c=k.y;g=k.width;e=k.height}if(i>=0&&i+g-1<this.width&&c>=0&&c+e-1<this.height){k=(i+g)/this.zoneSize<<0;var l=c/this.zoneSize<<0,n=(c+e)/this.zoneSize<<0,r=0,o=[];for(i=i/this.zoneSize<<0;i<=k;i++)for(c=l;c<=n;c++)o[r++]=this.zones[i][c];return o}else return[]};
OGE.World.prototype.step=function(b){b=arguments.length===0?1:b;for(var c=0;c<b;c++)for(var g=0;g<this.activeBodies.length;g++){var e=this.activeBodies[g];e.speed>0&&e.direction!==null&&this.moveBody(e)}};OGE.World.prototype.addBodyToZones=function(b){var c=this.getZones(b);if(c.length===0)return false;for(var g=0;g<c.length;g++)c[g].addBody(b);return true};OGE.World.prototype.removeBodyFromZones=function(b){for(var c=this.getZones(b),g=0;g<c.length;g++)c[g].removeBody(b)};
OGE.World.prototype.moveBody=function(b,c,g){var e,k,i;if(arguments.length===1){c=b.direction;g=b.speed}for(var l=0;l<g;l++){e=b.x;k=b.y;this.removeBodyFromZones(b);b.x+=c.cos;b.y+=c.sin;i=this.getBodies(b);for(var n=0;n<i.length;n++){var r=i[n];if(b!==r&&!r.intersects(e,k,b.width,b.height)&&r.intersects(b)){var o=b.collide(r)===true;r=r.collide(b)===true;if(o&&r){b.x=e;b.y=k;this.addBodyToZones(b);if(b.slide&&n>=0)this.slideBody(b,c);else return}}}this.addBodyToZones(b)}};
OGE.World.prototype.slideBody=function(b,c){var g=this,e=function(i){var l=0,n=b.x+i.cos*1.9<<0;if(n!==b.x)n=b.x+(n>b.x?1:-1);i=b.y+i.sin*1.9<<0;if(i!==b.y)i=b.y+(i>b.y?1:-1);for(var r=g.getBodies(n,i,b.width,b.height),o=0;o<r.length;o++){var w=r[o];if(w!==b&&w.intersects(n,i,b.width,b.height))l+=w.intersection(n,i,b.width,b.height)}return l<<0},k=e(c.clone().rotate(-45));e=e(c.clone().rotate(45));if(k<e)this.moveBody(b,c.clone().rotate(-90),1);else k>e&&this.moveBody(b,c.clone().rotate(90),1)};
Object.construct_prototype=function(b){var c=function(){};c.prototype=b.prototype;return new c};Player=function(b,c,g,e,k){this.nick=k;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.power=this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);
Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};Player.deserialize=function(b){return _.extend(new Player(b.x,b.y,b.width,b.height,b.nick),b)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=4;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);
Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(b,c){this.world=new OGE.World(b,c,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};
Game.prototype.getBomb=function(b,c){for(var g=0;g<this.bombs.length;g++)if(this.bombs[g].x===b&&this.bombs[g].y===c)return this.bombs[g];return null};Game.prototype.removeBoxes=function(b,c){var g=this;_.each(c.bodies,function(e){e instanceof Box&&e.armor===b.power&&g.removeBody(e)})};
Game.prototype.explodeBomb=function(b,c){if(arguments.length===1)c={x:b.x,y:b.y,bodies:[],fires:[]};var g=b.size*b.width,e=b.size*b.height,k=this;this.removeBody(b);var i=function(n,r,o){c.fires[n]||(c.fires[n]=[]);c.fires[n][r]||(c.fires[n][r]=o)};i(b.x,b.y,"c");var l=function(n,r,o,w,u){for(n=b.x+n;n<=b.x+o;n+=b.width)for(var t=b.y+r;t<=b.y+w;t+=b.height)if(n>=0&&t>=0&&n<k.world.width&&t<k.world.height)for(var m=k.world.getBodies(n,t,b.width,b.height),y=0;y<m.length;y++){var x=m[y];if(x!==b&&x.intersects(n,
t,b.width,b.height)){_.contains(c.bodies,x)||c.bodies.push(x);if(x.armor>=b.power){if(c.fires[n]&&c.fires[n][t])c.fires[n][t]=null;return}else k.removeBody(x);x instanceof Bomb&&k.explodeBomb(x,c)}i(n,t,u)}};l(-g,0,-b.width,0,"l");l(+b.width,0,+g,0,"r");l(0,-e,0,-b.height,"u");l(0,+b.height,0,+e,"d");return c};
Game.prototype.addBody=function(b,c){if(!this.world.addBody(b,c))return false;if(b instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=b;this.players.push(b)}else b instanceof Bomb&&this.bombs.push(b);return true};
Game.prototype.serialize=function(){var b=this,c={width:this.world.width,height:this.world.height},g=function(e,k){if(b[e].length>0){var i=b[e][0].width;c[e]={};c[e].size=i;c[e].pos=[];c[e].attrs={};_.each(b[e],function(l){c[e].pos.push(l.y/i*Math.floor(b.world.width/i)+l.x/i);_.each(k,function(n){c[e].attrs[n]=l[n]})})}};if(this.players.length>0){c.players=[];_.each(this.players,function(e){c.players.push(e.serialize())})}g("blocks",["armor"]);g("bricks");return c};
Game.prototype.removeBody=function(b){this.world.removeBody(b);this.players=_.without(this.players,b);this.bombs=_.without(this.bombs,b);this.blocks=_.without(this.blocks,b);this.bricks=_.without(this.bricks,b)};Game.prototype.getPlayer=function(b){for(var c=0;c<this.players.length;c++)if(this.players[c].nick===b)return this.players[c]};
Game.prototype.createBlocks=function(b){for(var c=1;c<this.world.height/b-2;c+=2)for(var g=1;g<this.world.width/b-2;g+=2){var e=new Box(g*b,c*b,b,b);e.armor=2;this.blocks.push(e);this.addBody(e)}return this};Game.prototype.createBricks=function(b,c){for(var g=this.world.width/b,e=this.world.height/b,k=0;k<e-1;k++)for(var i=0;i<g-1;i++)if(Math.random()*100<c&&!(i%2===1&&k%2===1))if((i>1||k>1)&&(i>1||k<e-2)&&(i<g-2||k>1)&&(i<g-2||k<e-2)){var l=new Box(i*b,k*b,b,b);this.bricks.push(l);this.addBody(l)}return this};
Game.deserialize=function(b){var c=new Game(b.width,b.height),g=function(e){if(b[e].pos.length>0){var k=b[e].size,i=Math.floor(b.width/k);_.each(b[e].pos,function(l){var n=new Box(l%i*k,Math.floor(l/i)*k,k,k);_.each(b[e].attrs,function(r,o){n[o]=b[e].attrs[o]});c[e].push(n);c.addBody(n)})}};g("blocks");g("bricks");b.players&&b.players.length>0&&_.each(b.players,function(e){c.addBody(Player.deserialize(e),true)});return c};var $infoArea,utils={};
utils.log=function(b,c){if(arguments.length===1){c=b;b=c.cmd}typeof console!=="undefined"&&console!==null&&console.log(b,c);c=b+" - "+c.result;$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+c);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};$(function(){$infoArea=$("#infoArea");var b=new HttpClient,c=new SocketClient,g=new GameHandler(e,c),e=new LobbyHandler(g,b,c);new GamePanel(g);new LobbyPanel(e)});
LobbyHandler=function(b,c,g){c=new HttpClient(this);var e;this.createGame=function(k){c.createGame(function(i){if(i.result==="OK"){i=Game.deserialize(i.data);b.startGame(i,e.nick);k(true)}else k(fale)})};this.playNow=function(k){c.playNow(function(i){if(i.result==="OK"){i=Game.deserialize(i.data);b.startGame(i,e.nick);k(true)}else k(false)})};this.login=function(k,i){c.login(k,function(l){if(l.result==="OK"){e=l.data;g.send("authPlayer",{guid:e.guid});i(true)}else i(false)})}};
HttpClient=function(){var b;this.createGame=function(c){$.getJSON("/lobby?cmd=createGame&guid="+b.guid,function(g){utils.log("createGame",g);c(g)})};this.playNow=function(c){$.getJSON("/lobby?cmd=joinGame&guid="+b.guid,function(g){utils.log("playNow",g);c(g)})};this.login=function(c,g){$.getJSON("/lobby?cmd=loginPlayer&nick="+c,function(e){utils.log("loginPlayer",e);if(e.result==="OK")b=e.data;g(e)})}};
LobbyPanel=function(b){var c=$("#loginPanel"),g=$("#loginButton"),e=$("#lobbyPanel"),k=$("#nickField"),i=$("#playNowButton"),l=$("#createGameButton"),n=function(){b.createGame(function(w){w&&e.hide()})},r=function(){b.playNow(function(){e.hide()})},o=function(){k.val().length>0&&b.login(k.val(),function(w){if(w){c.hide();e.show()}else{k.focus();c.children("span").text("Nick taken!")}})};(function(){k.keypress(function(w){if(w.keyCode===13){k.blur();o()}});g.click(function(){o()});i.click(function(){r()});
l.click(function(){n()});k.focus()})()};
GameHandler=function(b,c){var g,e,k;listeners={};this.addListener=function(i,l){if(typeof listeners[i]==="undefined")listeners[i]=[];listeners[i].push(l)};this.removeBody=function(i){g.removeBody(i)};this.startGame=function(i,l){g=i;e=g.getPlayer(l);k=new FactorialTimer;k.start(function(n){g.world.step();_.each(listeners.step,function(r){r(n)})});_.each(listeners.startGame,function(n){n(g)})};this.startMove=function(i,l){if(!e.dead){e.direction=new OGE.Direction(i,l);c.send("startMove",{cos:i,sin:l,
x:e.x,y:e.y})}};this.endMove=function(){if(!e.dead){e.direction=null;c.send("endMove",{x:e.x,y:e.y})}};this.placeBomb=function(){if(!e.dead)if(e.bombs>0){e.bombs--;var i=new Bomb(Math.floor((e.x+8)/16)*16,Math.floor((e.y+8)/16)*16,16,16);g.addBody(i);i.power=e.power;c.send("placeBomb",{x:i.x,y:i.y});return i}};c.addListener("joinGame",function(i,l){p=Player.deserialize(l.player);g.addBody(p,true);_.each(listeners.addPlayer,function(n){n(p)})});c.addListener("startMove",function(i,l){p=g.getPlayer(l.player);
p.direction=new OGE.Direction(l.cos,l.sin);p.x=l.x;p.y=l.y});c.addListener("endMove",function(i,l){p=g.getPlayer(l.player);p.direction=null;p.x=l.x;p.y=l.y});c.addListener("logoutPlayer",function(i,l){p=g.getPlayer(l.player);p.$img.remove();g.removeBody(p)});c.addListener("placeBomb",function(i,l){var n=new Bomb(l.x,l.y,16,16);g.addBody(n);_.each(listeners.placeBomb,function(r){r(n)})});c.addListener("explodeBomb",function(i,l){var n=g.getBomb(l.x,l.y);g.getPlayer(l.player).bombs++;if(n!==null){l=
g.explodeBomb(n);if(_.include(l.bodies,e)){_.each(listeners.meDead,function(){});e.x=0;e.y=0;c.send("playerDead",{})}_.each(listeners.explodeBomb,function(r){r(n,l)})}});c.addListener("playerDead",function(i,l){var n=g.getPlayer(l.player);n.x=0;n.y=0;_.each(listeners.playerDead,function(){})});c.addListener("resurectPlayer",function(i,l){var n=g.getPlayer(l.player);g.addBody(n);_.each(listeners.resurectPlayer,function(r){r(n)})})};
SocketClient=function(){var b=new io.Socket,c={};this.addListener=function(g,e){if(typeof c[g]==="undefined")c[g]=[];c[g].push(e)};this.send=function(g,e){b.send({cmd:g,data:e})};b.connect();b.on("message",function(g){utils.log(g);_.each(c[g.cmd],function(e){e(g.result,g.data)})})};
GamePanel=function(b){var c=$("#gamePanel"),g=$("#fpsLabel"),e,k=[],i=[];b.addListener("startGame",function(o){e=new KeyboardHandler;c.find("*").remove();c.show();c.width(o.world.width).height(o.world.height);$.each(o.blocks,function(u,t){l(t,"block")});$.each(o.bricks,function(u,t){l(t,"brick")});$.each(o.players,function(u,t){n(t)});e.keydown(function(u){var t=0,m=0;switch(u){case "space":(u=b.placeBomb())&&r(u);break;case "left":t=-1;break;case "up":m=-1;break;case "right":t=1;break;case "down":m=
1}if(t!==0||m!==0)b.startMove(t,m)}).keyup(function(){b.endMove()});var w=0;b.addListener("step",function(u){if(++w===20){g.text("Time: "+u);w=0}$.each(o.players,function(t,m){m.$img.css("left",m.x).css("top",m.y-4);if(m.direction!==null&&m.speed>0){if(m.lastDirection!==m.direction){m.animate=0;m.lastDirection=m.direction}if(--m.animate<0){m.animate=5;if(++m.sprite>=m.sprites.length)m.sprite=0;var y;if(m.direction.cos!==0)y=m.direction.cos>0?"r":"l";else if(m.direction.sin!==0)y=m.direction.sin>0?
"d":"u";m.$img.attr("src","/images/p"+y+m.sprites[m.sprite]+".png")}}});$.each(o.bombs,function(t,m){if(--m.animate<0){m.animate=5;if(++m.sprite>=m.sprites.length)m.sprite=0;m.$img.attr("src","/images/bomb"+m.sprites[m.sprite]+".png")}});$.each(k,function(t,m){if(--m.animate<0){m.animate=5;if(++m.sprite>4){_.without(k,m);m.$img.remove()}else m.$img.attr("src","/images/f"+m.f+m.sprite+".png")}});$.each(i,function(t,m){if(--m.animate<0){m.animate=5;if(++m.sprite>2){_.without(i,m);b.removeBody(m);m.$img.remove()}else m.$img.attr("src",
"/images/fb"+m.sprite+".png")}})});b.addListener("explodeBomb",function(u,t){u.$img.remove();for(var m=0;m<t.fires.length;m++)if(t.fires[m])for(var y=0;y<t.fires[m].length;y++)if(t.fires[m][y]){var x=t.fires[m][y];if(x==="l"||x==="r")x="h";else if(x==="u"||x==="d")x="v";var B=$("<img>").attr("src","images/f"+x+"1.png").css("left",m).css("top",y).addClass("body");k.push({f:x,animate:5,sprite:1,$img:B});c.append(B)}_.each(t.bodies,function(A){if(A instanceof Box&&A.armor===u.power){A.animate=0;A.sprite=
0;i.push(A)}})})});b.addListener("addPlayer",function(o){n(o)});b.addListener("placeBomb",function(o){r(o)});b.addListener("meDead",function(o){o.$img.remove()});b.addListener("playerDead",function(o){o.$img.remove()});b.addListener("resurectPlayer",function(o){c.append(o.$img)});var l=function(o,w){var u=$("<img>").attr("src","images/"+w+".png").css("left",o.x).css("top",o.y).addClass("body");c.append(u);return o.$img=u},n=function(o){l(o,"pl1").addClass("player");o.animate=0;o.sprite=0;o.sprites=
[1,2,1,3]},r=function(o){o.animate=0;o.sprite=0;o.sprites=[1,2,3];l(o,"bomb1")}};
KeyboardHandler=function(){var b,c,g;this.keydown=function(e){c=e;return this};this.keyup=function(e){g=e;return this};$(document).keydown(function(e){var k=null;switch(e.keyCode){case 32:k="space";break;case 37:case 65:k="left";break;case 38:case 87:k="up";break;case 39:case 68:k="right";break;case 40:case 83:k="down"}if(k!==null){if(b!==e.keyCode){b=e.keyCode;c(k)}e.stopPropagation();e.preventDefault();return false}}).keyup(function(e){if(e.keyCode===b){b=0;g()}}).keypress(function(e){switch(e.keyCode){case 32:case 37:case 38:case 39:case 40:e.stopPropagation();
e.preventDefault();return false}})};FactorialTimer=function(){var b=(new Date).getTime(),c=0,g=50,e;this.start=function(i){e=i;k()};var k=function(){c=b=Math.floor(((new Date).getTime()-b)*0.9+c*0.1);if(b>50&&g>45)g--;else b<50&&g<55&&g++;e(b);b=(new Date).getTime();setTimeout(k,g)}};
