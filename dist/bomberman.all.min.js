var $infoArea,utils={};utils.log=function(e,d){if(arguments.length===1){d=e;e=d.cmd}typeof console!=="undefined"&&console!==null&&console.log(e,d);d=e+" - "+d.result;$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+d);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};$(function(){$infoArea=$("#infoArea");var e=new HttpClient,d=new SocketClient,c=new GameHandler(a,d),a=new LobbyHandler(c,e,d);new GamePanel(c);new LobbyPanel(a)});
LobbyHandler=function(e,d,c){d=new HttpClient(this);var a;this.createGame=function(i){d.createGame(function(f){if(f.result==="OK"){f=Game.deserialize(f.data);e.startGame(f,a.nick);i(true)}else i(fale)})};this.playNow=function(i){d.playNow(function(f){if(f.result==="OK"){f=Game.deserialize(f.data);e.startGame(f,a.nick);i(true)}else i(false)})};this.login=function(i,f){d.login(i,function(g){if(g.result==="OK"){a=g.data;c.send("authPlayer",{guid:a.guid});f(true)}else f(false)})}};
HttpClient=function(){var e;this.createGame=function(d){$.getJSON("/lobby?cmd=createGame&guid="+e.guid,function(c){utils.log("createGame",c);d(c)})};this.playNow=function(d){$.getJSON("/lobby?cmd=joinGame&guid="+e.guid,function(c){utils.log("playNow",c);d(c)})};this.login=function(d,c){$.getJSON("/lobby?cmd=loginPlayer&nick="+d,function(a){utils.log("loginPlayer",a);if(a.result==="OK")e=a.data;c(a)})}};
LobbyPanel=function(e){var d=$("#loginPanel"),c=$("#loginButton"),a=$("#lobbyPanel"),i=$("#nickField"),f=$("#playNowButton"),g=$("#createGameButton"),j=function(){e.createGame(function(n){n&&a.hide()})},m=function(){e.playNow(function(){a.hide()})},h=function(){i.val().length>0&&e.login(i.val(),function(n){if(n){d.hide();a.show()}else{i.focus();d.children("span").text("Nick taken!")}})};(function(){i.keypress(function(n){if(n.keyCode===13){i.blur();h()}});c.click(function(){h()});f.click(function(){m()});
g.click(function(){j()});i.focus()})()};
GameHandler=function(e,d){var c,a,i;listeners={};this.addListener=function(f,g){if(typeof listeners[f]==="undefined")listeners[f]=[];listeners[f].push(g)};this.removeBody=function(f){c.removeBody(f)};this.startGame=function(f,g){c=f;a=c.getPlayer(g);i=new FactorialTimer;i.start(function(j){c.world.step();_.each(listeners.step,function(m){m(j)})});_.each(listeners.startGame,function(j){j(c)})};this.startMove=function(f,g){if(!a.dead){a.direction=new OGE.Direction(f,g);d.send("startMove",{cos:f,sin:g,
x:a.x,y:a.y})}};this.endMove=function(){if(!a.dead){a.direction=null;d.send("endMove",{x:a.x,y:a.y})}};this.placeBomb=function(){if(!a.dead)if(a.bombs>0){a.bombs--;var f=new Bomb(Math.floor((a.x+8)/16)*16,Math.floor((a.y+8)/16)*16,16,16);c.addBody(f);f.power=a.power;d.send("placeBomb",{x:f.x,y:f.y});return f}};d.addListener("joinGame",function(f,g){p=Player.deserialize(g.player);c.addBody(p,true);_.each(listeners.addPlayer,function(j){j(p)})});d.addListener("startMove",function(f,g){p=c.getPlayer(g.player);
p.direction=new OGE.Direction(g.cos,g.sin);p.x=g.x;p.y=g.y});d.addListener("endMove",function(f,g){p=c.getPlayer(g.player);p.direction=null;p.x=g.x;p.y=g.y});d.addListener("logoutPlayer",function(f,g){p=c.getPlayer(g.player);p.$img.remove();c.removeBody(p)});d.addListener("placeBomb",function(f,g){var j=new Bomb(g.x,g.y,16,16);c.addBody(j);_.each(listeners.placeBomb,function(m){m(j)})});d.addListener("explodeBomb",function(f,g){var j=c.getBomb(g.x,g.y);c.getPlayer(g.player).bombs++;if(j!==null){g=
c.explodeBomb(j);if(_.include(g.bodies,a)){_.each(listeners.meDead,function(){});a.x=0;a.y=0;d.send("playerDead",{})}_.each(listeners.explodeBomb,function(m){m(j,g)})}});d.addListener("playerDead",function(f,g){var j=c.getPlayer(g.player);j.x=0;j.y=0;_.each(listeners.playerDead,function(){})});d.addListener("resurectPlayer",function(f,g){var j=c.getPlayer(g.player);c.addBody(j);_.each(listeners.resurectPlayer,function(m){m(j)})})};
SocketClient=function(){var e=new io.Socket,d={};this.addListener=function(c,a){if(typeof d[c]==="undefined")d[c]=[];d[c].push(a)};this.send=function(c,a){e.send({cmd:c,data:a})};e.connect();e.on("message",function(c){utils.log(c);_.each(d[c.cmd],function(a){a(c.result,c.data)})})};
GamePanel=function(e){var d=$("#gamePanel"),c=$("#fpsLabel"),a,i=[],f=[];e.addListener("startGame",function(h){a=new KeyboardHandler;d.find("*").remove();d.show();d.width(h.world.width).height(h.world.height);$.each(h.blocks,function(l,k){g(k,"block")});$.each(h.bricks,function(l,k){g(k,"brick")});$.each(h.players,function(l,k){j(k)});a.keydown(function(l){var k=0,b=0;switch(l){case "space":(l=e.placeBomb())&&m(l);break;case "left":k=-1;break;case "up":b=-1;break;case "right":k=1;break;case "down":b=
1}if(k!==0||b!==0)e.startMove(k,b)}).keyup(function(){e.endMove()});var n=0;e.addListener("step",function(l){if(++n===20){c.text("Time: "+l);n=0}$.each(h.players,function(k,b){b.$img.css("left",b.x).css("top",b.y-4);if(b.direction!==null&&b.speed>0){if(b.lastDirection!==b.direction){b.animate=0;b.lastDirection=b.direction}if(--b.animate<0){b.animate=5;if(++b.sprite>=b.sprites.length)b.sprite=0;var o;if(b.direction.cos!==0)o=b.direction.cos>0?"r":"l";else if(b.direction.sin!==0)o=b.direction.sin>0?
"d":"u";b.$img.attr("src","/images/p"+o+b.sprites[b.sprite]+".png")}}});$.each(h.bombs,function(k,b){if(--b.animate<0){b.animate=5;if(++b.sprite>=b.sprites.length)b.sprite=0;b.$img.attr("src","/images/bomb"+b.sprites[b.sprite]+".png")}});$.each(i,function(k,b){if(--b.animate<0){b.animate=5;if(++b.sprite>4){_.without(i,b);b.$img.remove()}else b.$img.attr("src","/images/f"+b.f+b.sprite+".png")}});$.each(f,function(k,b){if(--b.animate<0){b.animate=5;if(++b.sprite>2){_.without(f,b);e.removeBody(b);b.$img.remove()}else b.$img.attr("src",
"/images/fb"+b.sprite+".png")}})});e.addListener("explodeBomb",function(l,k){l.$img.remove();for(var b=0;b<k.fires.length;b++)if(k.fires[b])for(var o=0;o<k.fires[b].length;o++)if(k.fires[b][o]){var q=k.fires[b][o];if(q==="l"||q==="r")q="h";else if(q==="u"||q==="d")q="v";var s=$("<img>").attr("src","images/f"+q+"1.png").css("left",b).css("top",o).addClass("body");i.push({f:q,animate:5,sprite:1,$img:s});d.append(s)}_.each(k.bodies,function(r){if(r instanceof Box&&r.armor===l.power){r.animate=0;r.sprite=
0;f.push(r)}})})});e.addListener("addPlayer",function(h){j(h)});e.addListener("placeBomb",function(h){m(h)});e.addListener("meDead",function(h){h.$img.remove()});e.addListener("playerDead",function(h){h.$img.remove()});e.addListener("resurectPlayer",function(h){d.append(h.$img)});var g=function(h,n){var l=$("<img>").attr("src","images/"+n+".png").css("left",h.x).css("top",h.y).addClass("body");d.append(l);return h.$img=l},j=function(h){g(h,"pl1").addClass("player");h.animate=0;h.sprite=0;h.sprites=
[1,2,1,3]},m=function(h){h.animate=0;h.sprite=0;h.sprites=[1,2,3];g(h,"bomb1")}};
KeyboardHandler=function(){var e,d,c;this.keydown=function(a){d=a;return this};this.keyup=function(a){c=a;return this};$(document).keydown(function(a){var i=null;switch(a.keyCode){case 32:i="space";break;case 37:case 65:i="left";break;case 38:case 87:i="up";break;case 39:case 68:i="right";break;case 40:case 83:i="down"}if(i!==null){if(e!==a.keyCode){e=a.keyCode;d(i)}a.stopPropagation();a.preventDefault();return false}}).keyup(function(a){if(a.keyCode===e){e=0;c()}}).keypress(function(a){switch(a.keyCode){case 32:case 37:case 38:case 39:case 40:a.stopPropagation();
a.preventDefault();return false}})};FactorialTimer=function(){var e=(new Date).getTime(),d=0,c=50,a;this.start=function(f){a=f;i()};var i=function(){d=e=Math.floor(((new Date).getTime()-e)*0.9+d*0.1);if(e>50&&c>45)c--;else e<50&&c<55&&c++;a(e);e=(new Date).getTime();setTimeout(i,c)}};
