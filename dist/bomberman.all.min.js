(function(){var b=this,d=b._,h={},g=Array.prototype,k=Object.prototype,j=g.slice,n=g.unshift,o=k.toString,l=k.hasOwnProperty,r=g.forEach,t=g.map,w=g.reduce,z=g.reduceRight,A=g.filter,B=g.every,C=g.some,x=g.indexOf,D=g.lastIndexOf;k=Array.isArray;var G=Object.keys,e=function(a){return new v(a)};if(typeof module!=="undefined"&&module.exports){module.exports=e;e._=e}else b._=e;e.VERSION="1.1.4";var u=e.each=e.forEach=function(a,c,f){if(a!=null)if(r&&a.forEach===r)a.forEach(c,f);else if(e.isNumber(a.length))for(var i=
0,m=a.length;i<m;i++){if(c.call(f,a[i],i,a)===h)break}else for(i in a)if(l.call(a,i))if(c.call(f,a[i],i,a)===h)break};e.map=function(a,c,f){var i=[];if(a==null)return i;if(t&&a.map===t)return a.map(c,f);u(a,function(m,q,s){i[i.length]=c.call(f,m,q,s)});return i};e.reduce=e.foldl=e.inject=function(a,c,f,i){var m=f!==void 0;if(a==null)a=[];if(w&&a.reduce===w){if(i)c=e.bind(c,i);return m?a.reduce(c,f):a.reduce(c)}u(a,function(q,s,H){if(!m&&s===0){f=q;m=true}else f=c.call(i,f,q,s,H)});if(!m)throw new TypeError("Reduce of empty array with no initial value");
return f};e.reduceRight=e.foldr=function(a,c,f,i){if(a==null)a=[];if(z&&a.reduceRight===z){if(i)c=e.bind(c,i);return f!==void 0?a.reduceRight(c,f):a.reduceRight(c)}a=(e.isArray(a)?a.slice():e.toArray(a)).reverse();return e.reduce(a,c,f,i)};e.find=e.detect=function(a,c,f){var i;E(a,function(m,q,s){if(c.call(f,m,q,s)){i=m;return true}});return i};e.filter=e.select=function(a,c,f){var i=[];if(a==null)return i;if(A&&a.filter===A)return a.filter(c,f);u(a,function(m,q,s){if(c.call(f,m,q,s))i[i.length]=
m});return i};e.reject=function(a,c,f){var i=[];if(a==null)return i;u(a,function(m,q,s){c.call(f,m,q,s)||(i[i.length]=m)});return i};e.every=e.all=function(a,c,f){c=c||e.identity;var i=true;if(a==null)return i;if(B&&a.every===B)return a.every(c,f);u(a,function(m,q,s){if(!(i=i&&c.call(f,m,q,s)))return h});return i};var E=e.some=e.any=function(a,c,f){c=c||e.identity;var i=false;if(a==null)return i;if(C&&a.some===C)return a.some(c,f);u(a,function(m,q,s){if(i=c.call(f,m,q,s))return h});return i};e.include=
e.contains=function(a,c){var f=false;if(a==null)return f;if(x&&a.indexOf===x)return a.indexOf(c)!=-1;E(a,function(i){if(f=i===c)return true});return f};e.invoke=function(a,c){var f=j.call(arguments,2);return e.map(a,function(i){return(c?i[c]:i).apply(i,f)})};e.pluck=function(a,c){return e.map(a,function(f){return f[c]})};e.max=function(a,c,f){if(!c&&e.isArray(a))return Math.max.apply(Math,a);var i={computed:-Infinity};u(a,function(m,q,s){q=c?c.call(f,m,q,s):m;q>=i.computed&&(i={value:m,computed:q})});
return i.value};e.min=function(a,c,f){if(!c&&e.isArray(a))return Math.min.apply(Math,a);var i={computed:Infinity};u(a,function(m,q,s){q=c?c.call(f,m,q,s):m;q<i.computed&&(i={value:m,computed:q})});return i.value};e.sortBy=function(a,c,f){return e.pluck(e.map(a,function(i,m,q){return{value:i,criteria:c.call(f,i,m,q)}}).sort(function(i,m){var q=i.criteria,s=m.criteria;return q<s?-1:q>s?1:0}),"value")};e.sortedIndex=function(a,c,f){f=f||e.identity;for(var i=0,m=a.length;i<m;){var q=i+m>>1;f(a[q])<f(c)?
i=q+1:m=q}return i};e.toArray=function(a){if(!a)return[];if(a.toArray)return a.toArray();if(e.isArray(a))return a;if(e.isArguments(a))return j.call(a);return e.values(a)};e.size=function(a){return e.toArray(a).length};e.first=e.head=function(a,c,f){return c&&!f?j.call(a,0,c):a[0]};e.rest=e.tail=function(a,c,f){return j.call(a,e.isUndefined(c)||f?1:c)};e.last=function(a){return a[a.length-1]};e.compact=function(a){return e.filter(a,function(c){return!!c})};e.flatten=function(a){return e.reduce(a,function(c,
f){if(e.isArray(f))return c.concat(e.flatten(f));c[c.length]=f;return c},[])};e.without=function(a){var c=j.call(arguments,1);return e.filter(a,function(f){return!e.include(c,f)})};e.uniq=e.unique=function(a,c){return e.reduce(a,function(f,i,m){if(0==m||(c===true?e.last(f)!=i:!e.include(f,i)))f[f.length]=i;return f},[])};e.intersect=function(a){var c=j.call(arguments,1);return e.filter(e.uniq(a),function(f){return e.every(c,function(i){return e.indexOf(i,f)>=0})})};e.zip=function(){for(var a=j.call(arguments),
c=e.max(e.pluck(a,"length")),f=Array(c),i=0;i<c;i++)f[i]=e.pluck(a,""+i);return f};e.indexOf=function(a,c,f){if(a==null)return-1;var i;if(f){f=e.sortedIndex(a,c);return a[f]===c?f:-1}if(x&&a.indexOf===x)return a.indexOf(c);f=0;for(i=a.length;f<i;f++)if(a[f]===c)return f;return-1};e.lastIndexOf=function(a,c){if(a==null)return-1;if(D&&a.lastIndexOf===D)return a.lastIndexOf(c);for(var f=a.length;f--;)if(a[f]===c)return f;return-1};e.range=function(a,c,f){if(arguments.length<=1){c=a||0;a=0}f=arguments[2]||
1;for(var i=Math.max(Math.ceil((c-a)/f),0),m=0,q=Array(i);m<i;){q[m++]=a;a+=f}return q};e.bind=function(a,c){var f=j.call(arguments,2);return function(){return a.apply(c||{},f.concat(j.call(arguments)))}};e.bindAll=function(a){var c=j.call(arguments,1);if(c.length==0)c=e.functions(a);u(c,function(f){a[f]=e.bind(a[f],a)});return a};e.memoize=function(a,c){var f={};c=c||e.identity;return function(){var i=c.apply(this,arguments);return l.call(f,i)?f[i]:f[i]=a.apply(this,arguments)}};e.delay=function(a,
c){var f=j.call(arguments,2);return setTimeout(function(){return a.apply(a,f)},c)};e.defer=function(a){return e.delay.apply(e,[a,1].concat(j.call(arguments,1)))};var F=function(a,c,f){var i;return function(){var m=this,q=arguments,s=function(){i=null;a.apply(m,q)};f&&clearTimeout(i);if(f||!i)i=setTimeout(s,c)}};e.throttle=function(a,c){return F(a,c,false)};e.debounce=function(a,c){return F(a,c,true)};e.wrap=function(a,c){return function(){var f=[a].concat(j.call(arguments));return c.apply(this,f)}};
e.compose=function(){var a=j.call(arguments);return function(){for(var c=j.call(arguments),f=a.length-1;f>=0;f--)c=[a[f].apply(this,c)];return c[0]}};e.keys=G||function(a){var c=[],f;for(f in a)if(l.call(a,f))c[c.length]=f;return c};e.values=function(a){return e.map(a,e.identity)};e.functions=e.methods=function(a){return e.filter(e.keys(a),function(c){return e.isFunction(a[c])}).sort()};e.extend=function(a){u(j.call(arguments,1),function(c){for(var f in c)a[f]=c[f]});return a};e.clone=function(a){return e.isArray(a)?
a.slice():e.extend({},a)};e.tap=function(a,c){c(a);return a};e.isEqual=function(a,c){if(a===c)return true;var f=typeof a;if(f!=typeof c)return false;if(a==c)return true;if(!a&&c||a&&!c)return false;if(a._chain)a=a._wrapped;if(c._chain)c=c._wrapped;if(a.isEqual)return a.isEqual(c);if(e.isDate(a)&&e.isDate(c))return a.getTime()===c.getTime();if(e.isNaN(a)&&e.isNaN(c))return false;if(e.isRegExp(a)&&e.isRegExp(c))return a.source===c.source&&a.global===c.global&&a.ignoreCase===c.ignoreCase&&a.multiline===
c.multiline;if(f!=="object")return false;if(a.length&&a.length!==c.length)return false;f=e.keys(a);var i=e.keys(c);if(f.length!=i.length)return false;for(var m in a)if(!(m in c)||!e.isEqual(a[m],c[m]))return false;return true};e.isEmpty=function(a){if(e.isArray(a)||e.isString(a))return a.length===0;for(var c in a)if(l.call(a,c))return false;return true};e.isElement=function(a){return!!(a&&a.nodeType==1)};e.isArray=k||function(a){return o.call(a)==="[object Array]"};e.isArguments=function(a){return!!(a&&
l.call(a,"callee"))};e.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)};e.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};e.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)};e.isNaN=function(a){return a!==a};e.isBoolean=function(a){return a===true||a===false};e.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)};e.isRegExp=function(a){return!!(a&&a.test&&a.exec&&(a.ignoreCase||a.ignoreCase===false))};e.isNull=function(a){return a===
null};e.isUndefined=function(a){return a===void 0};e.noConflict=function(){b._=d;return this};e.identity=function(a){return a};e.times=function(a,c,f){for(var i=0;i<a;i++)c.call(f,i)};e.mixin=function(a){u(e.functions(a),function(c){I(c,e[c]=a[c])})};var J=0;e.uniqueId=function(a){var c=J++;return a?a+c:c};e.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g};e.template=function(a,c){var f=e.templateSettings;f="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+
a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(f.interpolate,function(i,m){return"',"+m.replace(/\\'/g,"'")+",'"}).replace(f.evaluate||null,function(i,m){return"');"+m.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');";f=new Function("obj",f);return c?f(c):f};var v=function(a){this._wrapped=a};e.prototype=v.prototype;var y=function(a,c){return c?e(a).chain():a},I=function(a,c){v.prototype[a]=function(){var f=
j.call(arguments);n.call(f,this._wrapped);return y(c.apply(e,f),this._chain)}};e.mixin(e);u(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var c=g[a];v.prototype[a]=function(){c.apply(this._wrapped,arguments);return y(this._wrapped,this._chain)}});u(["concat","join","slice"],function(a){var c=g[a];v.prototype[a]=function(){return y(c.apply(this._wrapped,arguments),this._chain)}});v.prototype.chain=function(){this._chain=true;return this};v.prototype.value=function(){return this._wrapped}})();
var OGE={};OGE.Direction=function(b,d){this.cos=typeof b!="undefined"?b:0;this.sin=typeof d!="undefined"?d:0};OGE.Direction.prototype.rotate=function(b){b=b*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+b);this.sin=Math.sin(Math.asin(this.sin)+b);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(b,d){this.x=typeof b!="undefined"?b:0;this.y=typeof d!="undefined"?d:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(b){for(var d=0;d<this.bodies.length;d++)if(this.bodies[d]===b)return;this.bodies.push(b)};OGE.Zone.prototype.removeBody=function(b){for(var d=0;d<this.bodies.length;d++)if(this.bodies[d]===b){this.bodies.splice(d,1);break}};
OGE.Body=function(b,d,h,g){this.x=typeof b!="undefined"?b:0;this.y=typeof d!="undefined"?d:0;this.width=typeof h!="undefined"?h:1;this.height=typeof g!="undefined"?g:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(b){this.onCollisions.push(b)};
OGE.Body.prototype.collide=function(b){for(var d=true,h=0;h<this.onCollisions.length;h++)if(this.onCollisions[h](b)===false)d=false;return d};OGE.Body.prototype.collide=function(b){for(var d=true,h=0;h<this.onCollisions.length;h++)if(this.onCollisions[h](b)===false)d=false;return d};OGE.Body.prototype.intersects=function(b,d,h,g){var k;k=b;if(arguments.length===1){k=b.x;d=b.y;h=b.width;g=b.height}return this.x<k+h&&this.x+this.width>k&&this.y<d+g&&this.y+this.height>d};
OGE.Body.prototype.intersection=function(b,d,h,g){var k;k=b;if(arguments.length===1){k=b.x;d=b.y;h=b.width;g=b.height}return((this.x+this.width<k+h?this.x+this.width:k+h)-(this.x>k?this.x:k))*((this.y+this.height<d+g?this.y+this.width:d+g)-(this.y>d?this.y:d))};
OGE.World=function(b,d,h){this.width=typeof b!="undefined"?b:640;this.height=typeof d!="undefined"?d:480;this.zoneSize=typeof h!="undefined"?h:10;this.activeBodies=[];b=b/this.zoneSize+1<<0;d=d/this.zoneSize+1<<0;this.zones=[];for(h=0;h<b;h++){this.zones[h]=[];for(var g=0;g<d;g++)this.zones[h][g]=new OGE.Zone(h,g)}};OGE.World.prototype.addBody=function(b,d){if(this.addBodyToZones(b)!==true)return false;if(arguments.length>=2)b.active=d;b.active&&this.activeBodies.push(b);return true};
OGE.World.prototype.removeBody=function(b){this.removeBodyFromZones(b);for(var d=0;d<this.activeBodies.length;d++)if(this.activeBodies[d]===b){this.activeBodies.splice(d,1);break}};
OGE.World.prototype.getBodies=function(b,d,h,g){var k,j;k=j=b;if(arguments.length===1){j=k.x;d=k.y;h=k.width;g=k.height}j=j<0?0:j;j=j+h>this.width?this.width-h:j;d=d<0?0:d;d=d+g>this.height?this.height-g:d;k=[];j=this.getZones(j,d,h,g);for(var n=0;n<j.length;n++)for(var o=j[n].bodies,l=0;l<o.length;l++){for(var r=o[l],t=false,w=0;w<k.length;w++)if(k[w]===r){t=true;break}t||k.push(r)}return k};
OGE.World.prototype.getZones=function(b,d,h,g){var k,j;k=j=b;if(arguments.length===1){j=k.x;d=k.y;h=k.width;g=k.height}if(j>=0&&j+h-1<this.width&&d>=0&&d+g-1<this.height){k=(j+h)/this.zoneSize<<0;var n=d/this.zoneSize<<0,o=(d+g)/this.zoneSize<<0,l=0,r=[];for(j=j/this.zoneSize<<0;j<=k;j++)for(d=n;d<=o;d++)r[l++]=this.zones[j][d];return r}else return[]};
OGE.World.prototype.step=function(b){b=arguments.length===0?1:b;for(var d=0;d<b;d++)for(var h=0;h<this.activeBodies.length;h++){var g=this.activeBodies[h];g.speed>0&&g.direction!==null&&this.moveBody(g)}};OGE.World.prototype.addBodyToZones=function(b){var d=this.getZones(b);if(d.length===0)return false;for(var h=0;h<d.length;h++)d[h].addBody(b);return true};OGE.World.prototype.removeBodyFromZones=function(b){for(var d=this.getZones(b),h=0;h<d.length;h++)d[h].removeBody(b)};
OGE.World.prototype.moveBody=function(b,d,h){var g,k,j;if(arguments.length===1){d=b.direction;h=b.speed}for(var n=0;n<h;n++){g=b.x;k=b.y;this.removeBodyFromZones(b);b.x+=d.cos;b.y+=d.sin;j=this.getBodies(b);for(var o=0;o<j.length;o++){var l=j[o];if(b!==l&&!l.intersects(g,k,b.width,b.height)&&l.intersects(b)){var r=b.collide(l)===true;l=l.collide(b)===true;if(r&&l){b.x=g;b.y=k;this.addBodyToZones(b);if(b.slide&&o>=0)this.slideBody(b,d);else return}}}this.addBodyToZones(b)}};
OGE.World.prototype.slideBody=function(b,d){var h=this,g=function(j){var n=0,o=b.x+j.cos*1.9<<0;if(o!==b.x)o=b.x+(o>b.x?1:-1);j=b.y+j.sin*1.9<<0;if(j!==b.y)j=b.y+(j>b.y?1:-1);for(var l=h.getBodies(o,j,b.width,b.height),r=0;r<l.length;r++){var t=l[r];if(t!==b&&t.intersects(o,j,b.width,b.height))n+=t.intersection(o,j,b.width,b.height)}return n<<0},k=g(d.clone().rotate(-45));g=g(d.clone().rotate(45));if(k<g)this.moveBody(b,d.clone().rotate(-90),1);else k>g&&this.moveBody(b,d.clone().rotate(90),1)};
Object.construct_prototype=function(b){var d=function(){};d.prototype=b.prototype;return new d};Player=function(b,d,h,g,k){this.nick=k;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};
Player.deserialize=function(b){return _.extend(new Player(b.x,b.y,b.width,b.height,b.nick),b)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=10;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);
Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(b,d){this.world=new OGE.World(b,d,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};
Game.prototype.addBody=function(b,d){if(!this.world.addBody(b,d))return false;if(b instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=b;this.players.push(b)}else b instanceof Bomb&&this.bombs.push(b);return true};
Game.prototype.serialize=function(){var b=this,d={width:this.world.width,height:this.world.height},h=function(g,k){if(b[g].length>0){var j=b[g][0].width;d[g]={};d[g].size=j;d[g].pos=[];d[g].attrs={};_.each(b[g],function(n){d[g].pos.push(n.y/j*Math.floor(b.world.width/j)+n.x/j);_.each(k,function(o){d[g].attrs[o]=n[o]})})}};if(this.players.length>0){d.players=[];_.each(this.players,function(g){d.players.push(g.serialize())})}h("blocks",["armor"]);h("bricks");return d};
Game.prototype.removeBody=function(b){this.world.removeBody(b);this.players=_.without(this.players,b);this.bombs=_.without(this.bombs,b);this.blocks=_.without(this.blocks,b);this.bricks=_.without(this.bricks,b)};Game.prototype.getPlayer=function(b){for(var d=0;d<this.players.length;d++)if(this.players[d].nick===b)return this.players[d]};
Game.prototype.createBlocks=function(b){for(var d=1;d<this.world.height/b-2;d+=2)for(var h=1;h<this.world.width/b-2;h+=2){var g=new Box(h*b,d*b,b,b);g.armor=1;this.blocks.push(g);this.addBody(g)}return this};Game.prototype.createBricks=function(b,d){for(var h=this.world.width/b,g=this.world.height/b,k=0;k<g-1;k++)for(var j=0;j<h-1;j++)if(Math.random()*100<d&&!(j%2===1&&k%2===1))if((j>1||k>1)&&(j>1||k<g-2)&&(j<h-2||k>1)&&(j<h-2||k<g-2)){var n=new Box(j*b,k*b,b,b);this.bricks.push(n);this.addBody(n)}return this};
Game.deserialize=function(b){var d=new Game(b.width,b.height),h=function(g){if(b[g].pos.length>0){var k=b[g].size,j=Math.floor(b.width/k);_.each(b[g].pos,function(n){var o=new Box(n%j*k,Math.floor(n/j)*k,k,k);_.each(b[g].attrs,function(l,r){o[r]=b[g].attrs[r]});d[g].push(o);d.addBody(o)})}};h("blocks");h("bricks");b.players&&b.players.length>0&&_.each(b.players,function(g){d.addBody(Player.deserialize(g),true)});return d};var $infoArea,client,utils={};
utils.log=function(b){if(b.cmd&&b.result){typeof console!=="undefined"&&console!==null&&console.log(b.cmd,b);b=b.cmd+" - "+b.result}else typeof console!=="undefined"&&console!==null&&console.log(b);$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+b);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};$(function(){$infoArea=$("#infoArea");LobbyHandler()});
LobbyHandler=function(){var b=new LobbyClient(this);new LobbyPanel(this);var d=new GameClient;new GameHandler(d);var h;d.addListener("authPlayer",function(g,k){console.log("auth: "+g,k)});this.createGame=function(g){b.createGame(function(k){if(k.result==="OK"){Game.deserialize(k.data);g(true)}else g(fale)})};this.playNow=function(g){b.playNow(function(k){if(k.result==="OK"){Game.deserialize(k.data);g(true)}else g(false)})};this.login=function(g,k){b.login(g,function(j){if(j.result==="OK"){h=j.data;
d.send("authPlayer",{guid:h.guid});k(true)}else k(false)})}};LobbyClient=function(){var b;this.createGame=function(d){$.getJSON("/lobby?cmd=createGame&guid="+b.guid,function(h){utils.log(h);d(h)})};this.playNow=function(){$.getJSON("/lobby?cmd=joinGame&guid="+b.guid,function(d){utils.log(d)})};this.login=function(d,h){$.getJSON("/lobby?cmd=loginPlayer&nick="+d,function(g){utils.log(g);if(g.result==="OK")b=g.data;h(g)})}};
LobbyPanel=function(b){var d=$("#loginPanel"),h=$("#loginButton"),g=$("#lobbyPanel"),k=$("#nickField"),j=$("#playNowButton"),n=$("#createGameButton"),o=function(){b.createGame(function(t){t&&g.hide()})},l=function(){b.playNow(function(){g.hide()})},r=function(){k.val().length>0&&b.login(k.val(),function(t){if(t){d.hide();g.show()}else d.children("span").text("Nick taken!")})};(function(){k.keypress(function(t){t.keyCode===13&&r()});h.click(function(){r()});j.click(function(){l()});n.click(function(){o()});
k.focus()})()};
GameHandler=function(b){new GamePanel(this);b.addListener("joinGame",function(){p=Player.deserialize(msg.data.player);game.addBody(p,true);addPlayer(p)});b.addListener("startMove",function(){p=game.getPlayer(msg.data.player);p.direction=new OGE.Direction(msg.data.cos,msg.data.sin);p.x=msg.data.x;p.y=msg.data.y});b.addListener("endMove",function(){p=game.getPlayer(msg.data.player);p.direction=null;p.x=msg.data.x;p.y=msg.data.y});b.addListener("logoutPlayer",function(){p=game.getPlayer(msg.data.player);p.$img.remove();
game.removeBody(p)});b.addListener("placeBomb",function(){var d=new Bomb(msg.data.x,msg.data.y,16,16);placeBomb(d)})};GameClient=function(){var b=new io.Socket,d={};this.addListener=function(h,g){if(typeof d[h]==="undefined")d[h]=[];d[h].push(g)};this.send=function(h,g){b.send({cmd:h,data:g})};b.connect();b.on("message",function(h){_.each(d[h.cmd],function(g){g(h.result,h.data)})})};
GamePanel=function(b){var d=$("#gamePanel"),h=$("#fpsLabel"),g,k;this.init=function(){g=new KeyboardHandler;k=new k;d.find("*").remove();d.show();d.width(game.world.width).height(game.world.height);$.each(game.blocks,function(n,o){j(o,"block")});$.each(game.bricks,function(n,o){j(o,"brick")});$.each(game.players,function(n,o){j(o,"pl1");o.animate=0;o.sprite=0;o.sprites=[1,2,1,3]});g.keydown(function(n){switch(n){case "space":n=b.placeBomb();n.animate=0;n.sprite=0;n.sprites=[1,2,3];game.addBody(n);
j(n,"bomb1");break;case "left":cos=-1;break;case "up":sin=-1;break;case "right":cos=1;break;case "down":sin=1}if(cos!==0||sin!==0)b.startMove(cos,sin)}).keyup(function(){b.endMove()});k.start(function(n){b.step();if(++frame===20){h.text("Time: "+n);frame=0}$.each(game.players,function(o,l){l.$img.css("left",l.x).css("top",l.y-4);if(l.direction!==null&&l.speed>0){if(l.lastDirection!==l.direction){l.animate=0;l.lastDirection=l.direction}if(--l.animate<0){l.animate=5;if(++l.sprite>=l.sprites.length)l.sprite=
0;var r;if(l.direction.cos!==0)r=l.direction.cos>0?"r":"l";else if(l.direction.sin!==0)r=l.direction.sin>0?"d":"u";l.$img.attr("src","/images/p"+r+l.sprites[l.sprite]+".png")}}});$.each(game.bombs,function(o,l){if(--l.animate<0){l.animate=5;if(++l.sprite>=l.sprites.length)l.sprite=0;l.$img.attr("src","/images/bomb"+l.sprites[l.sprite]+".png")}})})};var j=function(n,o){var l=$("<img>").attr("src","images/"+o+".png").css("left",n.x).css("top",n.y).addClass("body");d.append(l);n.$img=l}};
KeyboardHandler=function(){var b,d,h;this.keydown=function(){d=fn;return this};this.keyup=function(){h=fn;return this};$(document).keydown(function(g){var k=false,j=null;switch(g.keyCode){case 32:j="space";break;case 37:case 65:j="left";break;case 38:case 87:j="up";break;case 39:case 68:j="right";break;case 40:case 83:j="down"}if(j!==null&&b!==g.keyCode){b=g.keyCode;k=true;d(j)}if(k){g.stopPropagation();g.preventDefault();return false}}).keyup(function(g){if(g.keyCode===b){b=0;h()}}).keypress(function(g){switch(g.keyCode){case 32:case 37:case 38:case 39:case 40:g.stopPropagation();
g.preventDefault();return false}})};FactorialTimer=function(){var b=(new Date).getTime(),d=0,h=50,g;this.start=function(j){g=j;k()};var k=function(){d=b=Math.floor(((new Date).getTime()-b)*0.9+d*0.1);if(b>50&&h>45)h--;else b<50&&h<55&&h++;g(b);b=(new Date).getTime();setTimeout(k,h)}};
