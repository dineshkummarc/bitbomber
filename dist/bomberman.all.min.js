(function(){var c=this,f=c._,i={},h=Array.prototype,k=Object.prototype,j=h.slice,o=h.unshift,n=k.toString,p=k.hasOwnProperty,r=h.forEach,t=h.map,v=h.reduce,y=h.reduceRight,z=h.filter,A=h.every,B=h.some,w=h.indexOf,C=h.lastIndexOf;k=Array.isArray;var F=Object.keys,d=function(a){return new u(a)};if(typeof module!=="undefined"&&module.exports){module.exports=d;d._=d}else c._=d;d.VERSION="1.1.4";var s=d.each=d.forEach=function(a,b,e){if(a!=null)if(r&&a.forEach===r)a.forEach(b,e);else if(d.isNumber(a.length))for(var g=
0,l=a.length;g<l;g++){if(b.call(e,a[g],g,a)===i)break}else for(g in a)if(p.call(a,g))if(b.call(e,a[g],g,a)===i)break};d.map=function(a,b,e){var g=[];if(a==null)return g;if(t&&a.map===t)return a.map(b,e);s(a,function(l,m,q){g[g.length]=b.call(e,l,m,q)});return g};d.reduce=d.foldl=d.inject=function(a,b,e,g){var l=e!==void 0;if(a==null)a=[];if(v&&a.reduce===v){if(g)b=d.bind(b,g);return l?a.reduce(b,e):a.reduce(b)}s(a,function(m,q,G){if(!l&&q===0){e=m;l=true}else e=b.call(g,e,m,q,G)});if(!l)throw new TypeError("Reduce of empty array with no initial value");
return e};d.reduceRight=d.foldr=function(a,b,e,g){if(a==null)a=[];if(y&&a.reduceRight===y){if(g)b=d.bind(b,g);return e!==void 0?a.reduceRight(b,e):a.reduceRight(b)}a=(d.isArray(a)?a.slice():d.toArray(a)).reverse();return d.reduce(a,b,e,g)};d.find=d.detect=function(a,b,e){var g;D(a,function(l,m,q){if(b.call(e,l,m,q)){g=l;return true}});return g};d.filter=d.select=function(a,b,e){var g=[];if(a==null)return g;if(z&&a.filter===z)return a.filter(b,e);s(a,function(l,m,q){if(b.call(e,l,m,q))g[g.length]=
l});return g};d.reject=function(a,b,e){var g=[];if(a==null)return g;s(a,function(l,m,q){b.call(e,l,m,q)||(g[g.length]=l)});return g};d.every=d.all=function(a,b,e){b=b||d.identity;var g=true;if(a==null)return g;if(A&&a.every===A)return a.every(b,e);s(a,function(l,m,q){if(!(g=g&&b.call(e,l,m,q)))return i});return g};var D=d.some=d.any=function(a,b,e){b=b||d.identity;var g=false;if(a==null)return g;if(B&&a.some===B)return a.some(b,e);s(a,function(l,m,q){if(g=b.call(e,l,m,q))return i});return g};d.include=
d.contains=function(a,b){var e=false;if(a==null)return e;if(w&&a.indexOf===w)return a.indexOf(b)!=-1;D(a,function(g){if(e=g===b)return true});return e};d.invoke=function(a,b){var e=j.call(arguments,2);return d.map(a,function(g){return(b?g[b]:g).apply(g,e)})};d.pluck=function(a,b){return d.map(a,function(e){return e[b]})};d.max=function(a,b,e){if(!b&&d.isArray(a))return Math.max.apply(Math,a);var g={computed:-Infinity};s(a,function(l,m,q){m=b?b.call(e,l,m,q):l;m>=g.computed&&(g={value:l,computed:m})});
return g.value};d.min=function(a,b,e){if(!b&&d.isArray(a))return Math.min.apply(Math,a);var g={computed:Infinity};s(a,function(l,m,q){m=b?b.call(e,l,m,q):l;m<g.computed&&(g={value:l,computed:m})});return g.value};d.sortBy=function(a,b,e){return d.pluck(d.map(a,function(g,l,m){return{value:g,criteria:b.call(e,g,l,m)}}).sort(function(g,l){var m=g.criteria,q=l.criteria;return m<q?-1:m>q?1:0}),"value")};d.sortedIndex=function(a,b,e){e=e||d.identity;for(var g=0,l=a.length;g<l;){var m=g+l>>1;e(a[m])<e(b)?
g=m+1:l=m}return g};d.toArray=function(a){if(!a)return[];if(a.toArray)return a.toArray();if(d.isArray(a))return a;if(d.isArguments(a))return j.call(a);return d.values(a)};d.size=function(a){return d.toArray(a).length};d.first=d.head=function(a,b,e){return b&&!e?j.call(a,0,b):a[0]};d.rest=d.tail=function(a,b,e){return j.call(a,d.isUndefined(b)||e?1:b)};d.last=function(a){return a[a.length-1]};d.compact=function(a){return d.filter(a,function(b){return!!b})};d.flatten=function(a){return d.reduce(a,function(b,
e){if(d.isArray(e))return b.concat(d.flatten(e));b[b.length]=e;return b},[])};d.without=function(a){var b=j.call(arguments,1);return d.filter(a,function(e){return!d.include(b,e)})};d.uniq=d.unique=function(a,b){return d.reduce(a,function(e,g,l){if(0==l||(b===true?d.last(e)!=g:!d.include(e,g)))e[e.length]=g;return e},[])};d.intersect=function(a){var b=j.call(arguments,1);return d.filter(d.uniq(a),function(e){return d.every(b,function(g){return d.indexOf(g,e)>=0})})};d.zip=function(){for(var a=j.call(arguments),
b=d.max(d.pluck(a,"length")),e=Array(b),g=0;g<b;g++)e[g]=d.pluck(a,""+g);return e};d.indexOf=function(a,b,e){if(a==null)return-1;var g;if(e){e=d.sortedIndex(a,b);return a[e]===b?e:-1}if(w&&a.indexOf===w)return a.indexOf(b);e=0;for(g=a.length;e<g;e++)if(a[e]===b)return e;return-1};d.lastIndexOf=function(a,b){if(a==null)return-1;if(C&&a.lastIndexOf===C)return a.lastIndexOf(b);for(var e=a.length;e--;)if(a[e]===b)return e;return-1};d.range=function(a,b,e){if(arguments.length<=1){b=a||0;a=0}e=arguments[2]||
1;for(var g=Math.max(Math.ceil((b-a)/e),0),l=0,m=Array(g);l<g;){m[l++]=a;a+=e}return m};d.bind=function(a,b){var e=j.call(arguments,2);return function(){return a.apply(b||{},e.concat(j.call(arguments)))}};d.bindAll=function(a){var b=j.call(arguments,1);if(b.length==0)b=d.functions(a);s(b,function(e){a[e]=d.bind(a[e],a)});return a};d.memoize=function(a,b){var e={};b=b||d.identity;return function(){var g=b.apply(this,arguments);return p.call(e,g)?e[g]:e[g]=a.apply(this,arguments)}};d.delay=function(a,
b){var e=j.call(arguments,2);return setTimeout(function(){return a.apply(a,e)},b)};d.defer=function(a){return d.delay.apply(d,[a,1].concat(j.call(arguments,1)))};var E=function(a,b,e){var g;return function(){var l=this,m=arguments,q=function(){g=null;a.apply(l,m)};e&&clearTimeout(g);if(e||!g)g=setTimeout(q,b)}};d.throttle=function(a,b){return E(a,b,false)};d.debounce=function(a,b){return E(a,b,true)};d.wrap=function(a,b){return function(){var e=[a].concat(j.call(arguments));return b.apply(this,e)}};
d.compose=function(){var a=j.call(arguments);return function(){for(var b=j.call(arguments),e=a.length-1;e>=0;e--)b=[a[e].apply(this,b)];return b[0]}};d.keys=F||function(a){var b=[],e;for(e in a)if(p.call(a,e))b[b.length]=e;return b};d.values=function(a){return d.map(a,d.identity)};d.functions=d.methods=function(a){return d.filter(d.keys(a),function(b){return d.isFunction(a[b])}).sort()};d.extend=function(a){s(j.call(arguments,1),function(b){for(var e in b)a[e]=b[e]});return a};d.clone=function(a){return d.isArray(a)?
a.slice():d.extend({},a)};d.tap=function(a,b){b(a);return a};d.isEqual=function(a,b){if(a===b)return true;var e=typeof a;if(e!=typeof b)return false;if(a==b)return true;if(!a&&b||a&&!b)return false;if(a._chain)a=a._wrapped;if(b._chain)b=b._wrapped;if(a.isEqual)return a.isEqual(b);if(d.isDate(a)&&d.isDate(b))return a.getTime()===b.getTime();if(d.isNaN(a)&&d.isNaN(b))return false;if(d.isRegExp(a)&&d.isRegExp(b))return a.source===b.source&&a.global===b.global&&a.ignoreCase===b.ignoreCase&&a.multiline===
b.multiline;if(e!=="object")return false;if(a.length&&a.length!==b.length)return false;e=d.keys(a);var g=d.keys(b);if(e.length!=g.length)return false;for(var l in a)if(!(l in b)||!d.isEqual(a[l],b[l]))return false;return true};d.isEmpty=function(a){if(d.isArray(a)||d.isString(a))return a.length===0;for(var b in a)if(p.call(a,b))return false;return true};d.isElement=function(a){return!!(a&&a.nodeType==1)};d.isArray=k||function(a){return n.call(a)==="[object Array]"};d.isArguments=function(a){return!!(a&&
p.call(a,"callee"))};d.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)};d.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};d.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)};d.isNaN=function(a){return a!==a};d.isBoolean=function(a){return a===true||a===false};d.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)};d.isRegExp=function(a){return!!(a&&a.test&&a.exec&&(a.ignoreCase||a.ignoreCase===false))};d.isNull=function(a){return a===
null};d.isUndefined=function(a){return a===void 0};d.noConflict=function(){c._=f;return this};d.identity=function(a){return a};d.times=function(a,b,e){for(var g=0;g<a;g++)b.call(e,g)};d.mixin=function(a){s(d.functions(a),function(b){H(b,d[b]=a[b])})};var I=0;d.uniqueId=function(a){var b=I++;return a?a+b:b};d.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g};d.template=function(a,b){var e=d.templateSettings;e="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+
a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(e.interpolate,function(g,l){return"',"+l.replace(/\\'/g,"'")+",'"}).replace(e.evaluate||null,function(g,l){return"');"+l.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');";e=new Function("obj",e);return b?e(b):e};var u=function(a){this._wrapped=a};d.prototype=u.prototype;var x=function(a,b){return b?d(a).chain():a},H=function(a,b){u.prototype[a]=function(){var e=
j.call(arguments);o.call(e,this._wrapped);return x(b.apply(d,e),this._chain)}};d.mixin(d);s(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=h[a];u.prototype[a]=function(){b.apply(this._wrapped,arguments);return x(this._wrapped,this._chain)}});s(["concat","join","slice"],function(a){var b=h[a];u.prototype[a]=function(){return x(b.apply(this._wrapped,arguments),this._chain)}});u.prototype.chain=function(){this._chain=true;return this};u.prototype.value=function(){return this._wrapped}})();
var OGE={};OGE.Direction=function(c,f){this.cos=typeof c!="undefined"?c:0;this.sin=typeof f!="undefined"?f:0};OGE.Direction.prototype.rotate=function(c){c=c*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+c);this.sin=Math.sin(Math.asin(this.sin)+c);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(c,f){this.x=typeof c!="undefined"?c:0;this.y=typeof f!="undefined"?f:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(c){for(var f=0;f<this.bodies.length;f++)if(this.bodies[f]===c)return;this.bodies.push(c)};OGE.Zone.prototype.removeBody=function(c){for(var f=0;f<this.bodies.length;f++)if(this.bodies[f]===c){this.bodies.splice(f,1);break}};
OGE.Body=function(c,f,i,h){this.x=typeof c!="undefined"?c:0;this.y=typeof f!="undefined"?f:0;this.width=typeof i!="undefined"?i:1;this.height=typeof h!="undefined"?h:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(c){this.onCollisions.push(c)};
OGE.Body.prototype.collide=function(c){for(var f=true,i=0;i<this.onCollisions.length;i++)if(this.onCollisions[i](c)===false)f=false;return f};OGE.Body.prototype.collide=function(c){for(var f=true,i=0;i<this.onCollisions.length;i++)if(this.onCollisions[i](c)===false)f=false;return f};OGE.Body.prototype.intersects=function(c,f,i,h){var k;k=c;if(arguments.length===1){k=c.x;f=c.y;i=c.width;h=c.height}return this.x<k+i&&this.x+this.width>k&&this.y<f+h&&this.y+this.height>f};
OGE.Body.prototype.intersection=function(c,f,i,h){var k;k=c;if(arguments.length===1){k=c.x;f=c.y;i=c.width;h=c.height}return((this.x+this.width<k+i?this.x+this.width:k+i)-(this.x>k?this.x:k))*((this.y+this.height<f+h?this.y+this.width:f+h)-(this.y>f?this.y:f))};
OGE.World=function(c,f,i){this.width=typeof c!="undefined"?c:640;this.height=typeof f!="undefined"?f:480;this.zoneSize=typeof i!="undefined"?i:10;this.activeBodies=[];c=c/this.zoneSize+1<<0;f=f/this.zoneSize+1<<0;this.zones=[];for(i=0;i<c;i++){this.zones[i]=[];for(var h=0;h<f;h++)this.zones[i][h]=new OGE.Zone(i,h)}};OGE.World.prototype.addBody=function(c,f){if(this.addBodyToZones(c)!==true)return false;if(arguments.length>=2)c.active=f;c.active&&this.activeBodies.push(c);return true};
OGE.World.prototype.removeBody=function(c){this.removeBodyFromZones(c);for(var f=0;f<this.activeBodies.length;f++)if(this.activeBodies[f]===c){this.activeBodies.splice(f,1);break}};
OGE.World.prototype.getBodies=function(c,f,i,h){var k,j;k=j=c;if(arguments.length===1){j=k.x;f=k.y;i=k.width;h=k.height}j=j<0?0:j;j=j+i>this.width?this.width-i:j;f=f<0?0:f;f=f+h>this.height?this.height-h:f;k=[];j=this.getZones(j,f,i,h);for(var o=0;o<j.length;o++)for(var n=j[o].bodies,p=0;p<n.length;p++){for(var r=n[p],t=false,v=0;v<k.length;v++)if(k[v]===r){t=true;break}t||k.push(r)}return k};
OGE.World.prototype.getZones=function(c,f,i,h){var k,j;k=j=c;if(arguments.length===1){j=k.x;f=k.y;i=k.width;h=k.height}if(j>=0&&j+i-1<this.width&&f>=0&&f+h-1<this.height){k=(j+i)/this.zoneSize<<0;var o=f/this.zoneSize<<0,n=(f+h)/this.zoneSize<<0,p=0,r=[];for(j=j/this.zoneSize<<0;j<=k;j++)for(f=o;f<=n;f++)r[p++]=this.zones[j][f];return r}else return[]};
OGE.World.prototype.step=function(c){c=arguments.length===0?1:c;for(var f=0;f<c;f++)for(var i=0;i<this.activeBodies.length;i++){var h=this.activeBodies[i];h.speed>0&&h.direction!==null&&this.moveBody(h)}};OGE.World.prototype.addBodyToZones=function(c){var f=this.getZones(c);if(f.length===0)return false;for(var i=0;i<f.length;i++)f[i].addBody(c);return true};OGE.World.prototype.removeBodyFromZones=function(c){for(var f=this.getZones(c),i=0;i<f.length;i++)f[i].removeBody(c)};
OGE.World.prototype.moveBody=function(c,f,i){var h,k,j;if(arguments.length===1){f=c.direction;i=c.speed}for(var o=0;o<i;o++){h=c.x;k=c.y;this.removeBodyFromZones(c);c.x+=f.cos;c.y+=f.sin;j=this.getBodies(c);for(var n=0;n<j.length;n++){var p=j[n];if(c!==p&&!p.intersects(h,k,c.width,c.height)&&p.intersects(c)){var r=c.collide(p)===true;p=p.collide(c)===true;if(r&&p){c.x=h;c.y=k;this.addBodyToZones(c);if(c.slide&&n>=0)this.slideBody(c,f);else return}}}this.addBodyToZones(c)}};
OGE.World.prototype.slideBody=function(c,f){var i=this,h=function(j){var o=0,n=c.x+j.cos*1.9<<0;if(n!==c.x)n=c.x+(n>c.x?1:-1);j=c.y+j.sin*1.9<<0;if(j!==c.y)j=c.y+(j>c.y?1:-1);for(var p=i.getBodies(n,j,c.width,c.height),r=0;r<p.length;r++){var t=p[r];if(t!==c&&t.intersects(n,j,c.width,c.height))o+=t.intersection(n,j,c.width,c.height)}return o<<0},k=h(f.clone().rotate(-45));h=h(f.clone().rotate(45));if(k<h)this.moveBody(c,f.clone().rotate(-90),1);else k>h&&this.moveBody(c,f.clone().rotate(90),1)};
Object.construct_prototype=function(c){var f=function(){};f.prototype=c.prototype;return new f};Player=function(c,f,i,h,k){this.nick=k;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};
Player.deserialize=function(c){return _.extend(new Player(c.x,c.y,c.width,c.height,c.nick),c)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=10;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);
Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(c,f){this.world=new OGE.World(c,f);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};
Game.prototype.addBody=function(c,f){if(!this.world.addBody(c,f))return false;if(c instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=c;this.players.push(c)}else c instanceof Bomb&&this.bombs.push(bomb);return true};
Game.prototype.serialize=function(){var c=this,f={width:this.world.width,height:this.world.height},i=function(h,k){if(c[h].length>0){var j=c[h][0].width;f[h]={};f[h].size=j;f[h].pos=[];f[h].attrs={};_.each(c[h],function(o){f[h].pos.push(o.y/j*Math.floor(c.world.width/j)+o.x/j);_.each(k,function(n){f[h].attrs[n]=o[n]})})}};if(this.players.length>0){f.players=[];_.each(this.players,function(h){f.players.push(h.serialize())})}i("blocks",["armor"]);i("bricks");return f};
Game.prototype.removeBody=function(c){this.world.removeBody(c);this.players=_.without(this.players,c);this.bombs=_.without(this.bombs,c);this.blocks=_.without(this.blocks,c);this.bricks=_.without(this.bricks,c)};Game.prototype.getPlayer=function(c){for(var f=0;f<this.players.length;f++)if(this.players[f].nick===c)return this.players[f]};
Game.prototype.createBlocks=function(c){for(var f=1;f<this.world.height/c-2;f+=2)for(var i=1;i<this.world.width/c-2;i+=2){var h=new Box(i*c,f*c,c,c);h.armor=1;this.blocks.push(h);this.addBody(h)}return this};Game.prototype.createBricks=function(c,f){for(var i=this.world.width/c,h=this.world.height/c,k=0;k<h-1;k++)for(var j=0;j<i-1;j++)if(Math.random()*100<f&&!(j%2===1&&k%2===1))if((j>1||k>1)&&(j>1||k<h-2)&&(j<i-2||k>1)&&(j<i-2||k<h-2)){var o=new Box(j*c,k*c,c,c);this.bricks.push(o);this.addBody(o)}return this};
Game.deserialize=function(c){var f=new Game(c.width,c.height),i=function(h){if(c[h].pos.length>0){var k=c[h].size,j=Math.floor(c.width/k);_.each(c[h].pos,function(o){var n=new Box(o%j*k,Math.floor(o/j)*k,k,k);_.each(c[h].attrs,function(p,r){n[r]=c[h].attrs[r]});f[h].push(n);f.addBody(n)})}};i("blocks");i("bricks");c.players&&c.players.length>0&&_.each(c.players,function(h){f.addBody(Player.deserialize(h),true)});return f};
