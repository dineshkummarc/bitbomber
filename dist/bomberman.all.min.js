(function(){var b=this,e=b._,i={},h=Array.prototype,k=Object.prototype,j=h.slice,n=h.unshift,p=k.toString,o=k.hasOwnProperty,q=h.forEach,s=h.map,t=h.reduce,u=h.reduceRight,w=h.filter,y=h.every,C=h.some,z=h.indexOf,B=h.lastIndexOf;k=Array.isArray;var x=Object.keys,d=function(a){return new A(a)};if(typeof module!=="undefined"&&module.exports){module.exports=d;d._=d}else b._=d;d.VERSION="1.1.4";var v=d.each=d.forEach=function(a,c,f){if(a!=null)if(q&&a.forEach===q)a.forEach(c,f);else if(d.isNumber(a.length))for(var g=
0,l=a.length;g<l;g++){if(c.call(f,a[g],g,a)===i)break}else for(g in a)if(o.call(a,g))if(c.call(f,a[g],g,a)===i)break};d.map=function(a,c,f){var g=[];if(a==null)return g;if(s&&a.map===s)return a.map(c,f);v(a,function(l,m,r){g[g.length]=c.call(f,l,m,r)});return g};d.reduce=d.foldl=d.inject=function(a,c,f,g){var l=f!==void 0;if(a==null)a=[];if(t&&a.reduce===t){if(g)c=d.bind(c,g);return l?a.reduce(c,f):a.reduce(c)}v(a,function(m,r,G){if(!l&&r===0){f=m;l=true}else f=c.call(g,f,m,r,G)});if(!l)throw new TypeError("Reduce of empty array with no initial value");
return f};d.reduceRight=d.foldr=function(a,c,f,g){if(a==null)a=[];if(u&&a.reduceRight===u){if(g)c=d.bind(c,g);return f!==void 0?a.reduceRight(c,f):a.reduceRight(c)}a=(d.isArray(a)?a.slice():d.toArray(a)).reverse();return d.reduce(a,c,f,g)};d.find=d.detect=function(a,c,f){var g;E(a,function(l,m,r){if(c.call(f,l,m,r)){g=l;return true}});return g};d.filter=d.select=function(a,c,f){var g=[];if(a==null)return g;if(w&&a.filter===w)return a.filter(c,f);v(a,function(l,m,r){if(c.call(f,l,m,r))g[g.length]=
l});return g};d.reject=function(a,c,f){var g=[];if(a==null)return g;v(a,function(l,m,r){c.call(f,l,m,r)||(g[g.length]=l)});return g};d.every=d.all=function(a,c,f){c=c||d.identity;var g=true;if(a==null)return g;if(y&&a.every===y)return a.every(c,f);v(a,function(l,m,r){if(!(g=g&&c.call(f,l,m,r)))return i});return g};var E=d.some=d.any=function(a,c,f){c=c||d.identity;var g=false;if(a==null)return g;if(C&&a.some===C)return a.some(c,f);v(a,function(l,m,r){if(g=c.call(f,l,m,r))return i});return g};d.include=
d.contains=function(a,c){var f=false;if(a==null)return f;if(z&&a.indexOf===z)return a.indexOf(c)!=-1;E(a,function(g){if(f=g===c)return true});return f};d.invoke=function(a,c){var f=j.call(arguments,2);return d.map(a,function(g){return(c?g[c]:g).apply(g,f)})};d.pluck=function(a,c){return d.map(a,function(f){return f[c]})};d.max=function(a,c,f){if(!c&&d.isArray(a))return Math.max.apply(Math,a);var g={computed:-Infinity};v(a,function(l,m,r){m=c?c.call(f,l,m,r):l;m>=g.computed&&(g={value:l,computed:m})});
return g.value};d.min=function(a,c,f){if(!c&&d.isArray(a))return Math.min.apply(Math,a);var g={computed:Infinity};v(a,function(l,m,r){m=c?c.call(f,l,m,r):l;m<g.computed&&(g={value:l,computed:m})});return g.value};d.sortBy=function(a,c,f){return d.pluck(d.map(a,function(g,l,m){return{value:g,criteria:c.call(f,g,l,m)}}).sort(function(g,l){var m=g.criteria,r=l.criteria;return m<r?-1:m>r?1:0}),"value")};d.sortedIndex=function(a,c,f){f=f||d.identity;for(var g=0,l=a.length;g<l;){var m=g+l>>1;f(a[m])<f(c)?
g=m+1:l=m}return g};d.toArray=function(a){if(!a)return[];if(a.toArray)return a.toArray();if(d.isArray(a))return a;if(d.isArguments(a))return j.call(a);return d.values(a)};d.size=function(a){return d.toArray(a).length};d.first=d.head=function(a,c,f){return c!=null&&!f?j.call(a,0,c):a[0]};d.rest=d.tail=function(a,c,f){return j.call(a,c==null||f?1:c)};d.last=function(a){return a[a.length-1]};d.compact=function(a){return d.filter(a,function(c){return!!c})};d.flatten=function(a){return d.reduce(a,function(c,
f){if(d.isArray(f))return c.concat(d.flatten(f));c[c.length]=f;return c},[])};d.without=function(a){var c=j.call(arguments,1);return d.filter(a,function(f){return!d.include(c,f)})};d.uniq=d.unique=function(a,c){return d.reduce(a,function(f,g,l){if(0==l||(c===true?d.last(f)!=g:!d.include(f,g)))f[f.length]=g;return f},[])};d.intersect=function(a){var c=j.call(arguments,1);return d.filter(d.uniq(a),function(f){return d.every(c,function(g){return d.indexOf(g,f)>=0})})};d.zip=function(){for(var a=j.call(arguments),
c=d.max(d.pluck(a,"length")),f=Array(c),g=0;g<c;g++)f[g]=d.pluck(a,""+g);return f};d.indexOf=function(a,c,f){if(a==null)return-1;var g;if(f){f=d.sortedIndex(a,c);return a[f]===c?f:-1}if(z&&a.indexOf===z)return a.indexOf(c);f=0;for(g=a.length;f<g;f++)if(a[f]===c)return f;return-1};d.lastIndexOf=function(a,c){if(a==null)return-1;if(B&&a.lastIndexOf===B)return a.lastIndexOf(c);for(var f=a.length;f--;)if(a[f]===c)return f;return-1};d.range=function(a,c,f){if(arguments.length<=1){c=a||0;a=0}f=arguments[2]||
1;for(var g=Math.max(Math.ceil((c-a)/f),0),l=0,m=Array(g);l<g;){m[l++]=a;a+=f}return m};d.bind=function(a,c){var f=j.call(arguments,2);return function(){return a.apply(c||{},f.concat(j.call(arguments)))}};d.bindAll=function(a){var c=j.call(arguments,1);if(c.length==0)c=d.functions(a);v(c,function(f){a[f]=d.bind(a[f],a)});return a};d.memoize=function(a,c){var f={};c=c||d.identity;return function(){var g=c.apply(this,arguments);return o.call(f,g)?f[g]:f[g]=a.apply(this,arguments)}};d.delay=function(a,
c){var f=j.call(arguments,2);return setTimeout(function(){return a.apply(a,f)},c)};d.defer=function(a){return d.delay.apply(d,[a,1].concat(j.call(arguments,1)))};var F=function(a,c,f){var g;return function(){var l=this,m=arguments,r=function(){g=null;a.apply(l,m)};f&&clearTimeout(g);if(f||!g)g=setTimeout(r,c)}};d.throttle=function(a,c){return F(a,c,false)};d.debounce=function(a,c){return F(a,c,true)};d.wrap=function(a,c){return function(){var f=[a].concat(j.call(arguments));return c.apply(this,f)}};
d.compose=function(){var a=j.call(arguments);return function(){for(var c=j.call(arguments),f=a.length-1;f>=0;f--)c=[a[f].apply(this,c)];return c[0]}};d.keys=x||function(a){var c=[],f;for(f in a)if(o.call(a,f))c[c.length]=f;return c};d.values=function(a){return d.map(a,d.identity)};d.functions=d.methods=function(a){return d.filter(d.keys(a),function(c){return d.isFunction(a[c])}).sort()};d.extend=function(a){v(j.call(arguments,1),function(c){for(var f in c)a[f]=c[f]});return a};d.clone=function(a){return d.isArray(a)?
a.slice():d.extend({},a)};d.tap=function(a,c){c(a);return a};d.isEqual=function(a,c){if(a===c)return true;var f=typeof a;if(f!=typeof c)return false;if(a==c)return true;if(!a&&c||a&&!c)return false;if(a._chain)a=a._wrapped;if(c._chain)c=c._wrapped;if(a.isEqual)return a.isEqual(c);if(d.isDate(a)&&d.isDate(c))return a.getTime()===c.getTime();if(d.isNaN(a)&&d.isNaN(c))return false;if(d.isRegExp(a)&&d.isRegExp(c))return a.source===c.source&&a.global===c.global&&a.ignoreCase===c.ignoreCase&&a.multiline===
c.multiline;if(f!=="object")return false;if(a.length&&a.length!==c.length)return false;f=d.keys(a);var g=d.keys(c);if(f.length!=g.length)return false;for(var l in a)if(!(l in c)||!d.isEqual(a[l],c[l]))return false;return true};d.isEmpty=function(a){if(d.isArray(a)||d.isString(a))return a.length===0;for(var c in a)if(o.call(a,c))return false;return true};d.isElement=function(a){return!!(a&&a.nodeType==1)};d.isArray=k||function(a){return p.call(a)==="[object Array]"};d.isArguments=function(a){return!!(a&&
o.call(a,"callee"))};d.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)};d.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};d.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)};d.isNaN=function(a){return a!==a};d.isBoolean=function(a){return a===true||a===false};d.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)};d.isRegExp=function(a){return!!(a&&a.test&&a.exec&&(a.ignoreCase||a.ignoreCase===false))};d.isNull=function(a){return a===
null};d.isUndefined=function(a){return a===void 0};d.noConflict=function(){b._=e;return this};d.identity=function(a){return a};d.times=function(a,c,f){for(var g=0;g<a;g++)c.call(f,g)};d.mixin=function(a){v(d.functions(a),function(c){H(c,d[c]=a[c])})};var I=0;d.uniqueId=function(a){var c=I++;return a?a+c:c};d.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g};d.template=function(a,c){var f=d.templateSettings;f="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+
a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(f.interpolate,function(g,l){return"',"+l.replace(/\\'/g,"'")+",'"}).replace(f.evaluate||null,function(g,l){return"');"+l.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');";f=new Function("obj",f);return c?f(c):f};var A=function(a){this._wrapped=a};d.prototype=A.prototype;var D=function(a,c){return c?d(a).chain():a},H=function(a,c){A.prototype[a]=function(){var f=
j.call(arguments);n.call(f,this._wrapped);return D(c.apply(d,f),this._chain)}};d.mixin(d);v(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var c=h[a];A.prototype[a]=function(){c.apply(this._wrapped,arguments);return D(this._wrapped,this._chain)}});v(["concat","join","slice"],function(a){var c=h[a];A.prototype[a]=function(){return D(c.apply(this._wrapped,arguments),this._chain)}});A.prototype.chain=function(){this._chain=true;return this};A.prototype.value=function(){return this._wrapped}})();
var OGE={};OGE.Direction=function(b,e){this.cos=typeof b!="undefined"?b:0;this.sin=typeof e!="undefined"?e:0};OGE.Direction.prototype.rotate=function(b){b=b*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+b);this.sin=Math.sin(Math.asin(this.sin)+b);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(b,e){this.x=typeof b!="undefined"?b:0;this.y=typeof e!="undefined"?e:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(b){for(var e=0;e<this.bodies.length;e++)if(this.bodies[e]===b)return;this.bodies.push(b)};OGE.Zone.prototype.removeBody=function(b){for(var e=0;e<this.bodies.length;e++)if(this.bodies[e]===b){this.bodies.splice(e,1);break}};
OGE.Body=function(b,e,i,h){this.x=typeof b!="undefined"?b:0;this.y=typeof e!="undefined"?e:0;this.width=typeof i!="undefined"?i:1;this.height=typeof h!="undefined"?h:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(b){this.onCollisions.push(b)};
OGE.Body.prototype.collide=function(b){for(var e=true,i=0;i<this.onCollisions.length;i++)if(this.onCollisions[i](b)===false)e=false;return e};OGE.Body.prototype.collide=function(b){for(var e=true,i=0;i<this.onCollisions.length;i++)if(this.onCollisions[i](b)===false)e=false;return e};OGE.Body.prototype.intersects=function(b,e,i,h){var k;k=b;if(arguments.length===1){k=b.x;e=b.y;i=b.width;h=b.height}return this.x<k+i&&this.x+this.width>k&&this.y<e+h&&this.y+this.height>e};
OGE.Body.prototype.intersection=function(b,e,i,h){var k;k=b;if(arguments.length===1){k=b.x;e=b.y;i=b.width;h=b.height}return((this.x+this.width<k+i?this.x+this.width:k+i)-(this.x>k?this.x:k))*((this.y+this.height<e+h?this.y+this.width:e+h)-(this.y>e?this.y:e))};
OGE.World=function(b,e,i){this.width=typeof b!="undefined"?b:640;this.height=typeof e!="undefined"?e:480;this.zoneSize=typeof i!="undefined"?i:10;this.activeBodies=[];b=b/this.zoneSize+1<<0;e=e/this.zoneSize+1<<0;this.zones=[];for(i=0;i<b;i++){this.zones[i]=[];for(var h=0;h<e;h++)this.zones[i][h]=new OGE.Zone(i,h)}};OGE.World.prototype.addBody=function(b,e){if(this.addBodyToZones(b)!==true)return false;if(arguments.length>=2)b.active=e;b.active&&this.activeBodies.push(b);return true};
OGE.World.prototype.removeBody=function(b){this.removeBodyFromZones(b);for(var e=0;e<this.activeBodies.length;e++)if(this.activeBodies[e]===b){this.activeBodies.splice(e,1);break}};
OGE.World.prototype.getBodies=function(b,e,i,h){var k,j;k=j=b;if(arguments.length===1){j=k.x;e=k.y;i=k.width;h=k.height}j=j<0?0:j;j=j+i>this.width?this.width-i:j;e=e<0?0:e;e=e+h>this.height?this.height-h:e;k=[];j=this.getZones(j,e,i,h);for(var n=0;n<j.length;n++)for(var p=j[n].bodies,o=0;o<p.length;o++){for(var q=p[o],s=false,t=0;t<k.length;t++)if(k[t]===q){s=true;break}s||k.push(q)}return k};
OGE.World.prototype.getZones=function(b,e,i,h){var k,j;k=j=b;if(arguments.length===1){j=k.x;e=k.y;i=k.width;h=k.height}if(j>=0&&j+i-1<this.width&&e>=0&&e+h-1<this.height){k=(j+i)/this.zoneSize<<0;var n=e/this.zoneSize<<0,p=(e+h)/this.zoneSize<<0,o=0,q=[];for(j=j/this.zoneSize<<0;j<=k;j++)for(e=n;e<=p;e++)q[o++]=this.zones[j][e];return q}else return[]};
OGE.World.prototype.step=function(b){b=arguments.length===0?1:b;for(var e=0;e<b;e++)for(var i=0;i<this.activeBodies.length;i++){var h=this.activeBodies[i];h.speed>0&&h.direction!==null&&this.moveBody(h)}};OGE.World.prototype.addBodyToZones=function(b){var e=this.getZones(b);if(e.length===0)return false;for(var i=0;i<e.length;i++)e[i].addBody(b);return true};OGE.World.prototype.removeBodyFromZones=function(b){for(var e=this.getZones(b),i=0;i<e.length;i++)e[i].removeBody(b)};
OGE.World.prototype.moveBody=function(b,e,i){var h,k,j;if(arguments.length===1){e=b.direction;i=b.speed}for(var n=0;n<i;n++){h=b.x;k=b.y;this.removeBodyFromZones(b);b.x+=e.cos;b.y+=e.sin;j=this.getBodies(b);for(var p=0;p<j.length;p++){var o=j[p];if(b!==o&&!o.intersects(h,k,b.width,b.height)&&o.intersects(b)){var q=b.collide(o)===true;o=o.collide(b)===true;if(q&&o){b.x=h;b.y=k;this.addBodyToZones(b);if(b.slide&&p>=0)this.slideBody(b,e);else return}}}this.addBodyToZones(b)}};
OGE.World.prototype.slideBody=function(b,e){var i=this,h=function(j){var n=[],p=i.getBodies(b),o,q,s,t,u,w;for(q=0;q<p.length;q++){u=p[q];u!==b&&u.intersects(b)&&n.push(u)}o=0;s=b.x+j.cos*1.9<<0;if(s!==b.x)s=b.x+(s>b.x?1:-1);t=b.y+j.sin*1.9<<0;if(t!==b.y)t=b.y+(t>b.y?1:-1);p=i.getBodies(s,t,b.width,b.height);for(q=0;q<p.length;q++){u=p[q];if(u!==b&&u.intersects(s,t,b.width,b.height)){w=false;for(j=0;j<n.length;j++)if(u===n[j]){w=true;break}w||(o+=u.intersection(s,t,b.width,b.height))}}return o<<0},
k=h(e.clone().rotate(-45));h=h(e.clone().rotate(45));if(k<h)this.moveBody(b,e.clone().rotate(-90),1);else k>h&&this.moveBody(b,e.clone().rotate(90),1)};Object.construct_prototype=function(b){var e=function(){};e.prototype=b.prototype;return new e};Player=function(b,e,i,h,k){this.nick=k;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.power=this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);
Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};Player.deserialize=function(b){return _.extend(new Player(b.x,b.y,b.width,b.height,b.nick),b)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=4;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);
Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(b,e){this.world=new OGE.World(b,e,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};
Game.prototype.getBomb=function(b,e){for(var i=0;i<this.bombs.length;i++)if(this.bombs[i].x===b&&this.bombs[i].y===e)return this.bombs[i];return null};Game.prototype.removeBodies=function(b,e){var i=this;_.each(b,function(h){h instanceof e&&i.removeBody(h)})};
Game.prototype.explodeBomb=function(b,e){if(arguments.length===1)e={x:b.x,y:b.y,bodies:[],fires:[]};var i=this,h=function(j,n,p){var o=function(q){return q.x===j&&q.y===n};if(typeof _.detect(e.bodies,o)==="undefined"){p={x:j,y:n,firevar:p};o=_.detect(e.fires,o);if(typeof o!=="undefined"){if(o.firevar!=="c"&&_.contains("c","v","h",p.firevar)){e.fires=_.without(e.fires,o);e.fires.push(p)}}else e.fires.push(p)}};this.removeBody(b);h(b.x,b.y,"c");var k=function(j,n,p,o){j=j*b.width;var q=b.x+j,s=b.x+
b.size*j;n=n*b.height;var t=b.y+n,u=b.y+b.size*n;actualCheck=function(w,y,C){if(w>=0&&y>=0&&w<i.world.width&&y<i.world.height){for(var z=i.world.getBodies(w,y,b.width,b.height),B=0;B<z.length;B++){var x=z[B];if(x!==b&&x.intersects(w+2,y+2,b.width-2,b.height-2)){if(x.armor>b.power)return false;else{!(x instanceof Bomb)&&!_.contains(e.bodies,x)&&e.bodies.push(x);if(x.armor===b.power)return false}x instanceof Bomb&&i.explodeBomb(x,e)}}h(w,y,C)}return true};for(q=q;q!==s+j;q+=j)if(!actualCheck(q,b.y,
q!==s?p:o))break;for(j=t;j!==u+n;j+=n)if(!actualCheck(b.x,j,j!==u?p:o))break};k(-1,0,"h","l");k(1,0,"h","r");k(0,-1,"v","u");k(0,1,"v","d");return e};Game.prototype.addBody=function(b,e){if(!this.world.addBody(b,e))return false;if(b instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=b;this.players.push(b)}else b instanceof Bomb&&this.bombs.push(b);return true};
Game.prototype.serialize=function(){var b=this,e={width:this.world.width,height:this.world.height},i=function(h,k){if(b[h].length>0){var j=b[h][0].width;e[h]={};e[h].size=j;e[h].pos=[];e[h].attrs={};_.each(b[h],function(n){e[h].pos.push(n.y/j*Math.floor(b.world.width/j)+n.x/j);_.each(k,function(p){e[h].attrs[p]=n[p]})})}};if(this.players.length>0){e.players=[];_.each(this.players,function(h){e.players.push(h.serialize())})}i("blocks",["armor"]);i("bricks");return e};
Game.prototype.removeBody=function(b){this.world.removeBody(b);this.players=_.without(this.players,b);this.bombs=_.without(this.bombs,b);this.blocks=_.without(this.blocks,b);this.bricks=_.without(this.bricks,b)};Game.prototype.getPlayer=function(b){for(var e=0;e<this.players.length;e++)if(this.players[e].nick===b)return this.players[e]};
Game.prototype.createBlocks=function(b){for(var e=1;e<this.world.height/b-2;e+=2)for(var i=1;i<this.world.width/b-2;i+=2){var h=new Box(i*b,e*b,b,b);h.armor=2;this.blocks.push(h);this.addBody(h)}return this};Game.prototype.createBricks=function(b,e){for(var i=this.world.width/b,h=this.world.height/b,k=0;k<h-1;k++)for(var j=0;j<i-1;j++)if(Math.random()*100<e&&!(j%2===1&&k%2===1))if((j>1||k>1)&&(j>1||k<h-2)&&(j<i-2||k>1)&&(j<i-2||k<h-2)){var n=new Box(j*b,k*b,b,b);this.bricks.push(n);this.addBody(n)}return this};
Game.deserialize=function(b){var e=new Game(b.width,b.height),i=function(h){if(b[h].pos.length>0){var k=b[h].size,j=Math.floor(b.width/k);_.each(b[h].pos,function(n){var p=new Box(n%j*k,Math.floor(n/j)*k,k,k);_.each(b[h].attrs,function(o,q){p[q]=b[h].attrs[q]});e[h].push(p);e.addBody(p)})}};i("blocks");i("bricks");b.players&&b.players.length>0&&_.each(b.players,function(h){e.addBody(Player.deserialize(h),true)});return e};
