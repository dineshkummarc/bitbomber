(function(){var b=this,c=b._,h={},f=Array.prototype,i=Object.prototype,k=f.slice,q=f.unshift,s=i.toString,n=i.hasOwnProperty,r=f.forEach,l=f.map,v=f.reduce,z=f.reduceRight,A=f.filter,B=f.every,C=f.some,x=f.indexOf,D=f.lastIndexOf;i=Array.isArray;var G=Object.keys,e=function(a){return new w(a)};if(typeof module!=="undefined"&&module.exports){module.exports=e;e._=e}else b._=e;e.VERSION="1.1.4";var u=e.each=e.forEach=function(a,d,g){if(a!=null)if(r&&a.forEach===r)a.forEach(d,g);else if(e.isNumber(a.length))for(var j=
0,m=a.length;j<m;j++){if(d.call(g,a[j],j,a)===h)break}else for(j in a)if(n.call(a,j))if(d.call(g,a[j],j,a)===h)break};e.map=function(a,d,g){var j=[];if(a==null)return j;if(l&&a.map===l)return a.map(d,g);u(a,function(m,o,t){j[j.length]=d.call(g,m,o,t)});return j};e.reduce=e.foldl=e.inject=function(a,d,g,j){var m=g!==void 0;if(a==null)a=[];if(v&&a.reduce===v){if(j)d=e.bind(d,j);return m?a.reduce(d,g):a.reduce(d)}u(a,function(o,t,H){if(!m&&t===0){g=o;m=true}else g=d.call(j,g,o,t,H)});if(!m)throw new TypeError("Reduce of empty array with no initial value");
return g};e.reduceRight=e.foldr=function(a,d,g,j){if(a==null)a=[];if(z&&a.reduceRight===z){if(j)d=e.bind(d,j);return g!==void 0?a.reduceRight(d,g):a.reduceRight(d)}a=(e.isArray(a)?a.slice():e.toArray(a)).reverse();return e.reduce(a,d,g,j)};e.find=e.detect=function(a,d,g){var j;E(a,function(m,o,t){if(d.call(g,m,o,t)){j=m;return true}});return j};e.filter=e.select=function(a,d,g){var j=[];if(a==null)return j;if(A&&a.filter===A)return a.filter(d,g);u(a,function(m,o,t){if(d.call(g,m,o,t))j[j.length]=
m});return j};e.reject=function(a,d,g){var j=[];if(a==null)return j;u(a,function(m,o,t){d.call(g,m,o,t)||(j[j.length]=m)});return j};e.every=e.all=function(a,d,g){d=d||e.identity;var j=true;if(a==null)return j;if(B&&a.every===B)return a.every(d,g);u(a,function(m,o,t){if(!(j=j&&d.call(g,m,o,t)))return h});return j};var E=e.some=e.any=function(a,d,g){d=d||e.identity;var j=false;if(a==null)return j;if(C&&a.some===C)return a.some(d,g);u(a,function(m,o,t){if(j=d.call(g,m,o,t))return h});return j};e.include=
e.contains=function(a,d){var g=false;if(a==null)return g;if(x&&a.indexOf===x)return a.indexOf(d)!=-1;E(a,function(j){if(g=j===d)return true});return g};e.invoke=function(a,d){var g=k.call(arguments,2);return e.map(a,function(j){return(d?j[d]:j).apply(j,g)})};e.pluck=function(a,d){return e.map(a,function(g){return g[d]})};e.max=function(a,d,g){if(!d&&e.isArray(a))return Math.max.apply(Math,a);var j={computed:-Infinity};u(a,function(m,o,t){o=d?d.call(g,m,o,t):m;o>=j.computed&&(j={value:m,computed:o})});
return j.value};e.min=function(a,d,g){if(!d&&e.isArray(a))return Math.min.apply(Math,a);var j={computed:Infinity};u(a,function(m,o,t){o=d?d.call(g,m,o,t):m;o<j.computed&&(j={value:m,computed:o})});return j.value};e.sortBy=function(a,d,g){return e.pluck(e.map(a,function(j,m,o){return{value:j,criteria:d.call(g,j,m,o)}}).sort(function(j,m){var o=j.criteria,t=m.criteria;return o<t?-1:o>t?1:0}),"value")};e.sortedIndex=function(a,d,g){g=g||e.identity;for(var j=0,m=a.length;j<m;){var o=j+m>>1;g(a[o])<g(d)?
j=o+1:m=o}return j};e.toArray=function(a){if(!a)return[];if(a.toArray)return a.toArray();if(e.isArray(a))return a;if(e.isArguments(a))return k.call(a);return e.values(a)};e.size=function(a){return e.toArray(a).length};e.first=e.head=function(a,d,g){return d&&!g?k.call(a,0,d):a[0]};e.rest=e.tail=function(a,d,g){return k.call(a,e.isUndefined(d)||g?1:d)};e.last=function(a){return a[a.length-1]};e.compact=function(a){return e.filter(a,function(d){return!!d})};e.flatten=function(a){return e.reduce(a,function(d,
g){if(e.isArray(g))return d.concat(e.flatten(g));d[d.length]=g;return d},[])};e.without=function(a){var d=k.call(arguments,1);return e.filter(a,function(g){return!e.include(d,g)})};e.uniq=e.unique=function(a,d){return e.reduce(a,function(g,j,m){if(0==m||(d===true?e.last(g)!=j:!e.include(g,j)))g[g.length]=j;return g},[])};e.intersect=function(a){var d=k.call(arguments,1);return e.filter(e.uniq(a),function(g){return e.every(d,function(j){return e.indexOf(j,g)>=0})})};e.zip=function(){for(var a=k.call(arguments),
d=e.max(e.pluck(a,"length")),g=Array(d),j=0;j<d;j++)g[j]=e.pluck(a,""+j);return g};e.indexOf=function(a,d,g){if(a==null)return-1;var j;if(g){g=e.sortedIndex(a,d);return a[g]===d?g:-1}if(x&&a.indexOf===x)return a.indexOf(d);g=0;for(j=a.length;g<j;g++)if(a[g]===d)return g;return-1};e.lastIndexOf=function(a,d){if(a==null)return-1;if(D&&a.lastIndexOf===D)return a.lastIndexOf(d);for(var g=a.length;g--;)if(a[g]===d)return g;return-1};e.range=function(a,d,g){if(arguments.length<=1){d=a||0;a=0}g=arguments[2]||
1;for(var j=Math.max(Math.ceil((d-a)/g),0),m=0,o=Array(j);m<j;){o[m++]=a;a+=g}return o};e.bind=function(a,d){var g=k.call(arguments,2);return function(){return a.apply(d||{},g.concat(k.call(arguments)))}};e.bindAll=function(a){var d=k.call(arguments,1);if(d.length==0)d=e.functions(a);u(d,function(g){a[g]=e.bind(a[g],a)});return a};e.memoize=function(a,d){var g={};d=d||e.identity;return function(){var j=d.apply(this,arguments);return n.call(g,j)?g[j]:g[j]=a.apply(this,arguments)}};e.delay=function(a,
d){var g=k.call(arguments,2);return setTimeout(function(){return a.apply(a,g)},d)};e.defer=function(a){return e.delay.apply(e,[a,1].concat(k.call(arguments,1)))};var F=function(a,d,g){var j;return function(){var m=this,o=arguments,t=function(){j=null;a.apply(m,o)};g&&clearTimeout(j);if(g||!j)j=setTimeout(t,d)}};e.throttle=function(a,d){return F(a,d,false)};e.debounce=function(a,d){return F(a,d,true)};e.wrap=function(a,d){return function(){var g=[a].concat(k.call(arguments));return d.apply(this,g)}};
e.compose=function(){var a=k.call(arguments);return function(){for(var d=k.call(arguments),g=a.length-1;g>=0;g--)d=[a[g].apply(this,d)];return d[0]}};e.keys=G||function(a){var d=[],g;for(g in a)if(n.call(a,g))d[d.length]=g;return d};e.values=function(a){return e.map(a,e.identity)};e.functions=e.methods=function(a){return e.filter(e.keys(a),function(d){return e.isFunction(a[d])}).sort()};e.extend=function(a){u(k.call(arguments,1),function(d){for(var g in d)a[g]=d[g]});return a};e.clone=function(a){return e.isArray(a)?
a.slice():e.extend({},a)};e.tap=function(a,d){d(a);return a};e.isEqual=function(a,d){if(a===d)return true;var g=typeof a;if(g!=typeof d)return false;if(a==d)return true;if(!a&&d||a&&!d)return false;if(a._chain)a=a._wrapped;if(d._chain)d=d._wrapped;if(a.isEqual)return a.isEqual(d);if(e.isDate(a)&&e.isDate(d))return a.getTime()===d.getTime();if(e.isNaN(a)&&e.isNaN(d))return false;if(e.isRegExp(a)&&e.isRegExp(d))return a.source===d.source&&a.global===d.global&&a.ignoreCase===d.ignoreCase&&a.multiline===
d.multiline;if(g!=="object")return false;if(a.length&&a.length!==d.length)return false;g=e.keys(a);var j=e.keys(d);if(g.length!=j.length)return false;for(var m in a)if(!(m in d)||!e.isEqual(a[m],d[m]))return false;return true};e.isEmpty=function(a){if(e.isArray(a)||e.isString(a))return a.length===0;for(var d in a)if(n.call(a,d))return false;return true};e.isElement=function(a){return!!(a&&a.nodeType==1)};e.isArray=i||function(a){return s.call(a)==="[object Array]"};e.isArguments=function(a){return!!(a&&
n.call(a,"callee"))};e.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)};e.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};e.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)};e.isNaN=function(a){return a!==a};e.isBoolean=function(a){return a===true||a===false};e.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)};e.isRegExp=function(a){return!!(a&&a.test&&a.exec&&(a.ignoreCase||a.ignoreCase===false))};e.isNull=function(a){return a===
null};e.isUndefined=function(a){return a===void 0};e.noConflict=function(){b._=c;return this};e.identity=function(a){return a};e.times=function(a,d,g){for(var j=0;j<a;j++)d.call(g,j)};e.mixin=function(a){u(e.functions(a),function(d){I(d,e[d]=a[d])})};var J=0;e.uniqueId=function(a){var d=J++;return a?a+d:d};e.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g};e.template=function(a,d){var g=e.templateSettings;g="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+
a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(g.interpolate,function(j,m){return"',"+m.replace(/\\'/g,"'")+",'"}).replace(g.evaluate||null,function(j,m){return"');"+m.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');";g=new Function("obj",g);return d?g(d):g};var w=function(a){this._wrapped=a};e.prototype=w.prototype;var y=function(a,d){return d?e(a).chain():a},I=function(a,d){w.prototype[a]=function(){var g=
k.call(arguments);q.call(g,this._wrapped);return y(d.apply(e,g),this._chain)}};e.mixin(e);u(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var d=f[a];w.prototype[a]=function(){d.apply(this._wrapped,arguments);return y(this._wrapped,this._chain)}});u(["concat","join","slice"],function(a){var d=f[a];w.prototype[a]=function(){return y(d.apply(this._wrapped,arguments),this._chain)}});w.prototype.chain=function(){this._chain=true;return this};w.prototype.value=function(){return this._wrapped}})();
var OGE={};OGE.Direction=function(b,c){this.cos=typeof b!="undefined"?b:0;this.sin=typeof c!="undefined"?c:0};OGE.Direction.prototype.rotate=function(b){b=b*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+b);this.sin=Math.sin(Math.asin(this.sin)+b);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(b,c){this.x=typeof b!="undefined"?b:0;this.y=typeof c!="undefined"?c:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(b){for(var c=0;c<this.bodies.length;c++)if(this.bodies[c]===b)return;this.bodies.push(b)};OGE.Zone.prototype.removeBody=function(b){for(var c=0;c<this.bodies.length;c++)if(this.bodies[c]===b){this.bodies.splice(c,1);break}};
OGE.Body=function(b,c,h,f){this.x=typeof b!="undefined"?b:0;this.y=typeof c!="undefined"?c:0;this.width=typeof h!="undefined"?h:1;this.height=typeof f!="undefined"?f:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(b){this.onCollisions.push(b)};
OGE.Body.prototype.collide=function(b){for(var c=true,h=0;h<this.onCollisions.length;h++)if(this.onCollisions[h](b)===false)c=false;return c};OGE.Body.prototype.collide=function(b){for(var c=true,h=0;h<this.onCollisions.length;h++)if(this.onCollisions[h](b)===false)c=false;return c};OGE.Body.prototype.intersects=function(b,c,h,f){var i;i=b;if(arguments.length===1){i=b.x;c=b.y;h=b.width;f=b.height}return this.x<i+h&&this.x+this.width>i&&this.y<c+f&&this.y+this.height>c};
OGE.Body.prototype.intersection=function(b,c,h,f){var i;i=b;if(arguments.length===1){i=b.x;c=b.y;h=b.width;f=b.height}return((this.x+this.width<i+h?this.x+this.width:i+h)-(this.x>i?this.x:i))*((this.y+this.height<c+f?this.y+this.width:c+f)-(this.y>c?this.y:c))};
OGE.World=function(b,c,h){this.width=typeof b!="undefined"?b:640;this.height=typeof c!="undefined"?c:480;this.zoneSize=typeof h!="undefined"?h:10;this.activeBodies=[];b=b/this.zoneSize+1<<0;c=c/this.zoneSize+1<<0;this.zones=[];for(h=0;h<b;h++){this.zones[h]=[];for(var f=0;f<c;f++)this.zones[h][f]=new OGE.Zone(h,f)}};OGE.World.prototype.addBody=function(b,c){if(this.addBodyToZones(b)!==true)return false;if(arguments.length>=2)b.active=c;b.active&&this.activeBodies.push(b);return true};
OGE.World.prototype.removeBody=function(b){this.removeBodyFromZones(b);for(var c=0;c<this.activeBodies.length;c++)if(this.activeBodies[c]===b){this.activeBodies.splice(c,1);break}};
OGE.World.prototype.getBodies=function(b,c,h,f){var i,k;i=k=b;if(arguments.length===1){k=i.x;c=i.y;h=i.width;f=i.height}k=k<0?0:k;k=k+h>this.width?this.width-h:k;c=c<0?0:c;c=c+f>this.height?this.height-f:c;i=[];k=this.getZones(k,c,h,f);for(var q=0;q<k.length;q++)for(var s=k[q].bodies,n=0;n<s.length;n++){for(var r=s[n],l=false,v=0;v<i.length;v++)if(i[v]===r){l=true;break}l||i.push(r)}return i};
OGE.World.prototype.getZones=function(b,c,h,f){var i,k;i=k=b;if(arguments.length===1){k=i.x;c=i.y;h=i.width;f=i.height}if(k>=0&&k+h-1<this.width&&c>=0&&c+f-1<this.height){i=(k+h)/this.zoneSize<<0;var q=c/this.zoneSize<<0,s=(c+f)/this.zoneSize<<0,n=0,r=[];for(k=k/this.zoneSize<<0;k<=i;k++)for(c=q;c<=s;c++)r[n++]=this.zones[k][c];return r}else return[]};
OGE.World.prototype.step=function(b){b=arguments.length===0?1:b;for(var c=0;c<b;c++)for(var h=0;h<this.activeBodies.length;h++){var f=this.activeBodies[h];f.speed>0&&f.direction!==null&&this.moveBody(f)}};OGE.World.prototype.addBodyToZones=function(b){var c=this.getZones(b);if(c.length===0)return false;for(var h=0;h<c.length;h++)c[h].addBody(b);return true};OGE.World.prototype.removeBodyFromZones=function(b){for(var c=this.getZones(b),h=0;h<c.length;h++)c[h].removeBody(b)};
OGE.World.prototype.moveBody=function(b,c,h){var f,i,k;if(arguments.length===1){c=b.direction;h=b.speed}for(var q=0;q<h;q++){f=b.x;i=b.y;this.removeBodyFromZones(b);b.x+=c.cos;b.y+=c.sin;k=this.getBodies(b);for(var s=0;s<k.length;s++){var n=k[s];if(b!==n&&!n.intersects(f,i,b.width,b.height)&&n.intersects(b)){var r=b.collide(n)===true;n=n.collide(b)===true;if(r&&n){b.x=f;b.y=i;this.addBodyToZones(b);if(b.slide&&s>=0)this.slideBody(b,c);else return}}}this.addBodyToZones(b)}};
OGE.World.prototype.slideBody=function(b,c){var h=this,f=function(k){var q=0,s=b.x+k.cos*1.9<<0;if(s!==b.x)s=b.x+(s>b.x?1:-1);k=b.y+k.sin*1.9<<0;if(k!==b.y)k=b.y+(k>b.y?1:-1);for(var n=h.getBodies(s,k,b.width,b.height),r=0;r<n.length;r++){var l=n[r];if(l!==b&&l.intersects(s,k,b.width,b.height))q+=l.intersection(s,k,b.width,b.height)}return q<<0},i=f(c.clone().rotate(-45));f=f(c.clone().rotate(45));if(i<f)this.moveBody(b,c.clone().rotate(-90),1);else i>f&&this.moveBody(b,c.clone().rotate(90),1)};
Object.construct_prototype=function(b){var c=function(){};c.prototype=b.prototype;return new c};Player=function(b,c,h,f,i){this.nick=i;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};
Player.deserialize=function(b){return _.extend(new Player(b.x,b.y,b.width,b.height,b.nick),b)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=10;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);
Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(b,c){this.world=new OGE.World(b,c,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};
Game.prototype.addBody=function(b,c){if(!this.world.addBody(b,c))return false;if(b instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=b;this.players.push(b)}else b instanceof Bomb&&this.bombs.push(b);return true};
Game.prototype.serialize=function(){var b=this,c={width:this.world.width,height:this.world.height},h=function(f,i){if(b[f].length>0){var k=b[f][0].width;c[f]={};c[f].size=k;c[f].pos=[];c[f].attrs={};_.each(b[f],function(q){c[f].pos.push(q.y/k*Math.floor(b.world.width/k)+q.x/k);_.each(i,function(s){c[f].attrs[s]=q[s]})})}};if(this.players.length>0){c.players=[];_.each(this.players,function(f){c.players.push(f.serialize())})}h("blocks",["armor"]);h("bricks");return c};
Game.prototype.removeBody=function(b){this.world.removeBody(b);this.players=_.without(this.players,b);this.bombs=_.without(this.bombs,b);this.blocks=_.without(this.blocks,b);this.bricks=_.without(this.bricks,b)};Game.prototype.getPlayer=function(b){for(var c=0;c<this.players.length;c++)if(this.players[c].nick===b)return this.players[c]};
Game.prototype.createBlocks=function(b){for(var c=1;c<this.world.height/b-2;c+=2)for(var h=1;h<this.world.width/b-2;h+=2){var f=new Box(h*b,c*b,b,b);f.armor=1;this.blocks.push(f);this.addBody(f)}return this};Game.prototype.createBricks=function(b,c){for(var h=this.world.width/b,f=this.world.height/b,i=0;i<f-1;i++)for(var k=0;k<h-1;k++)if(Math.random()*100<c&&!(k%2===1&&i%2===1))if((k>1||i>1)&&(k>1||i<f-2)&&(k<h-2||i>1)&&(k<h-2||i<f-2)){var q=new Box(k*b,i*b,b,b);this.bricks.push(q);this.addBody(q)}return this};
Game.deserialize=function(b){var c=new Game(b.width,b.height),h=function(f){if(b[f].pos.length>0){var i=b[f].size,k=Math.floor(b.width/i);_.each(b[f].pos,function(q){var s=new Box(q%k*i,Math.floor(q/k)*i,i,i);_.each(b[f].attrs,function(n,r){s[r]=b[f].attrs[r]});c[f].push(s);c.addBody(s)})}};h("blocks");h("bricks");b.players&&b.players.length>0&&_.each(b.players,function(f){c.addBody(Player.deserialize(f),true)});return c};var $infoArea,utils={};
utils.log=function(b,c){if(arguments.length===1)c=b;c.cmd=c.cmd||b;if(c.cmd&&c.result){typeof console!=="undefined"&&console!==null&&console.log(c.cmd,c);c=c.cmd+" - "+c.result}else typeof console!=="undefined"&&console!==null&&console.log(c);$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+c);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};
var bomberman=function(){new LobbyHandler(this);var b=new GameHandler(this);this.startGame=function(c,h){b.startGame(c,h)};this.login=function(c){b.login(c)}};$(function(){$infoArea=$("#infoArea");bomberman()});
LobbyHandler=function(b){var c=new LobbyClient(this);new LobbyPanel(this);var h;this.createGame=function(f){c.createGame(function(i){if(i.result==="OK"){i=Game.deserialize(i.data);b.startGame(i,h.nick);f(true)}else f(fale)})};this.playNow=function(f){c.playNow(function(i){if(i.result==="OK"){i=Game.deserialize(i.data);b.startGame(i,h.nick);f(true)}else f(false)})};this.login=function(f,i){c.login(f,function(k){if(k.result==="OK"){h=k.data;b.login(h.guid);i(true)}else i(false)})}};
LobbyClient=function(){var b;this.createGame=function(c){$.getJSON("/lobby?cmd=createGame&guid="+b.guid,function(h){utils.log("createGame",h);c(h)})};this.playNow=function(){$.getJSON("/lobby?cmd=joinGame&guid="+b.guid,function(c){utils.log("playNow",c)})};this.login=function(c,h){$.getJSON("/lobby?cmd=loginPlayer&nick="+c,function(f){utils.log("loginPlayer",f);if(f.result==="OK")b=f.data;h(f)})}};
LobbyPanel=function(b){var c=$("#loginPanel"),h=$("#loginButton"),f=$("#lobbyPanel"),i=$("#nickField"),k=$("#playNowButton"),q=$("#createGameButton"),s=function(){b.createGame(function(l){l&&f.hide()})},n=function(){b.playNow(function(){f.hide()})},r=function(){i.val().length>0&&b.login(i.val(),function(l){if(l){c.hide();f.show()}else c.children("span").text("Nick taken!")})};(function(){i.keypress(function(l){l.keyCode===13&&r()});h.click(function(){r()});k.click(function(){n()});q.click(function(){s()});
i.focus()})()};
GameHandler=function(){var b=new GamePanel(this),c=new GameClient,h,f;this.startGame=function(i,k){h=i;f=h.getPlayer(k);b.startGame(h)};this.login=function(i){c.send("authPlayer",{guid:i})};this.step=function(){h.world.step()};this.startMove=function(i,k){f.direction=new OGE.Direction(i,k);c.send("startMove",{cos:i,sin:k,x:f.x,y:f.y})};this.endMove=function(){f.direction=null;c.send("endMove",{x:f.x,y:f.y})};this.placeBomb=function(){if(f.bombs>0){f.bombs--;var i=new Bomb(Math.floor((f.x+8)/16)*16,
Math.floor((f.y+8)/16)*16,16,16);i.power=f.power;c.send("placeBomb",{x:i.x,y:i.y});return i}};c.addListener("joinGame",function(){p=Player.deserialize(msg.data.player);h.addBody(p,true);addPlayer(p)});c.addListener("startMove",function(){p=h.getPlayer(msg.data.player);p.direction=new OGE.Direction(msg.data.cos,msg.data.sin);p.x=msg.data.x;p.y=msg.data.y});c.addListener("endMove",function(){p=h.getPlayer(msg.data.player);p.direction=null;p.x=msg.data.x;p.y=msg.data.y});c.addListener("logoutPlayer",
function(){p=h.getPlayer(msg.data.player);p.$img.remove();h.removeBody(p)});c.addListener("placeBomb",function(){var i=new Bomb(msg.data.x,msg.data.y,16,16);placeBomb(i)})};GameClient=function(){var b=new io.Socket,c={};this.addListener=function(h,f){if(typeof c[h]==="undefined")c[h]=[];c[h].push(f)};this.send=function(h,f){b.send({cmd:h,data:f})};b.connect();b.on("message",function(h){utils.log(h);_.each(c[h.cmd],function(f){f(h.result,h.data)})})};
GamePanel=function(b){var c=$("#gamePanel"),h=$("#fpsLabel"),f,i;this.startGame=function(q){f=new KeyboardHandler;i=new FactorialTimer;c.find("*").remove();c.show();c.width(q.world.width).height(q.world.height);$.each(q.blocks,function(n,r){k(r,"block")});$.each(q.bricks,function(n,r){k(r,"brick")});$.each(q.players,function(n,r){k(r,"pl1");r.animate=0;r.sprite=0;r.sprites=[1,2,1,3]});f.keydown(function(n){var r=0,l=0;switch(n){case "space":n=b.placeBomb();n.animate=0;n.sprite=0;n.sprites=[1,2,3];
k(n,"bomb1");break;case "left":r=-1;break;case "up":l=-1;break;case "right":r=1;break;case "down":l=1}if(r!==0||l!==0)b.startMove(r,l)}).keyup(function(){b.endMove()});var s=0;i.start(function(n){b.step();if(++s===20){h.text("Time: "+n);s=0}$.each(q.players,function(r,l){l.$img.css("left",l.x).css("top",l.y-4);if(l.direction!==null&&l.speed>0){if(l.lastDirection!==l.direction){l.animate=0;l.lastDirection=l.direction}if(--l.animate<0){l.animate=5;if(++l.sprite>=l.sprites.length)l.sprite=0;var v;if(l.direction.cos!==
0)v=l.direction.cos>0?"r":"l";else if(l.direction.sin!==0)v=l.direction.sin>0?"d":"u";l.$img.attr("src","/images/p"+v+l.sprites[l.sprite]+".png")}}});$.each(q.bombs,function(r,l){if(--l.animate<0){l.animate=5;if(++l.sprite>=l.sprites.length)l.sprite=0;l.$img.attr("src","/images/bomb"+l.sprites[l.sprite]+".png")}})})};var k=function(q,s){var n=$("<img>").attr("src","images/"+s+".png").css("left",q.x).css("top",q.y).addClass("body");c.append(n);q.$img=n}};
KeyboardHandler=function(){var b,c,h;this.keydown=function(f){c=f;return this};this.keyup=function(f){h=f;return this};$(document).keydown(function(f){var i=null;switch(f.keyCode){case 32:i="space";break;case 37:case 65:i="left";break;case 38:case 87:i="up";break;case 39:case 68:i="right";break;case 40:case 83:i="down"}if(i!==null){if(b!==f.keyCode){b=f.keyCode;c(i)}f.stopPropagation();f.preventDefault();return false}}).keyup(function(f){if(f.keyCode===b){b=0;h()}}).keypress(function(f){switch(f.keyCode){case 32:case 37:case 38:case 39:case 40:f.stopPropagation();
f.preventDefault();return false}})};FactorialTimer=function(){var b=(new Date).getTime(),c=0,h=50,f;this.start=function(k){f=k;i()};var i=function(){c=b=Math.floor(((new Date).getTime()-b)*0.9+c*0.1);if(b>50&&h>45)h--;else b<50&&h<55&&h++;f(b);b=(new Date).getTime();setTimeout(i,h)}};
