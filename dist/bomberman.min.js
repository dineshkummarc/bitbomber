var OGE={version:0.6};OGE.Direction=function(a,b){this.cos=typeof a!="undefined"?a:0;this.sin=typeof b!="undefined"?b:0};OGE.Direction.prototype.rotate=function(a){a=a*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+a);this.sin=Math.sin(Math.asin(this.sin)+a);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(a,b){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b]===a)return;this.bodies.push(a)};OGE.Zone.prototype.removeBody=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b]===a){this.bodies.splice(b,1);break}};
OGE.Body=function(a,b,c,d){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.width=typeof c!="undefined"?c:1;this.height=typeof d!="undefined"?d:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(a){this.onCollisions.push(a)};
OGE.Body.prototype.collide=function(a){for(var b=true,c=0;c<this.onCollisions.length;c++)if(this.onCollisions[c](a)===false)b=false;return b};OGE.Body.prototype.collide=function(a){for(var b=true,c=0;c<this.onCollisions.length;c++)if(this.onCollisions[c](a)===false)b=false;return b};OGE.Body.prototype.intersects=function(a,b,c,d){var f;f=a;if(arguments.length===1){f=a.x;b=a.y;c=a.width;d=a.height}return this.x<f+c&&this.x+this.width>f&&this.y<b+d&&this.y+this.height>b};
OGE.Body.prototype.intersection=function(a,b,c,d){var f;f=a;if(arguments.length===1){f=a.x;b=a.y;c=a.width;d=a.height}return((this.x+this.width<f+c?this.x+this.width:f+c)-(this.x>f?this.x:f))*((this.y+this.height<b+d?this.y+this.width:b+d)-(this.y>b?this.y:b))};
OGE.World=function(a,b,c){this.width=typeof a!="undefined"?a:640;this.height=typeof b!="undefined"?b:480;this.zoneSize=typeof c!="undefined"?c:10;this.activeBodies=[];a=a/this.zoneSize+1<<0;b=b/this.zoneSize+1<<0;this.zones=[];for(c=0;c<a;c++){this.zones[c]=[];for(var d=0;d<b;d++)this.zones[c][d]=new OGE.Zone(c,d)}};OGE.World.prototype.addBody=function(a,b){if(this.addBodyToZones(a)!==true)return false;if(arguments.length>=2)a.active=b;a.active&&this.activeBodies.push(a);return true};
OGE.World.prototype.removeBody=function(a){this.removeBodyFromZones(a);for(var b=0;b<this.activeBodies.length;b++)if(this.activeBodies[b]===a){this.activeBodies.splice(b,1);break}};
OGE.World.prototype.getBodies=function(a,b,c,d){var f,e;f=e=a;if(arguments.length===1){e=f.x;b=f.y;c=f.width;d=f.height}e=e<0?0:e;e=e+c>this.width?this.width-c:e;b=b<0?0:b;b=b+d>this.height?this.height-d:b;f=[];e=this.getZones(e,b,c,d);for(var h=0;h<e.length;h++)for(var i=e[h].bodies,j=0;j<i.length;j++){for(var k=i[j],o=false,g=0;g<f.length;g++)if(f[g]===k){o=true;break}o||f.push(k)}return f};
OGE.World.prototype.getZones=function(a,b,c,d){var f,e;f=e=a;if(arguments.length===1){e=f.x;b=f.y;c=f.width;d=f.height}if(e>=0&&e+c-1<this.width&&b>=0&&b+d-1<this.height){f=(e+c)/this.zoneSize<<0;var h=b/this.zoneSize<<0,i=(b+d)/this.zoneSize<<0,j=0,k=[];for(e=e/this.zoneSize<<0;e<=f;e++)for(b=h;b<=i;b++)k[j++]=this.zones[e][b];return k}else return[]};
OGE.World.prototype.step=function(a){a=arguments.length===0?1:a;for(var b=0;b<a;b++)for(var c=0;c<this.activeBodies.length;c++){var d=this.activeBodies[c];d.speed>0&&d.direction!==null&&this.moveBody(d)}};OGE.World.prototype.addBodyToZones=function(a){var b=this.getZones(a);if(b.length===0)return false;for(var c=0;c<b.length;c++)b[c].addBody(a);return true};OGE.World.prototype.removeBodyFromZones=function(a){for(var b=this.getZones(a),c=0;c<b.length;c++)b[c].removeBody(a)};
OGE.World.prototype.moveBody=function(a,b,c){var d,f,e;if(arguments.length===1){b=a.direction;c=a.speed}for(var h=0;h<c;h++){d=a.x;f=a.y;this.removeBodyFromZones(a);a.x+=b.cos;a.y+=b.sin;if(a.x>=0&&a.y>=0&&a.x+a.width<this.width&&a.y+a.height<this.height){e=this.getBodies(a);for(var i=0;i<e.length;i++){var j=e[i];if(a!==j&&!j.intersects(d,f,a.width,a.height)&&j.intersects(a)){var k=a.collide(j)===true;j=j.collide(a)===true;if(k&&j){a.x=d;a.y=f;this.addBodyToZones(a);if(a.slide&&i>=0)this.slideBody(a,
b);else return}}}this.addBodyToZones(a)}else{a.x=d;a.y=f;break}}};
OGE.World.prototype.slideBody=function(a,b){var c=this,d=function(e){var h=[],i=c.getBodies(a),j,k,o,g,q,m;for(k=0;k<i.length;k++){q=i[k];q!==a&&q.intersects(a)&&h.push(q)}j=0;o=a.x+e.cos*1.9<<0;if(o!==a.x)o=a.x+(o>a.x?1:-1);g=a.y+e.sin*1.9<<0;if(g!==a.y)g=a.y+(g>a.y?1:-1);i=c.getBodies(o,g,a.width,a.height);for(k=0;k<i.length;k++){q=i[k];if(q!==a&&q.intersects(o,g,a.width,a.height)){m=false;for(e=0;e<h.length;e++)if(q===h[e]){m=true;break}m||(j+=q.intersection(o,g,a.width,a.height))}}return j<<0},
f=d(b.clone().rotate(-45));d=d(b.clone().rotate(45));if(f<d)this.moveBody(a,b.clone().rotate(-90),1);else f>d&&this.moveBody(a,b.clone().rotate(90),1)};Object.construct_prototype=function(a){var b=function(){};b.prototype=a.prototype;return new b};Player=function(a,b,c,d,f){this.nick=f;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.power=this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);
Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};Player.deserialize=function(a){return _.extend(new Player(a.x,a.y,a.width,a.height,a.nick),a)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=4;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);
Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(a,b){this.world=new OGE.World(a,b,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};Game.version=0.6;
Game.prototype.getBomb=function(a,b){for(var c=0;c<this.bombs.length;c++)if(this.bombs[c].x===a&&this.bombs[c].y===b)return this.bombs[c];return null};Game.prototype.removeBodies=function(a,b){var c=this;_.each(a,function(d){d instanceof b&&c.removeBody(d)})};
Game.prototype.explodeBomb=function(a,b){if(arguments.length===1)b={x:a.x,y:a.y,bodies:[],fires:[],bombs:[]};var c=this,d=function(e,h,i){var j=function(k){return k.x===e&&k.y===h};if(typeof _.detect(b.bodies,j)==="undefined"){i={x:e,y:h,firevar:i};j=_.detect(b.fires,j);if(typeof j!=="undefined"){if(j.firevar!=="c"&&_.contains("c","v","h",i.firevar)){b.fires=_.without(b.fires,j);b.fires.push(i)}}else b.fires.push(i)}};b.bombs.push(a);d(a.x,a.y,"c");var f=function(e,h,i,j){e=e*a.width;var k=a.x+e,
o=a.x+a.size*e;h=h*a.height;var g=a.y+h,q=a.y+a.size*h;actualCheck=function(m,r,n){if(m>=0&&r>=0&&m<c.world.width&&r<c.world.height){for(var s=c.world.getBodies(m,r,a.width,a.height),l=0;l<s.length;l++){var t=s[l];if(t!==a&&t.intersects(m+2,r+2,a.width-2,a.height-2)){if(t.armor>a.power)return false;else{!(t instanceof Bomb)&&!_.contains(b.bodies,t)&&b.bodies.push(t);if(t.armor===a.power)return false}t instanceof Bomb&&!_.contains(b.bombs,t)&&c.explodeBomb(t,b)}}d(m,r,n)}return true};for(k=k;k!==o+
e;k+=e)if(!actualCheck(k,a.y,k!==o?i:j))break;for(e=g;e!==q+h;e+=h)if(!actualCheck(a.x,e,e!==q?i:j))break};f(-1,0,"h","l");f(1,0,"h","r");f(0,-1,"v","u");f(0,1,"v","d");return b};Game.prototype.addBody=function(a,b){if(!this.world.addBody(a,b))return false;if(a instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=a;this.players.push(a)}else a instanceof Bomb&&this.bombs.push(a);return true};
Game.prototype.serialize=function(){var a=this,b={width:this.world.width,height:this.world.height},c=function(d,f){if(a[d].length>0){var e=a[d][0].width;b[d]={};b[d].size=e;b[d].pos=[];b[d].attrs={};_.each(a[d],function(h){b[d].pos.push(h.y/e*Math.floor(a.world.width/e)+h.x/e);_.each(f,function(i){b[d].attrs[i]=h[i]})})}};if(this.players.length>0){b.players=[];_.each(this.players,function(d){b.players.push(d.serialize())})}c("blocks",["armor"]);c("bricks");return b};
Game.prototype.removeBody=function(a){this.world.removeBody(a);this.players=_.without(this.players,a);this.bombs=_.without(this.bombs,a);this.blocks=_.without(this.blocks,a);this.bricks=_.without(this.bricks,a)};Game.prototype.getPlayer=function(a){for(var b=0;b<this.players.length;b++)if(this.players[b].nick===a)return this.players[b]};
Game.prototype.createBlocks=function(a){for(var b=1;b<this.world.height/a-2;b+=2)for(var c=1;c<this.world.width/a-2;c+=2){var d=new Box(c*a,b*a,a,a);d.armor=2;this.blocks.push(d);this.addBody(d)}return this};Game.prototype.createBricks=function(a,b){for(var c=this.world.width/a,d=this.world.height/a,f=0;f<d-1;f++)for(var e=0;e<c-1;e++)if(Math.random()*100<b&&!(e%2===1&&f%2===1))if((e>1||f>1)&&(e>1||f<d-2)&&(e<c-2||f>1)&&(e<c-2||f<d-2)){var h=new Box(e*a,f*a,a,a);this.bricks.push(h);this.addBody(h)}return this};
Game.deserialize=function(a){var b=new Game(a.width,a.height),c=function(d){if(a[d].pos.length>0){var f=a[d].size,e=Math.floor(a.width/f);_.each(a[d].pos,function(h){var i=new Box(h%e*f,Math.floor(h/e)*f,f,f);_.each(a[d].attrs,function(j,k){i[k]=a[d].attrs[k]});b[d].push(i);b.addBody(i)})}};c("blocks");c("bricks");a.players&&a.players.length>0&&_.each(a.players,function(d){b.addBody(Player.deserialize(d),true)});return b};var $infoArea,utils={};
utils.log=function(a,b){if(arguments.length===1){b=a;a=b.cmd}typeof console!=="undefined"&&console!==null&&console.log(a,b);b=a+" - "+b.result;$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+b);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};
$(function(){$infoArea=$("#infoArea");var a=new HttpClient,b=new SocketClient,c=new GameHandler(void 0,b);new GamePanel(c);new LobbyPanel(void 0);new LobbyHandler(c,a,b);utils.log({cmd:"versions",result:"OGE: "+OGE.version+". Game: "+Game.version+". Client: 0.1"})});
LobbyHandler=function(a,b,c){var d;this.createGame=function(f){b.createGame(function(e){if(e.result==="OK"){e=Game.deserialize(e.data);a.startGame(e,d.nick);f(true)}else f(fale)})};this.playNow=function(f){b.playNow(function(e){if(e.result==="OK"){e=Game.deserialize(e.data);a.startGame(e,d.nick);f(true)}else f(false)})};this.login=function(f,e){b.login(f,function(h){if(h.result==="OK"){d=h.data;c.send("authPlayer",{guid:d.guid});e(true)}else e(false)})}};
HttpClient=function(){var a;this.createGame=function(b){$.getJSON("/lobby?cmd=createGame&guid="+a.guid,function(c){utils.log("createGame",c);b(c)})};this.playNow=function(b){$.getJSON("/lobby?cmd=joinGame&guid="+a.guid,function(c){utils.log("playNow",c);b(c)})};this.login=function(b,c){$.getJSON("/lobby?cmd=loginPlayer&nick="+b,function(d){utils.log("loginPlayer",d);if(d.result==="OK")a=d.data;c(d)})}};
LobbyPanel=function(a){var b=$("#loginPanel"),c=$("#loginButton"),d=$("#lobbyPanel"),f=$("#nickField"),e=$("#playNowButton"),h=$("#createGameButton"),i=function(){a.createGame(function(o){o&&d.hide()})},j=function(){a.playNow(function(){d.hide()})},k=function(){f.val().length>0&&a.login(f.val(),function(o){if(o){b.hide();d.show()}else{f.focus();b.children("span").text("Nick taken!")}})};(function(){f.keypress(function(o){if(o.keyCode===13){f.blur();k()}});c.click(function(){k()});e.click(function(){j()});
h.click(function(){i()});f.focus()})()};
GameHandler=function(a,b){var c,d,f;listeners={};this.addListener=function(e,h){if(typeof listeners[e]==="undefined")listeners[e]=[];listeners[e].push(h)};this.removeBody=function(e){c.removeBody(e)};this.startGame=function(e,h){c=e;d=c.getPlayer(h);f=new FactorialTimer;var i=(new Date).getTime(),j;f.start(function(){i=(new Date).getTime()-i;j=(new Date).getTime();c.world.step();j=(new Date).getTime()-j;var k=Math.floor(1E3/i);_.each(listeners.step,function(o){o(i,k,j)});i=(new Date).getTime()});
_.each(listeners.startGame,function(k){k(c)})};this.startMove=function(e,h){if(!d.dead){d.direction=new OGE.Direction(e,h);b.send("startMove",{cos:e,sin:h,x:d.x,y:d.y})}};this.endMove=function(){if(!d.dead){d.direction=null;b.send("endMove",{x:d.x,y:d.y})}};this.placeBomb=function(){if(!d.dead)if(d.bombs>0){var e=new Bomb(Math.floor((d.x+8)/16)*16,Math.floor((d.y+8)/16)*16,16,16);e.size=2;c.addBody(e);e.power=d.power;b.send("placeBomb",{x:e.x,y:e.y});return e}};b.addListener("joinGame",function(e,
h){p=Player.deserialize(h.player);c.addBody(p,true);_.each(listeners.addPlayer,function(i){i(p)})});b.addListener("startMove",function(e,h){p=c.getPlayer(h.player);p.direction=new OGE.Direction(h.cos,h.sin);p.x=h.x;p.y=h.y});b.addListener("endMove",function(e,h){p=c.getPlayer(h.player);p.direction=null;p.x=h.x;p.y=h.y});b.addListener("logoutPlayer",function(e,h){p=c.getPlayer(h.player);p.$img.remove();c.removeBody(p)});b.addListener("placeBomb",function(e,h){var i=new Bomb(h.x,h.y,16,16);c.addBody(i);
_.each(listeners.placeBomb,function(j){j(i)})});b.addListener("explodeBomb",function(e,h){var i=c.getBomb(h.x,h.y);c.getPlayer(h.player).bombs++;if(i!==null){var j=c.explodeBomb(i);c.removeBodies(j.bombs,Bomb);if(_.include(j.bodies,d)){d.x=0;d.y=0;b.send("playerDead",{})}_.each(listeners.explodeBomb,function(k){k(i,j)})}});b.addListener("playerDead",function(e,h){var i=c.getPlayer(h.player);i.x=0;i.y=0;_.each(listeners.playerDead,function(){})});b.addListener("resurectPlayer",function(e,h){var i=
c.getPlayer(h.player);c.addBody(i);_.each(listeners.resurectPlayer,function(j){j(i)})})};SocketClient=function(){var a=new io.Socket,b={};this.addListener=function(c,d){if(typeof b[c]==="undefined")b[c]=[];b[c].push(d)};this.send=function(c,d){a.send({cmd:c,data:d})};a.connect();a.on("message",function(c){utils.log(c);_.each(b[c.cmd],function(d){d(c.result,c.data)})})};
GamePanel=function(a){var b=$("#gamePanel"),c=$("#fpsLabel"),d,f=[],e=[];a.addListener("startGame",function(g){d=new KeyboardHandler;b.find("*").remove();b.show();b.width(g.world.width).height(g.world.height);_.each(g.blocks,function(m){h(m,"objects")});_.each(g.bricks,function(m){h(m,"objects");m.offsetSprite=1;o(m)});_.each(g.players,function(m){i(m)});d.keydown(function(m){var r=0,n=0;switch(m){case "space":(m=a.placeBomb())&&j(m);break;case "left":r=-1;break;case "up":n=-1;break;case "right":r=
1;break;case "down":n=1}if(r!==0||n!==0)a.startMove(r,n)}).keyup(function(){a.endMove()});var q=0;a.addListener("step",function(m,r,n){var s=(new Date).getTime();_.each(g.players,function(l){if(l.animate===0&&l.direction!==null&&l.speed>0){l.animate=5;l.sprite=0}else if(l.animate>0&&l.direction===null||l.speed===0)l.animate=0;k(l)});_.each(g.bombs,function(l){k(l)});_.each(f,function(l){k(l);if(l.sprite===l.sprites.length-1&&l.animate===1){f=_.without(f,l);l.$img.remove()}});_.each(e,function(l){k(l);
if(l.sprite===l.sprites.length-1&&l.animate===1){e=_.without(e,l);l.$img.remove();a.removeBody(l)}});if(++q===20){s=(new Date).getTime()-s;c.text("Total time: "+m+". Engine time: "+n+". Drawing time: "+s+" . fps: "+r);q=0}});a.addListener("explodeBomb",function(m,r){_.each(r.bombs,function(n){n.$img.remove()});_.each(r.fires,function(n){var s=0;switch(n.firevar){case "l":s=2;break;case "r":s=3;break;case "u":s=4;break;case "d":s=1;break;case "h":s=5;break;case "v":s=6}h(n,"fires");n.direction=null;
n.sprites=[0,1,2,3];n.offsetSprite=s;n.animate=5;f.push(n)});_.each(r.bodies,function(n){if(n instanceof Box){n.animate=5;n.sprite=0;n.offsetSprite=1;n.sprites=[1,2];n.animateTimer=10;e.push(n)}else n instanceof Bomb&&n.$img.remove()})})});a.addListener("addPlayer",function(g){i(g)});a.addListener("placeBomb",function(g){j(g)});a.addListener("meDead",function(g){g.$img.remove()});a.addListener("playerDead",function(g){g.$img.remove()});a.addListener("resurectPlayer",function(g){b.append(g.$img)});
var h=function(g,q){var m=$("<div>").css("background","url(images/"+q+".png)").css("left",g.x).css("top",g.y).addClass("body");g.$img=m;g.sprite=0;g.offsetSprite=0;g.animate=0;g.animateCount=0;g.sprites=[0];g.animateTimer=5;o(g);b.append(m);return m},i=function(g){h(g,"players").addClass("player");g.sprites=[0,1,0,2]},j=function(g){h(g,"objects");g.sprites=[0,1,2];g.animate=5;g.offsetSprite=2},k=function(g){g.direction!==null&&g.speed>0&&g.$img.css("left",g.x).css("top",g.y-4);if(g.animate>0){if(g.lastDirection!==
g.direction){g.animate=0;g.lastDirection=g.direction}if(--g.animate<=0){g.animate=g.animateTimer;if(++g.sprite>=g.sprites.length)g.sprite=0;var q=0;if(g.direction!==null)if(g.direction.cos!==0)q=g.direction.cos>0?3:2;else if(g.direction.sin!==0)q=g.direction.sin>0?0:1;o(g,q)}}},o=function(g,q){if(arguments.length===1)q=0;g.$img.css("background-position",-(18*(q+g.offsetSprite))+"px "+-(22*g.sprites[g.sprite])+"px")}};
KeyboardHandler=function(){var a,b,c;this.keydown=function(d){b=d;return this};this.keyup=function(d){c=d;return this};$(document).keydown(function(d){var f=null;switch(d.keyCode){case 32:f="space";break;case 37:case 65:f="left";break;case 38:case 87:f="up";break;case 39:case 68:f="right";break;case 40:case 83:f="down"}if(f!==null){if(a!==d.keyCode){a=f!=="space"?d.keyCode:a;b(f)}d.stopPropagation();d.preventDefault();return false}}).keyup(function(d){if(d.keyCode===a){a=0;c()}}).keypress(function(d){switch(d.keyCode){case 32:case 37:case 38:case 39:case 40:d.stopPropagation();
d.preventDefault();return false}})};FactorialTimer=function(){(new Date).getTime();var a;this.start=function(c){a=c;setInterval(b,50)};var b=function(){a()}};
