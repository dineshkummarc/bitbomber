var OGE={};OGE.Direction=function(a,b){this.cos=typeof a!="undefined"?a:0;this.sin=typeof b!="undefined"?b:0};OGE.Direction.prototype.rotate=function(a){a=a*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+a);this.sin=Math.sin(Math.asin(this.sin)+a);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(a,b){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b]===a)return;this.bodies.push(a)};OGE.Zone.prototype.removeBody=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b]===a){this.bodies.splice(b,1);break}};
OGE.Body=function(a,b,d,c){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.width=typeof d!="undefined"?d:1;this.height=typeof c!="undefined"?c:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(a){this.onCollisions.push(a)};
OGE.Body.prototype.collide=function(a){for(var b=true,d=0;d<this.onCollisions.length;d++)if(this.onCollisions[d](a)===false)b=false;return b};OGE.Body.prototype.collide=function(a){for(var b=true,d=0;d<this.onCollisions.length;d++)if(this.onCollisions[d](a)===false)b=false;return b};OGE.Body.prototype.intersects=function(a,b,d,c){var e;e=a;if(arguments.length===1){e=a.x;b=a.y;d=a.width;c=a.height}return this.x<e+d&&this.x+this.width>e&&this.y<b+c&&this.y+this.height>b};
OGE.Body.prototype.intersection=function(a,b,d,c){var e;e=a;if(arguments.length===1){e=a.x;b=a.y;d=a.width;c=a.height}return((this.x+this.width<e+d?this.x+this.width:e+d)-(this.x>e?this.x:e))*((this.y+this.height<b+c?this.y+this.width:b+c)-(this.y>b?this.y:b))};
OGE.World=function(a,b,d){this.width=typeof a!="undefined"?a:640;this.height=typeof b!="undefined"?b:480;this.zoneSize=typeof d!="undefined"?d:10;this.activeBodies=[];a=a/this.zoneSize+1<<0;b=b/this.zoneSize+1<<0;this.zones=[];for(d=0;d<a;d++){this.zones[d]=[];for(var c=0;c<b;c++)this.zones[d][c]=new OGE.Zone(d,c)}};OGE.World.prototype.addBody=function(a,b){if(this.addBodyToZones(a)!==true)return false;if(arguments.length>=2)a.active=b;a.active&&this.activeBodies.push(a);return true};
OGE.World.prototype.removeBody=function(a){this.removeBodyFromZones(a);for(var b=0;b<this.activeBodies.length;b++)if(this.activeBodies[b]===a){this.activeBodies.splice(b,1);break}};
OGE.World.prototype.getBodies=function(a,b,d,c){var e,f;e=f=a;if(arguments.length===1){f=e.x;b=e.y;d=e.width;c=e.height}f=f<0?0:f;f=f+d>this.width?this.width-d:f;b=b<0?0:b;b=b+c>this.height?this.height-c:b;e=[];f=this.getZones(f,b,d,c);for(var h=0;h<f.length;h++)for(var i=f[h].bodies,g=0;g<i.length;g++){for(var j=i[g],k=false,l=0;l<e.length;l++)if(e[l]===j){k=true;break}k||e.push(j)}return e};
OGE.World.prototype.getZones=function(a,b,d,c){var e,f;e=f=a;if(arguments.length===1){f=e.x;b=e.y;d=e.width;c=e.height}if(f>=0&&f+d-1<this.width&&b>=0&&b+c-1<this.height){e=(f+d)/this.zoneSize<<0;var h=b/this.zoneSize<<0,i=(b+c)/this.zoneSize<<0,g=0,j=[];for(f=f/this.zoneSize<<0;f<=e;f++)for(b=h;b<=i;b++)j[g++]=this.zones[f][b];return j}else return[]};
OGE.World.prototype.step=function(a){a=arguments.length===0?1:a;for(var b=0;b<a;b++)for(var d=0;d<this.activeBodies.length;d++){var c=this.activeBodies[d];c.speed>0&&c.direction!==null&&this.moveBody(c)}};OGE.World.prototype.addBodyToZones=function(a){var b=this.getZones(a);if(b.length===0)return false;for(var d=0;d<b.length;d++)b[d].addBody(a);return true};OGE.World.prototype.removeBodyFromZones=function(a){for(var b=this.getZones(a),d=0;d<b.length;d++)b[d].removeBody(a)};
OGE.World.prototype.moveBody=function(a,b,d){var c,e,f;if(arguments.length===1){b=a.direction;d=a.speed}for(var h=0;h<d;h++){c=a.x;e=a.y;this.removeBodyFromZones(a);a.x+=b.cos;a.y+=b.sin;f=this.getBodies(a);for(var i=0;i<f.length;i++){var g=f[i];if(a!==g&&!g.intersects(c,e,a.width,a.height)&&g.intersects(a)){var j=a.collide(g)===true;g=g.collide(a)===true;if(j&&g){a.x=c;a.y=e;this.addBodyToZones(a);if(a.slide&&i>=0)this.slideBody(a,b);else return}}}this.addBodyToZones(a)}};
OGE.World.prototype.slideBody=function(a,b){var d=this,c=function(f){var h=0,i=a.x+f.cos*1.9<<0;if(i!==a.x)i=a.x+(i>a.x?1:-1);f=a.y+f.sin*1.9<<0;if(f!==a.y)f=a.y+(f>a.y?1:-1);for(var g=d.getBodies(i,f,a.width,a.height),j=0;j<g.length;j++){var k=g[j];if(k!==a&&k.intersects(i,f,a.width,a.height))h+=k.intersection(i,f,a.width,a.height)}return h<<0},e=c(b.clone().rotate(-45));c=c(b.clone().rotate(45));if(e<c)this.moveBody(a,b.clone().rotate(-90),1);else e>c&&this.moveBody(a,b.clone().rotate(90),1)};
Object.construct_prototype=function(a){var b=function(){};b.prototype=a.prototype;return new b};Player=function(a,b,d,c,e){this.nick=e;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};
Player.deserialize=function(a){return _.extend(new Player(a.x,a.y,a.width,a.height,a.nick),a)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=10;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);
Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(a,b){this.world=new OGE.World(a,b,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};
Game.prototype.addBody=function(a,b){if(!this.world.addBody(a,b))return false;if(a instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=a;this.players.push(a)}else a instanceof Bomb&&this.bombs.push(a);return true};
Game.prototype.serialize=function(){var a=this,b={width:this.world.width,height:this.world.height},d=function(c,e){if(a[c].length>0){var f=a[c][0].width;b[c]={};b[c].size=f;b[c].pos=[];b[c].attrs={};_.each(a[c],function(h){b[c].pos.push(h.y/f*Math.floor(a.world.width/f)+h.x/f);_.each(e,function(i){b[c].attrs[i]=h[i]})})}};if(this.players.length>0){b.players=[];_.each(this.players,function(c){b.players.push(c.serialize())})}d("blocks",["armor"]);d("bricks");return b};
Game.prototype.removeBody=function(a){this.world.removeBody(a);this.players=_.without(this.players,a);this.bombs=_.without(this.bombs,a);this.blocks=_.without(this.blocks,a);this.bricks=_.without(this.bricks,a)};Game.prototype.getPlayer=function(a){for(var b=0;b<this.players.length;b++)if(this.players[b].nick===a)return this.players[b]};
Game.prototype.createBlocks=function(a){for(var b=1;b<this.world.height/a-2;b+=2)for(var d=1;d<this.world.width/a-2;d+=2){var c=new Box(d*a,b*a,a,a);c.armor=1;this.blocks.push(c);this.addBody(c)}return this};Game.prototype.createBricks=function(a,b){for(var d=this.world.width/a,c=this.world.height/a,e=0;e<c-1;e++)for(var f=0;f<d-1;f++)if(Math.random()*100<b&&!(f%2===1&&e%2===1))if((f>1||e>1)&&(f>1||e<c-2)&&(f<d-2||e>1)&&(f<d-2||e<c-2)){var h=new Box(f*a,e*a,a,a);this.bricks.push(h);this.addBody(h)}return this};
Game.deserialize=function(a){var b=new Game(a.width,a.height),d=function(c){if(a[c].pos.length>0){var e=a[c].size,f=Math.floor(a.width/e);_.each(a[c].pos,function(h){var i=new Box(h%f*e,Math.floor(h/f)*e,e,e);_.each(a[c].attrs,function(g,j){i[j]=a[c].attrs[j]});b[c].push(i);b.addBody(i)})}};d("blocks");d("bricks");a.players&&a.players.length>0&&_.each(a.players,function(c){b.addBody(Player.deserialize(c),true)});return b};var $infoArea,client,utils={};
utils.log=function(a){if(a.cmd&&a.result){typeof console!=="undefined"&&console!==null&&console.log(a.cmd,a);a=a.cmd+" - "+a.result}else typeof console!=="undefined"&&console!==null&&console.log(a);$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+a);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};$(function(){$infoArea=$("#infoArea");LobbyHandler()});
LobbyHandler=function(){var a=new LobbyClient(this);new LobbyPanel(this);var b=new GameClient;new GameHandler(b);var d;b.addListener("authPlayer",function(c,e){console.log("auth: "+c,e)});this.createGame=function(c){a.createGame(function(e){if(e.result==="OK"){Game.deserialize(e.data);c(true)}else c(fale)})};this.playNow=function(c){a.playNow(function(e){if(e.result==="OK"){Game.deserialize(e.data);c(true)}else c(false)})};this.login=function(c,e){a.login(c,function(f){if(f.result==="OK"){d=f.data;
b.send("authPlayer",{guid:d.guid});e(true)}else e(false)})}};LobbyClient=function(){var a;this.createGame=function(b){$.getJSON("/lobby?cmd=createGame&guid="+a.guid,function(d){utils.log(d);b(d)})};this.playNow=function(){$.getJSON("/lobby?cmd=joinGame&guid="+a.guid,function(b){utils.log(b)})};this.login=function(b,d){$.getJSON("/lobby?cmd=loginPlayer&nick="+b,function(c){utils.log(c);if(c.result==="OK")a=c.data;d(c)})}};
LobbyPanel=function(a){var b=$("#loginPanel"),d=$("#loginButton"),c=$("#lobbyPanel"),e=$("#nickField"),f=$("#playNowButton"),h=$("#createGameButton"),i=function(){a.createGame(function(k){k&&c.hide()})},g=function(){a.playNow(function(){c.hide()})},j=function(){e.val().length>0&&a.login(e.val(),function(k){if(k){b.hide();c.show()}else b.children("span").text("Nick taken!")})};(function(){e.keypress(function(k){k.keyCode===13&&j()});d.click(function(){j()});f.click(function(){g()});h.click(function(){i()});
e.focus()})()};
GameHandler=function(a){new GamePanel(this);a.addListener("joinGame",function(){p=Player.deserialize(msg.data.player);game.addBody(p,true);addPlayer(p)});a.addListener("startMove",function(){p=game.getPlayer(msg.data.player);p.direction=new OGE.Direction(msg.data.cos,msg.data.sin);p.x=msg.data.x;p.y=msg.data.y});a.addListener("endMove",function(){p=game.getPlayer(msg.data.player);p.direction=null;p.x=msg.data.x;p.y=msg.data.y});a.addListener("logoutPlayer",function(){p=game.getPlayer(msg.data.player);p.$img.remove();
game.removeBody(p)});a.addListener("placeBomb",function(){var b=new Bomb(msg.data.x,msg.data.y,16,16);placeBomb(b)})};GameClient=function(){var a=new io.Socket,b={};this.addListener=function(d,c){if(typeof b[d]==="undefined")b[d]=[];b[d].push(c)};this.send=function(d,c){a.send({cmd:d,data:c})};a.connect();a.on("message",function(d){_.each(b[d.cmd],function(c){c(d.result,d.data)})})};
GamePanel=function(a){var b=$("#gamePanel"),d=$("#fpsLabel"),c,e;this.init=function(){c=new KeyboardHandler;e=new e;b.find("*").remove();b.show();b.width(game.world.width).height(game.world.height);$.each(game.blocks,function(h,i){f(i,"block")});$.each(game.bricks,function(h,i){f(i,"brick")});$.each(game.players,function(h,i){f(i,"pl1");i.animate=0;i.sprite=0;i.sprites=[1,2,1,3]});c.keydown(function(h){switch(h){case "space":h=a.placeBomb();h.animate=0;h.sprite=0;h.sprites=[1,2,3];game.addBody(h);
f(h,"bomb1");break;case "left":cos=-1;break;case "up":sin=-1;break;case "right":cos=1;break;case "down":sin=1}if(cos!==0||sin!==0)a.startMove(cos,sin)}).keyup(function(){a.endMove()});e.start(function(h){a.step();if(++frame===20){d.text("Time: "+h);frame=0}$.each(game.players,function(i,g){g.$img.css("left",g.x).css("top",g.y-4);if(g.direction!==null&&g.speed>0){if(g.lastDirection!==g.direction){g.animate=0;g.lastDirection=g.direction}if(--g.animate<0){g.animate=5;if(++g.sprite>=g.sprites.length)g.sprite=
0;var j;if(g.direction.cos!==0)j=g.direction.cos>0?"r":"l";else if(g.direction.sin!==0)j=g.direction.sin>0?"d":"u";g.$img.attr("src","/images/p"+j+g.sprites[g.sprite]+".png")}}});$.each(game.bombs,function(i,g){if(--g.animate<0){g.animate=5;if(++g.sprite>=g.sprites.length)g.sprite=0;g.$img.attr("src","/images/bomb"+g.sprites[g.sprite]+".png")}})})};var f=function(h,i){var g=$("<img>").attr("src","images/"+i+".png").css("left",h.x).css("top",h.y).addClass("body");b.append(g);h.$img=g}};
KeyboardHandler=function(){var a,b,d;this.keydown=function(){b=fn;return this};this.keyup=function(){d=fn;return this};$(document).keydown(function(c){var e=false,f=null;switch(c.keyCode){case 32:f="space";break;case 37:case 65:f="left";break;case 38:case 87:f="up";break;case 39:case 68:f="right";break;case 40:case 83:f="down"}if(f!==null&&a!==c.keyCode){a=c.keyCode;e=true;b(f)}if(e){c.stopPropagation();c.preventDefault();return false}}).keyup(function(c){if(c.keyCode===a){a=0;d()}}).keypress(function(c){switch(c.keyCode){case 32:case 37:case 38:case 39:case 40:c.stopPropagation();
c.preventDefault();return false}})};FactorialTimer=function(){var a=(new Date).getTime(),b=0,d=50,c;this.start=function(f){c=f;e()};var e=function(){b=a=Math.floor(((new Date).getTime()-a)*0.9+b*0.1);if(a>50&&d>45)d--;else a<50&&d<55&&d++;c(a);a=(new Date).getTime();setTimeout(e,d)}};
