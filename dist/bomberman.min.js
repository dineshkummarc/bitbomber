var OGE={};OGE.Direction=function(a,b){this.cos=typeof a!="undefined"?a:0;this.sin=typeof b!="undefined"?b:0};OGE.Direction.prototype.rotate=function(a){a=a*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+a);this.sin=Math.sin(Math.asin(this.sin)+a);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(a,b){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b]===a)return;this.bodies.push(a)};OGE.Zone.prototype.removeBody=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b]===a){this.bodies.splice(b,1);break}};
OGE.Body=function(a,b,c,d){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.width=typeof c!="undefined"?c:1;this.height=typeof d!="undefined"?d:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(a){this.onCollisions.push(a)};
OGE.Body.prototype.collide=function(a){for(var b=true,c=0;c<this.onCollisions.length;c++)if(this.onCollisions[c](a)===false)b=false;return b};OGE.Body.prototype.collide=function(a){for(var b=true,c=0;c<this.onCollisions.length;c++)if(this.onCollisions[c](a)===false)b=false;return b};OGE.Body.prototype.intersects=function(a,b,c,d){var e;e=a;if(arguments.length===1){e=a.x;b=a.y;c=a.width;d=a.height}return this.x<e+c&&this.x+this.width>e&&this.y<b+d&&this.y+this.height>b};
OGE.Body.prototype.intersection=function(a,b,c,d){var e;e=a;if(arguments.length===1){e=a.x;b=a.y;c=a.width;d=a.height}return((this.x+this.width<e+c?this.x+this.width:e+c)-(this.x>e?this.x:e))*((this.y+this.height<b+d?this.y+this.width:b+d)-(this.y>b?this.y:b))};
OGE.World=function(a,b,c){this.width=typeof a!="undefined"?a:640;this.height=typeof b!="undefined"?b:480;this.zoneSize=typeof c!="undefined"?c:10;this.activeBodies=[];a=a/this.zoneSize+1<<0;b=b/this.zoneSize+1<<0;this.zones=[];for(c=0;c<a;c++){this.zones[c]=[];for(var d=0;d<b;d++)this.zones[c][d]=new OGE.Zone(c,d)}};OGE.World.prototype.addBody=function(a,b){if(this.addBodyToZones(a)!==true)return false;if(arguments.length>=2)a.active=b;a.active&&this.activeBodies.push(a);return true};
OGE.World.prototype.removeBody=function(a){this.removeBodyFromZones(a);for(var b=0;b<this.activeBodies.length;b++)if(this.activeBodies[b]===a){this.activeBodies.splice(b,1);break}};
OGE.World.prototype.getBodies=function(a,b,c,d){var e,f;e=f=a;if(arguments.length===1){f=e.x;b=e.y;c=e.width;d=e.height}f=f<0?0:f;f=f+c>this.width?this.width-c:f;b=b<0?0:b;b=b+d>this.height?this.height-d:b;e=[];f=this.getZones(f,b,c,d);for(var k=0;k<f.length;k++)for(var l=f[k].bodies,m=0;m<l.length;m++){for(var g=l[m],j=false,i=0;i<e.length;i++)if(e[i]===g){j=true;break}j||e.push(g)}return e};
OGE.World.prototype.getZones=function(a,b,c,d){var e,f;e=f=a;if(arguments.length===1){f=e.x;b=e.y;c=e.width;d=e.height}if(f>=0&&f+c-1<this.width&&b>=0&&b+d-1<this.height){e=(f+c)/this.zoneSize<<0;var k=b/this.zoneSize<<0,l=(b+d)/this.zoneSize<<0,m=0,g=[];for(f=f/this.zoneSize<<0;f<=e;f++)for(b=k;b<=l;b++)g[m++]=this.zones[f][b];return g}else return[]};
OGE.World.prototype.step=function(a){a=arguments.length===0?1:a;for(var b=0;b<a;b++)for(var c=0;c<this.activeBodies.length;c++){var d=this.activeBodies[c];d.speed>0&&d.direction!==null&&this.moveBody(d)}};OGE.World.prototype.addBodyToZones=function(a){var b=this.getZones(a);if(b.length===0)return false;for(var c=0;c<b.length;c++)b[c].addBody(a);return true};OGE.World.prototype.removeBodyFromZones=function(a){for(var b=this.getZones(a),c=0;c<b.length;c++)b[c].removeBody(a)};
OGE.World.prototype.moveBody=function(a,b,c){var d,e,f;if(arguments.length===1){b=a.direction;c=a.speed}for(var k=0;k<c;k++){d=a.x;e=a.y;this.removeBodyFromZones(a);a.x+=b.cos;a.y+=b.sin;f=this.getBodies(a);for(var l=0;l<f.length;l++){var m=f[l];if(a!==m&&!m.intersects(d,e,a.width,a.height)&&m.intersects(a)){var g=a.collide(m)===true;m=m.collide(a)===true;if(g&&m){a.x=d;a.y=e;this.addBodyToZones(a);if(a.slide&&l>=0)this.slideBody(a,b);else return}}}this.addBodyToZones(a)}};
OGE.World.prototype.slideBody=function(a,b){var c=this,d=function(f){var k=0,l=a.x+f.cos*1.9<<0;if(l!==a.x)l=a.x+(l>a.x?1:-1);f=a.y+f.sin*1.9<<0;if(f!==a.y)f=a.y+(f>a.y?1:-1);for(var m=c.getBodies(l,f,a.width,a.height),g=0;g<m.length;g++){var j=m[g];if(j!==a&&j.intersects(l,f,a.width,a.height))k+=j.intersection(l,f,a.width,a.height)}return k<<0},e=d(b.clone().rotate(-45));d=d(b.clone().rotate(45));if(e<d)this.moveBody(a,b.clone().rotate(-90),1);else e>d&&this.moveBody(a,b.clone().rotate(90),1)};
Object.construct_prototype=function(a){var b=function(){};b.prototype=a.prototype;return new b};Player=function(a,b,c,d,e){this.nick=e;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};
Player.deserialize=function(a){return _.extend(new Player(a.x,a.y,a.width,a.height,a.nick),a)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=10;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);
Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(a,b){this.world=new OGE.World(a,b,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};
Game.prototype.addBody=function(a,b){if(!this.world.addBody(a,b))return false;if(a instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=a;this.players.push(a)}else a instanceof Bomb&&this.bombs.push(a);return true};
Game.prototype.serialize=function(){var a=this,b={width:this.world.width,height:this.world.height},c=function(d,e){if(a[d].length>0){var f=a[d][0].width;b[d]={};b[d].size=f;b[d].pos=[];b[d].attrs={};_.each(a[d],function(k){b[d].pos.push(k.y/f*Math.floor(a.world.width/f)+k.x/f);_.each(e,function(l){b[d].attrs[l]=k[l]})})}};if(this.players.length>0){b.players=[];_.each(this.players,function(d){b.players.push(d.serialize())})}c("blocks",["armor"]);c("bricks");return b};
Game.prototype.removeBody=function(a){this.world.removeBody(a);this.players=_.without(this.players,a);this.bombs=_.without(this.bombs,a);this.blocks=_.without(this.blocks,a);this.bricks=_.without(this.bricks,a)};Game.prototype.getPlayer=function(a){for(var b=0;b<this.players.length;b++)if(this.players[b].nick===a)return this.players[b]};
Game.prototype.createBlocks=function(a){for(var b=1;b<this.world.height/a-2;b+=2)for(var c=1;c<this.world.width/a-2;c+=2){var d=new Box(c*a,b*a,a,a);d.armor=1;this.blocks.push(d);this.addBody(d)}return this};Game.prototype.createBricks=function(a,b){for(var c=this.world.width/a,d=this.world.height/a,e=0;e<d-1;e++)for(var f=0;f<c-1;f++)if(Math.random()*100<b&&!(f%2===1&&e%2===1))if((f>1||e>1)&&(f>1||e<d-2)&&(f<c-2||e>1)&&(f<c-2||e<d-2)){var k=new Box(f*a,e*a,a,a);this.bricks.push(k);this.addBody(k)}return this};
Game.deserialize=function(a){var b=new Game(a.width,a.height),c=function(d){if(a[d].pos.length>0){var e=a[d].size,f=Math.floor(a.width/e);_.each(a[d].pos,function(k){var l=new Box(k%f*e,Math.floor(k/f)*e,e,e);_.each(a[d].attrs,function(m,g){l[g]=a[d].attrs[g]});b[d].push(l);b.addBody(l)})}};c("blocks");c("bricks");a.players&&a.players.length>0&&_.each(a.players,function(d){b.addBody(Player.deserialize(d),true)});return b};var $infoArea,client,utils={};
utils.log=function(a){if(a.cmd&&a.result){typeof console!=="undefined"&&console!==null&&console.log(a.cmd,a);a=a.cmd+" - "+a.result}else typeof console!=="undefined"&&console!==null&&console.log(a);$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+a);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};$(function(){$infoArea=$("#infoArea");LobbyClient()});
GameClient=function(a,b){var c=a.getPlayer(b),d=$("#gamePanel"),e=$("#fpsLabel"),f=0;client.on("message",function(g){if(g.result==="OK"){var j;switch(g.cmd){case "joinGame":j=Player.deserialize(g.data.player);a.addBody(j,true);l(j);break;case "startMove":j=a.getPlayer(g.data.player);j.direction=new OGE.Direction(g.data.cos,g.data.sin);j.x=g.data.x;j.y=g.data.y;break;case "endMove":j=a.getPlayer(g.data.player);j.direction=null;j.x=g.data.x;j.y=g.data.y;break;case "logoutPlayer":j=a.getPlayer(g.data.player);
j.$img.remove();a.removeBody(j);break;case "placeBomb":g=new Bomb(g.data.x,g.data.y,16,16);m(g)}}});var k=function(g,j){var i=$("<img>").attr("src","images/"+j+".png").css("left",g.x).css("top",g.y).addClass("body");d.append(i);g.$img=i},l=function(g){k(g,"pl1");g.animate=0;g.sprite=0;g.sprites=[1,2,1,3]},m=function(g){g.animate=0;g.sprite=0;g.sprites=[1,2,3];a.addBody(g);k(g,"bomb1")};(function(){d.show();d.width(a.world.width).height(a.world.height);$.each(a.blocks,function(n,h){k(h,"block")});
$.each(a.bricks,function(n,h){k(h,"brick")});$.each(a.players,function(n,h){l(h)});$(document).keydown(function(n){var h=0,o=0,p=false;switch(n.keyCode){case 32:if(c.bombs>0){c.bombs--;p=new Bomb(Math.floor((c.x+8)/16)*16,Math.floor((c.y+8)/16)*16,16,16);p.power=c.power;m(p);client.send({cmd:"placeBomb",data:{x:p.x,y:p.y}})}p=true;break;case 37:case 65:h=-1;break;case 38:case 87:o=-1;break;case 39:case 68:h=1;break;case 40:case 83:o=1}if(h!==0||o!==0){if(f!==n.keyCode){f=n.keyCode;c.direction=new OGE.Direction(h,
o);client.send({cmd:"startMove",data:{cos:h,sin:o,x:c.x,y:c.y}})}p=true}if(p){n.stopPropagation();n.preventDefault();return false}}).keyup(function(n){if(n.keyCode===f){f=0;c.direction=null;client.send({cmd:"endMove",data:{x:c.x,y:c.y}})}}).keypress(function(n){switch(n.keyCode){case 32:case 37:case 38:case 39:case 40:n.stopPropagation();n.preventDefault();return false}});var g=(new Date).getTime(),j=0,i=50,q=0,r=function(){j=g=Math.floor(((new Date).getTime()-g)*0.9+j*0.1);if(g>50&&i>45)i--;else g<
50&&i<55&&i++;if(++q===20){e.text("Time: "+g+"("+i+")");q=0}g=(new Date).getTime();a.world.step();$.each(a.players,function(n,h){h.$img.css("left",h.x).css("top",h.y-4);if(h.direction!==null&&h.speed>0){if(h.lastDirection!==h.direction){h.animate=0;h.lastDirection=h.direction}if(--h.animate<0){h.animate=5;if(++h.sprite>=h.sprites.length)h.sprite=0;var o;if(h.direction.cos!==0)o=h.direction.cos>0?"r":"l";else if(h.direction.sin!==0)o=h.direction.sin>0?"d":"u";h.$img.attr("src","/images/p"+o+h.sprites[h.sprite]+
".png")}}});$.each(a.bombs,function(n,h){if(--h.animate<0){h.animate=5;if(++h.sprite>=h.sprites.length)h.sprite=0;h.$img.attr("src","/images/bomb"+h.sprites[h.sprite]+".png")}});setTimeout(r,i)};r()})()};
LobbyClient=function(){var a,b=$("#loginPanel"),c=$("#loginButton"),d=$("#lobbyPanel"),e=$("#nickField"),f=$("#playNowButton"),k=$("#createGameButton"),l=function(){client=new io.Socket;client.connect();client.on("connect",function(){localStorage.guid&&client.send({cmd:"authPlayer",data:{guid:a.guid}})});client.on("message",function(i){utils.log(i)})},m=function(){$.getJSON("/lobby?cmd=createGame&guid="+a.guid,function(i){utils.log(i);if(i.result==="OK"){i=Game.deserialize(i.data);new GameClient(i,
a.nick);d.hide()}})},g=function(){$.getJSON("/lobby?cmd=joinGame&guid="+a.guid,function(i){utils.log(i);if(i.result==="OK"){i=Game.deserialize(i.data);new GameClient(i,a.nick);d.hide()}})},j=function(){e.val().length>0&&$.getJSON("/lobby?cmd=loginPlayer&nick="+e.val(),function(i){utils.log(i);if(i.result==="OK"){a=i.data;localStorage.guid=a.guid;l();b.hide();d.show()}else b.children("span").text("Nick taken!");return false})};(function(){e.keypress(function(i){i.keyCode===13&&j()});c.click(function(){j()});
f.click(function(){g()});k.click(function(){m()});e.focus()})()};
