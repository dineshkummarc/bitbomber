var OGE={};OGE.Direction=function(a,b){this.cos=typeof a!="undefined"?a:0;this.sin=typeof b!="undefined"?b:0};OGE.Direction.prototype.rotate=function(a){a=a*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+a);this.sin=Math.sin(Math.asin(this.sin)+a);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(a,b){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b]===a)return;this.bodies.push(a)};OGE.Zone.prototype.removeBody=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b]===a){this.bodies.splice(b,1);break}};
OGE.Body=function(a,b,d,c){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.width=typeof d!="undefined"?d:1;this.height=typeof c!="undefined"?c:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(a){this.onCollisions.push(a)};
OGE.Body.prototype.collide=function(a){for(var b=true,d=0;d<this.onCollisions.length;d++)if(this.onCollisions[d](a)===false)b=false;return b};OGE.Body.prototype.collide=function(a){for(var b=true,d=0;d<this.onCollisions.length;d++)if(this.onCollisions[d](a)===false)b=false;return b};OGE.Body.prototype.intersects=function(a,b,d,c){var f;f=a;if(arguments.length===1){f=a.x;b=a.y;d=a.width;c=a.height}return this.x<f+d&&this.x+this.width>f&&this.y<b+c&&this.y+this.height>b};
OGE.Body.prototype.intersection=function(a,b,d,c){var f;f=a;if(arguments.length===1){f=a.x;b=a.y;d=a.width;c=a.height}return((this.x+this.width<f+d?this.x+this.width:f+d)-(this.x>f?this.x:f))*((this.y+this.height<b+c?this.y+this.width:b+c)-(this.y>b?this.y:b))};
OGE.World=function(a,b,d){this.width=typeof a!="undefined"?a:640;this.height=typeof b!="undefined"?b:480;this.zoneSize=typeof d!="undefined"?d:10;this.activeBodies=[];a=a/this.zoneSize+1<<0;b=b/this.zoneSize+1<<0;this.zones=[];for(d=0;d<a;d++){this.zones[d]=[];for(var c=0;c<b;c++)this.zones[d][c]=new OGE.Zone(d,c)}};OGE.World.prototype.addBody=function(a,b){if(this.addBodyToZones(a)!==true)return false;if(arguments.length>=2)a.active=b;a.active&&this.activeBodies.push(a);return true};
OGE.World.prototype.removeBody=function(a){this.removeBodyFromZones(a);for(var b=0;b<this.activeBodies.length;b++)if(this.activeBodies[b]===a){this.activeBodies.splice(b,1);break}};
OGE.World.prototype.getBodies=function(a,b,d,c){var f,e;f=e=a;if(arguments.length===1){e=f.x;b=f.y;d=f.width;c=f.height}e=e<0?0:e;e=e+d>this.width?this.width-d:e;b=b<0?0:b;b=b+c>this.height?this.height-c:b;f=[];e=this.getZones(e,b,d,c);for(var g=0;g<e.length;g++)for(var h=e[g].bodies,k=0;k<h.length;k++){for(var j=h[k],n=false,m=0;m<f.length;m++)if(f[m]===j){n=true;break}n||f.push(j)}return f};
OGE.World.prototype.getZones=function(a,b,d,c){var f,e;f=e=a;if(arguments.length===1){e=f.x;b=f.y;d=f.width;c=f.height}if(e>=0&&e+d-1<this.width&&b>=0&&b+c-1<this.height){f=(e+d)/this.zoneSize<<0;var g=b/this.zoneSize<<0,h=(b+c)/this.zoneSize<<0,k=0,j=[];for(e=e/this.zoneSize<<0;e<=f;e++)for(b=g;b<=h;b++)j[k++]=this.zones[e][b];return j}else return[]};
OGE.World.prototype.step=function(a){a=arguments.length===0?1:a;for(var b=0;b<a;b++)for(var d=0;d<this.activeBodies.length;d++){var c=this.activeBodies[d];c.speed>0&&c.direction!==null&&this.moveBody(c)}};OGE.World.prototype.addBodyToZones=function(a){var b=this.getZones(a);if(b.length===0)return false;for(var d=0;d<b.length;d++)b[d].addBody(a);return true};OGE.World.prototype.removeBodyFromZones=function(a){for(var b=this.getZones(a),d=0;d<b.length;d++)b[d].removeBody(a)};
OGE.World.prototype.moveBody=function(a,b,d){var c,f,e;if(arguments.length===1){b=a.direction;d=a.speed}for(var g=0;g<d;g++){c=a.x;f=a.y;this.removeBodyFromZones(a);a.x+=b.cos;a.y+=b.sin;e=this.getBodies(a);for(var h=0;h<e.length;h++){var k=e[h];if(a!==k&&!k.intersects(c,f,a.width,a.height)&&k.intersects(a)){var j=a.collide(k)===true;k=k.collide(a)===true;if(j&&k){a.x=c;a.y=f;this.addBodyToZones(a);if(a.slide&&h>=0)this.slideBody(a,b);else return}}}this.addBodyToZones(a)}};
OGE.World.prototype.slideBody=function(a,b){var d=this,c=function(e){var g=0,h=a.x+e.cos*1.9<<0;if(h!==a.x)h=a.x+(h>a.x?1:-1);e=a.y+e.sin*1.9<<0;if(e!==a.y)e=a.y+(e>a.y?1:-1);for(var k=d.getBodies(h,e,a.width,a.height),j=0;j<k.length;j++){var n=k[j];if(n!==a&&n.intersects(h,e,a.width,a.height))g+=n.intersection(h,e,a.width,a.height)}return g<<0},f=c(b.clone().rotate(-45));c=c(b.clone().rotate(45));if(f<c)this.moveBody(a,b.clone().rotate(-90),1);else f>c&&this.moveBody(a,b.clone().rotate(90),1)};
Object.construct_prototype=function(a){var b=function(){};b.prototype=a.prototype;return new b};Player=function(a,b,d,c,f){this.nick=f;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.power=this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);
Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};Player.deserialize=function(a){return _.extend(new Player(a.x,a.y,a.width,a.height,a.nick),a)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=4;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);
Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(a,b){this.world=new OGE.World(a,b,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};
Game.prototype.getBomb=function(a,b){for(var d=0;d<this.bombs.length;d++)if(this.bombs[d].x===a&&this.bombs[d].y===b)return this.bombs[d];return null};Game.prototype.removeBoxes=function(a,b){var d=this;_.each(b.bodies,function(c){c instanceof Box&&c.armor===a.power&&d.removeBody(c)})};
Game.prototype.explodeBomb=function(a,b){if(arguments.length===1)b={x:a.x,y:a.y,bodies:[],fires:[]};var d=a.size*a.width,c=a.size*a.height,f=this;this.removeBody(a);var e=function(h,k,j){b.fires[h]||(b.fires[h]=[]);b.fires[h][k]||(b.fires[h][k]=j)};e(a.x,a.y,"c");var g=function(h,k,j,n,m){for(h=a.x+h;h<=a.x+j;h+=a.width)for(var l=a.y+k;l<=a.y+n;l+=a.height)if(h>=0&&l>=0&&h<f.world.width&&l<f.world.height)for(var i=f.world.getBodies(h,l,a.width,a.height),q=0;q<i.length;q++){var o=i[q];if(o!==a&&o.intersects(h,
l,a.width,a.height)){_.contains(b.bodies,o)||b.bodies.push(o);if(o.armor>=a.power){if(b.fires[h]&&b.fires[h][l])b.fires[h][l]=null;return}else f.removeBody(o);o instanceof Bomb&&f.explodeBomb(o,b)}e(h,l,m)}};g(-d,0,-a.width,0,"l");g(+a.width,0,+d,0,"r");g(0,-c,0,-a.height,"u");g(0,+a.height,0,+c,"d");return b};
Game.prototype.addBody=function(a,b){if(!this.world.addBody(a,b))return false;if(a instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=a;this.players.push(a)}else a instanceof Bomb&&this.bombs.push(a);return true};
Game.prototype.serialize=function(){var a=this,b={width:this.world.width,height:this.world.height},d=function(c,f){if(a[c].length>0){var e=a[c][0].width;b[c]={};b[c].size=e;b[c].pos=[];b[c].attrs={};_.each(a[c],function(g){b[c].pos.push(g.y/e*Math.floor(a.world.width/e)+g.x/e);_.each(f,function(h){b[c].attrs[h]=g[h]})})}};if(this.players.length>0){b.players=[];_.each(this.players,function(c){b.players.push(c.serialize())})}d("blocks",["armor"]);d("bricks");return b};
Game.prototype.removeBody=function(a){this.world.removeBody(a);this.players=_.without(this.players,a);this.bombs=_.without(this.bombs,a);this.blocks=_.without(this.blocks,a);this.bricks=_.without(this.bricks,a)};Game.prototype.getPlayer=function(a){for(var b=0;b<this.players.length;b++)if(this.players[b].nick===a)return this.players[b]};
Game.prototype.createBlocks=function(a){for(var b=1;b<this.world.height/a-2;b+=2)for(var d=1;d<this.world.width/a-2;d+=2){var c=new Box(d*a,b*a,a,a);c.armor=2;this.blocks.push(c);this.addBody(c)}return this};Game.prototype.createBricks=function(a,b){for(var d=this.world.width/a,c=this.world.height/a,f=0;f<c-1;f++)for(var e=0;e<d-1;e++)if(Math.random()*100<b&&!(e%2===1&&f%2===1))if((e>1||f>1)&&(e>1||f<c-2)&&(e<d-2||f>1)&&(e<d-2||f<c-2)){var g=new Box(e*a,f*a,a,a);this.bricks.push(g);this.addBody(g)}return this};
Game.deserialize=function(a){var b=new Game(a.width,a.height),d=function(c){if(a[c].pos.length>0){var f=a[c].size,e=Math.floor(a.width/f);_.each(a[c].pos,function(g){var h=new Box(g%e*f,Math.floor(g/e)*f,f,f);_.each(a[c].attrs,function(k,j){h[j]=a[c].attrs[j]});b[c].push(h);b.addBody(h)})}};d("blocks");d("bricks");a.players&&a.players.length>0&&_.each(a.players,function(c){b.addBody(Player.deserialize(c),true)});return b};var $infoArea,utils={};
utils.log=function(a,b){if(arguments.length===1){b=a;a=b.cmd}typeof console!=="undefined"&&console!==null&&console.log(a,b);b=a+" - "+b.result;$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+b);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};$(function(){$infoArea=$("#infoArea");var a=new HttpClient,b=new SocketClient,d=new GameHandler(c,b),c=new LobbyHandler(d,a,b);new GamePanel(d);new LobbyPanel(c)});
LobbyHandler=function(a,b,d){b=new HttpClient(this);var c;this.createGame=function(f){b.createGame(function(e){if(e.result==="OK"){e=Game.deserialize(e.data);a.startGame(e,c.nick);f(true)}else f(fale)})};this.playNow=function(f){b.playNow(function(e){if(e.result==="OK"){e=Game.deserialize(e.data);a.startGame(e,c.nick);f(true)}else f(false)})};this.login=function(f,e){b.login(f,function(g){if(g.result==="OK"){c=g.data;d.send("authPlayer",{guid:c.guid});e(true)}else e(false)})}};
HttpClient=function(){var a;this.createGame=function(b){$.getJSON("/lobby?cmd=createGame&guid="+a.guid,function(d){utils.log("createGame",d);b(d)})};this.playNow=function(b){$.getJSON("/lobby?cmd=joinGame&guid="+a.guid,function(d){utils.log("playNow",d);b(d)})};this.login=function(b,d){$.getJSON("/lobby?cmd=loginPlayer&nick="+b,function(c){utils.log("loginPlayer",c);if(c.result==="OK")a=c.data;d(c)})}};
LobbyPanel=function(a){var b=$("#loginPanel"),d=$("#loginButton"),c=$("#lobbyPanel"),f=$("#nickField"),e=$("#playNowButton"),g=$("#createGameButton"),h=function(){a.createGame(function(n){n&&c.hide()})},k=function(){a.playNow(function(){c.hide()})},j=function(){f.val().length>0&&a.login(f.val(),function(n){if(n){b.hide();c.show()}else{f.focus();b.children("span").text("Nick taken!")}})};(function(){f.keypress(function(n){if(n.keyCode===13){f.blur();j()}});d.click(function(){j()});e.click(function(){k()});
g.click(function(){h()});f.focus()})()};
GameHandler=function(a,b){var d,c,f;listeners={};this.addListener=function(e,g){if(typeof listeners[e]==="undefined")listeners[e]=[];listeners[e].push(g)};this.removeBody=function(e){d.removeBody(e)};this.startGame=function(e,g){d=e;c=d.getPlayer(g);f=new FactorialTimer;f.start(function(h){d.world.step();_.each(listeners.step,function(k){k(h)})});_.each(listeners.startGame,function(h){h(d)})};this.startMove=function(e,g){if(!c.dead){c.direction=new OGE.Direction(e,g);b.send("startMove",{cos:e,sin:g,
x:c.x,y:c.y})}};this.endMove=function(){if(!c.dead){c.direction=null;b.send("endMove",{x:c.x,y:c.y})}};this.placeBomb=function(){if(!c.dead)if(c.bombs>0){c.bombs--;var e=new Bomb(Math.floor((c.x+8)/16)*16,Math.floor((c.y+8)/16)*16,16,16);d.addBody(e);e.power=c.power;b.send("placeBomb",{x:e.x,y:e.y});return e}};b.addListener("joinGame",function(e,g){p=Player.deserialize(g.player);d.addBody(p,true);_.each(listeners.addPlayer,function(h){h(p)})});b.addListener("startMove",function(e,g){p=d.getPlayer(g.player);
p.direction=new OGE.Direction(g.cos,g.sin);p.x=g.x;p.y=g.y});b.addListener("endMove",function(e,g){p=d.getPlayer(g.player);p.direction=null;p.x=g.x;p.y=g.y});b.addListener("logoutPlayer",function(e,g){p=d.getPlayer(g.player);p.$img.remove();d.removeBody(p)});b.addListener("placeBomb",function(e,g){var h=new Bomb(g.x,g.y,16,16);d.addBody(h);_.each(listeners.placeBomb,function(k){k(h)})});b.addListener("explodeBomb",function(e,g){var h=d.getBomb(g.x,g.y);d.getPlayer(g.player).bombs++;if(h!==null){g=
d.explodeBomb(h);if(_.include(g.bodies,c)){_.each(listeners.meDead,function(){});c.x=0;c.y=0;b.send("playerDead",{})}_.each(listeners.explodeBomb,function(k){k(h,g)})}});b.addListener("playerDead",function(e,g){var h=d.getPlayer(g.player);h.x=0;h.y=0;_.each(listeners.playerDead,function(){})});b.addListener("resurectPlayer",function(e,g){var h=d.getPlayer(g.player);d.addBody(h);_.each(listeners.resurectPlayer,function(k){k(h)})})};
SocketClient=function(){var a=new io.Socket,b={};this.addListener=function(d,c){if(typeof b[d]==="undefined")b[d]=[];b[d].push(c)};this.send=function(d,c){a.send({cmd:d,data:c})};a.connect();a.on("message",function(d){utils.log(d);_.each(b[d.cmd],function(c){c(d.result,d.data)})})};
GamePanel=function(a){var b=$("#gamePanel"),d=$("#fpsLabel"),c,f=[],e=[];a.addListener("startGame",function(j){c=new KeyboardHandler;b.find("*").remove();b.show();b.width(j.world.width).height(j.world.height);$.each(j.blocks,function(m,l){g(l,"block")});$.each(j.bricks,function(m,l){g(l,"brick")});$.each(j.players,function(m,l){h(l)});c.keydown(function(m){var l=0,i=0;switch(m){case "space":(m=a.placeBomb())&&k(m);break;case "left":l=-1;break;case "up":i=-1;break;case "right":l=1;break;case "down":i=
1}if(l!==0||i!==0)a.startMove(l,i)}).keyup(function(){a.endMove()});var n=0;a.addListener("step",function(m){if(++n===20){d.text("Time: "+m);n=0}$.each(j.players,function(l,i){i.$img.css("left",i.x).css("top",i.y-4);if(i.direction!==null&&i.speed>0){if(i.lastDirection!==i.direction){i.animate=0;i.lastDirection=i.direction}if(--i.animate<0){i.animate=5;if(++i.sprite>=i.sprites.length)i.sprite=0;var q;if(i.direction.cos!==0)q=i.direction.cos>0?"r":"l";else if(i.direction.sin!==0)q=i.direction.sin>0?
"d":"u";i.$img.attr("src","/images/p"+q+i.sprites[i.sprite]+".png")}}});$.each(j.bombs,function(l,i){if(--i.animate<0){i.animate=5;if(++i.sprite>=i.sprites.length)i.sprite=0;i.$img.attr("src","/images/bomb"+i.sprites[i.sprite]+".png")}});$.each(f,function(l,i){if(--i.animate<0){i.animate=5;if(++i.sprite>4){_.without(f,i);i.$img.remove()}else i.$img.attr("src","/images/f"+i.f+i.sprite+".png")}});$.each(e,function(l,i){if(--i.animate<0){i.animate=5;if(++i.sprite>2){_.without(e,i);a.removeBody(i);i.$img.remove()}else i.$img.attr("src",
"/images/fb"+i.sprite+".png")}})});a.addListener("explodeBomb",function(m,l){m.$img.remove();for(var i=0;i<l.fires.length;i++)if(l.fires[i])for(var q=0;q<l.fires[i].length;q++)if(l.fires[i][q]){var o=l.fires[i][q];if(o==="l"||o==="r")o="h";else if(o==="u"||o==="d")o="v";var s=$("<img>").attr("src","images/f"+o+"1.png").css("left",i).css("top",q).addClass("body");f.push({f:o,animate:5,sprite:1,$img:s});b.append(s)}_.each(l.bodies,function(r){if(r instanceof Box&&r.armor===m.power){r.animate=0;r.sprite=
0;e.push(r)}})})});a.addListener("addPlayer",function(j){h(j)});a.addListener("placeBomb",function(j){k(j)});a.addListener("meDead",function(j){j.$img.remove()});a.addListener("playerDead",function(j){j.$img.remove()});a.addListener("resurectPlayer",function(j){b.append(j.$img)});var g=function(j,n){var m=$("<img>").attr("src","images/"+n+".png").css("left",j.x).css("top",j.y).addClass("body");b.append(m);return j.$img=m},h=function(j){g(j,"pl1").addClass("player");j.animate=0;j.sprite=0;j.sprites=
[1,2,1,3]},k=function(j){j.animate=0;j.sprite=0;j.sprites=[1,2,3];g(j,"bomb1")}};
KeyboardHandler=function(){var a,b,d;this.keydown=function(c){b=c;return this};this.keyup=function(c){d=c;return this};$(document).keydown(function(c){var f=null;switch(c.keyCode){case 32:f="space";break;case 37:case 65:f="left";break;case 38:case 87:f="up";break;case 39:case 68:f="right";break;case 40:case 83:f="down"}if(f!==null){if(a!==c.keyCode){a=c.keyCode;b(f)}c.stopPropagation();c.preventDefault();return false}}).keyup(function(c){if(c.keyCode===a){a=0;d()}}).keypress(function(c){switch(c.keyCode){case 32:case 37:case 38:case 39:case 40:c.stopPropagation();
c.preventDefault();return false}})};FactorialTimer=function(){var a=(new Date).getTime(),b=0,d=50,c;this.start=function(e){c=e;f()};var f=function(){b=a=Math.floor(((new Date).getTime()-a)*0.9+b*0.1);if(a>50&&d>45)d--;else a<50&&d<55&&d++;c(a);a=(new Date).getTime();setTimeout(f,d)}};
