(function(){var b=this,c=b._,g={},f=Array.prototype,k=Object.prototype,i=f.slice,m=f.unshift,n=k.toString,o=k.hasOwnProperty,r=f.forEach,w=f.map,l=f.reduce,x=f.reduceRight,u=f.filter,z=f.every,v=f.some,A=f.indexOf,t=f.lastIndexOf;k=Array.isArray;var C=Object.keys,e=function(a){return new D(a)};if(typeof module!=="undefined"&&module.exports){module.exports=e;e._=e}else b._=e;e.VERSION="1.1.4";var B=e.each=e.forEach=function(a,d,h){if(a!=null)if(r&&a.forEach===r)a.forEach(d,h);else if(e.isNumber(a.length))for(var j=
0,q=a.length;j<q;j++){if(d.call(h,a[j],j,a)===g)break}else for(j in a)if(o.call(a,j))if(d.call(h,a[j],j,a)===g)break};e.map=function(a,d,h){var j=[];if(a==null)return j;if(w&&a.map===w)return a.map(d,h);B(a,function(q,s,y){j[j.length]=d.call(h,q,s,y)});return j};e.reduce=e.foldl=e.inject=function(a,d,h,j){var q=h!==void 0;if(a==null)a=[];if(l&&a.reduce===l){if(j)d=e.bind(d,j);return q?a.reduce(d,h):a.reduce(d)}B(a,function(s,y,H){if(!q&&y===0){h=s;q=true}else h=d.call(j,h,s,y,H)});if(!q)throw new TypeError("Reduce of empty array with no initial value");
return h};e.reduceRight=e.foldr=function(a,d,h,j){if(a==null)a=[];if(x&&a.reduceRight===x){if(j)d=e.bind(d,j);return h!==void 0?a.reduceRight(d,h):a.reduceRight(d)}a=(e.isArray(a)?a.slice():e.toArray(a)).reverse();return e.reduce(a,d,h,j)};e.find=e.detect=function(a,d,h){var j;F(a,function(q,s,y){if(d.call(h,q,s,y)){j=q;return true}});return j};e.filter=e.select=function(a,d,h){var j=[];if(a==null)return j;if(u&&a.filter===u)return a.filter(d,h);B(a,function(q,s,y){if(d.call(h,q,s,y))j[j.length]=
q});return j};e.reject=function(a,d,h){var j=[];if(a==null)return j;B(a,function(q,s,y){d.call(h,q,s,y)||(j[j.length]=q)});return j};e.every=e.all=function(a,d,h){d=d||e.identity;var j=true;if(a==null)return j;if(z&&a.every===z)return a.every(d,h);B(a,function(q,s,y){if(!(j=j&&d.call(h,q,s,y)))return g});return j};var F=e.some=e.any=function(a,d,h){d=d||e.identity;var j=false;if(a==null)return j;if(v&&a.some===v)return a.some(d,h);B(a,function(q,s,y){if(j=d.call(h,q,s,y))return g});return j};e.include=
e.contains=function(a,d){var h=false;if(a==null)return h;if(A&&a.indexOf===A)return a.indexOf(d)!=-1;F(a,function(j){if(h=j===d)return true});return h};e.invoke=function(a,d){var h=i.call(arguments,2);return e.map(a,function(j){return(d?j[d]:j).apply(j,h)})};e.pluck=function(a,d){return e.map(a,function(h){return h[d]})};e.max=function(a,d,h){if(!d&&e.isArray(a))return Math.max.apply(Math,a);var j={computed:-Infinity};B(a,function(q,s,y){s=d?d.call(h,q,s,y):q;s>=j.computed&&(j={value:q,computed:s})});
return j.value};e.min=function(a,d,h){if(!d&&e.isArray(a))return Math.min.apply(Math,a);var j={computed:Infinity};B(a,function(q,s,y){s=d?d.call(h,q,s,y):q;s<j.computed&&(j={value:q,computed:s})});return j.value};e.sortBy=function(a,d,h){return e.pluck(e.map(a,function(j,q,s){return{value:j,criteria:d.call(h,j,q,s)}}).sort(function(j,q){var s=j.criteria,y=q.criteria;return s<y?-1:s>y?1:0}),"value")};e.sortedIndex=function(a,d,h){h=h||e.identity;for(var j=0,q=a.length;j<q;){var s=j+q>>1;h(a[s])<h(d)?
j=s+1:q=s}return j};e.toArray=function(a){if(!a)return[];if(a.toArray)return a.toArray();if(e.isArray(a))return a;if(e.isArguments(a))return i.call(a);return e.values(a)};e.size=function(a){return e.toArray(a).length};e.first=e.head=function(a,d,h){return d!=null&&!h?i.call(a,0,d):a[0]};e.rest=e.tail=function(a,d,h){return i.call(a,d==null||h?1:d)};e.last=function(a){return a[a.length-1]};e.compact=function(a){return e.filter(a,function(d){return!!d})};e.flatten=function(a){return e.reduce(a,function(d,
h){if(e.isArray(h))return d.concat(e.flatten(h));d[d.length]=h;return d},[])};e.without=function(a){var d=i.call(arguments,1);return e.filter(a,function(h){return!e.include(d,h)})};e.uniq=e.unique=function(a,d){return e.reduce(a,function(h,j,q){if(0==q||(d===true?e.last(h)!=j:!e.include(h,j)))h[h.length]=j;return h},[])};e.intersect=function(a){var d=i.call(arguments,1);return e.filter(e.uniq(a),function(h){return e.every(d,function(j){return e.indexOf(j,h)>=0})})};e.zip=function(){for(var a=i.call(arguments),
d=e.max(e.pluck(a,"length")),h=Array(d),j=0;j<d;j++)h[j]=e.pluck(a,""+j);return h};e.indexOf=function(a,d,h){if(a==null)return-1;var j;if(h){h=e.sortedIndex(a,d);return a[h]===d?h:-1}if(A&&a.indexOf===A)return a.indexOf(d);h=0;for(j=a.length;h<j;h++)if(a[h]===d)return h;return-1};e.lastIndexOf=function(a,d){if(a==null)return-1;if(t&&a.lastIndexOf===t)return a.lastIndexOf(d);for(var h=a.length;h--;)if(a[h]===d)return h;return-1};e.range=function(a,d,h){if(arguments.length<=1){d=a||0;a=0}h=arguments[2]||
1;for(var j=Math.max(Math.ceil((d-a)/h),0),q=0,s=Array(j);q<j;){s[q++]=a;a+=h}return s};e.bind=function(a,d){var h=i.call(arguments,2);return function(){return a.apply(d||{},h.concat(i.call(arguments)))}};e.bindAll=function(a){var d=i.call(arguments,1);if(d.length==0)d=e.functions(a);B(d,function(h){a[h]=e.bind(a[h],a)});return a};e.memoize=function(a,d){var h={};d=d||e.identity;return function(){var j=d.apply(this,arguments);return o.call(h,j)?h[j]:h[j]=a.apply(this,arguments)}};e.delay=function(a,
d){var h=i.call(arguments,2);return setTimeout(function(){return a.apply(a,h)},d)};e.defer=function(a){return e.delay.apply(e,[a,1].concat(i.call(arguments,1)))};var G=function(a,d,h){var j;return function(){var q=this,s=arguments,y=function(){j=null;a.apply(q,s)};h&&clearTimeout(j);if(h||!j)j=setTimeout(y,d)}};e.throttle=function(a,d){return G(a,d,false)};e.debounce=function(a,d){return G(a,d,true)};e.wrap=function(a,d){return function(){var h=[a].concat(i.call(arguments));return d.apply(this,h)}};
e.compose=function(){var a=i.call(arguments);return function(){for(var d=i.call(arguments),h=a.length-1;h>=0;h--)d=[a[h].apply(this,d)];return d[0]}};e.keys=C||function(a){var d=[],h;for(h in a)if(o.call(a,h))d[d.length]=h;return d};e.values=function(a){return e.map(a,e.identity)};e.functions=e.methods=function(a){return e.filter(e.keys(a),function(d){return e.isFunction(a[d])}).sort()};e.extend=function(a){B(i.call(arguments,1),function(d){for(var h in d)a[h]=d[h]});return a};e.clone=function(a){return e.isArray(a)?
a.slice():e.extend({},a)};e.tap=function(a,d){d(a);return a};e.isEqual=function(a,d){if(a===d)return true;var h=typeof a;if(h!=typeof d)return false;if(a==d)return true;if(!a&&d||a&&!d)return false;if(a._chain)a=a._wrapped;if(d._chain)d=d._wrapped;if(a.isEqual)return a.isEqual(d);if(e.isDate(a)&&e.isDate(d))return a.getTime()===d.getTime();if(e.isNaN(a)&&e.isNaN(d))return false;if(e.isRegExp(a)&&e.isRegExp(d))return a.source===d.source&&a.global===d.global&&a.ignoreCase===d.ignoreCase&&a.multiline===
d.multiline;if(h!=="object")return false;if(a.length&&a.length!==d.length)return false;h=e.keys(a);var j=e.keys(d);if(h.length!=j.length)return false;for(var q in a)if(!(q in d)||!e.isEqual(a[q],d[q]))return false;return true};e.isEmpty=function(a){if(e.isArray(a)||e.isString(a))return a.length===0;for(var d in a)if(o.call(a,d))return false;return true};e.isElement=function(a){return!!(a&&a.nodeType==1)};e.isArray=k||function(a){return n.call(a)==="[object Array]"};e.isArguments=function(a){return!!(a&&
o.call(a,"callee"))};e.isFunction=function(a){return!!(a&&a.constructor&&a.call&&a.apply)};e.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};e.isNumber=function(a){return!!(a===0||a&&a.toExponential&&a.toFixed)};e.isNaN=function(a){return a!==a};e.isBoolean=function(a){return a===true||a===false};e.isDate=function(a){return!!(a&&a.getTimezoneOffset&&a.setUTCFullYear)};e.isRegExp=function(a){return!!(a&&a.test&&a.exec&&(a.ignoreCase||a.ignoreCase===false))};e.isNull=function(a){return a===
null};e.isUndefined=function(a){return a===void 0};e.noConflict=function(){b._=c;return this};e.identity=function(a){return a};e.times=function(a,d,h){for(var j=0;j<a;j++)d.call(h,j)};e.mixin=function(a){B(e.functions(a),function(d){I(d,e[d]=a[d])})};var J=0;e.uniqueId=function(a){var d=J++;return a?a+d:d};e.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g};e.template=function(a,d){var h=e.templateSettings;h="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+
a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(h.interpolate,function(j,q){return"',"+q.replace(/\\'/g,"'")+",'"}).replace(h.evaluate||null,function(j,q){return"');"+q.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');";h=new Function("obj",h);return d?h(d):h};var D=function(a){this._wrapped=a};e.prototype=D.prototype;var E=function(a,d){return d?e(a).chain():a},I=function(a,d){D.prototype[a]=function(){var h=
i.call(arguments);m.call(h,this._wrapped);return E(d.apply(e,h),this._chain)}};e.mixin(e);B(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var d=f[a];D.prototype[a]=function(){d.apply(this._wrapped,arguments);return E(this._wrapped,this._chain)}});B(["concat","join","slice"],function(a){var d=f[a];D.prototype[a]=function(){return E(d.apply(this._wrapped,arguments),this._chain)}});D.prototype.chain=function(){this._chain=true;return this};D.prototype.value=function(){return this._wrapped}})();
var OGE={version:0.6};OGE.Direction=function(b,c){this.cos=typeof b!="undefined"?b:0;this.sin=typeof c!="undefined"?c:0};OGE.Direction.prototype.rotate=function(b){b=b*(Math.PI/180);this.cos=Math.cos(Math.acos(this.cos)+b);this.sin=Math.sin(Math.asin(this.sin)+b);return this};OGE.Direction.prototype.clone=function(){return new OGE.Direction(this.cos,this.sin)};OGE.Zone=function(b,c){this.x=typeof b!="undefined"?b:0;this.y=typeof c!="undefined"?c:0;this.bodies=[]};
OGE.Zone.prototype.addBody=function(b){for(var c=0;c<this.bodies.length;c++)if(this.bodies[c]===b)return;this.bodies.push(b)};OGE.Zone.prototype.removeBody=function(b){for(var c=0;c<this.bodies.length;c++)if(this.bodies[c]===b){this.bodies.splice(c,1);break}};
OGE.Body=function(b,c,g,f){this.x=typeof b!="undefined"?b:0;this.y=typeof c!="undefined"?c:0;this.width=typeof g!="undefined"?g:1;this.height=typeof f!="undefined"?f:1;this.speed=0;this.direction=null;this.active=this.slide=false;this.onCollisions=[]};OGE.Body.prototype.clearEvents=function(){this.onCollisions=[]};OGE.Body.prototype.onCollision=function(b){this.onCollisions.push(b)};
OGE.Body.prototype.collide=function(b){for(var c=true,g=0;g<this.onCollisions.length;g++)if(this.onCollisions[g](b)===false)c=false;return c};OGE.Body.prototype.collide=function(b){for(var c=true,g=0;g<this.onCollisions.length;g++)if(this.onCollisions[g](b)===false)c=false;return c};OGE.Body.prototype.intersects=function(b,c,g,f){var k;k=b;if(arguments.length===1){k=b.x;c=b.y;g=b.width;f=b.height}return this.x<k+g&&this.x+this.width>k&&this.y<c+f&&this.y+this.height>c};
OGE.Body.prototype.intersection=function(b,c,g,f){var k;k=b;if(arguments.length===1){k=b.x;c=b.y;g=b.width;f=b.height}return((this.x+this.width<k+g?this.x+this.width:k+g)-(this.x>k?this.x:k))*((this.y+this.height<c+f?this.y+this.width:c+f)-(this.y>c?this.y:c))};
OGE.World=function(b,c,g){this.width=typeof b!="undefined"?b:640;this.height=typeof c!="undefined"?c:480;this.zoneSize=typeof g!="undefined"?g:10;this.activeBodies=[];b=b/this.zoneSize+1<<0;c=c/this.zoneSize+1<<0;this.zones=[];for(g=0;g<b;g++){this.zones[g]=[];for(var f=0;f<c;f++)this.zones[g][f]=new OGE.Zone(g,f)}};OGE.World.prototype.addBody=function(b,c){if(this.addBodyToZones(b)!==true)return false;if(arguments.length>=2)b.active=c;b.active&&this.activeBodies.push(b);return true};
OGE.World.prototype.removeBody=function(b){this.removeBodyFromZones(b);for(var c=0;c<this.activeBodies.length;c++)if(this.activeBodies[c]===b){this.activeBodies.splice(c,1);break}};
OGE.World.prototype.getBodies=function(b,c,g,f){var k,i;k=i=b;if(arguments.length===1){i=k.x;c=k.y;g=k.width;f=k.height}i=i<0?0:i;i=i+g>this.width?this.width-g:i;c=c<0?0:c;c=c+f>this.height?this.height-f:c;k=[];i=this.getZones(i,c,g,f);for(var m=0;m<i.length;m++)for(var n=i[m].bodies,o=0;o<n.length;o++){for(var r=n[o],w=false,l=0;l<k.length;l++)if(k[l]===r){w=true;break}w||k.push(r)}return k};
OGE.World.prototype.getZones=function(b,c,g,f){var k,i;k=i=b;if(arguments.length===1){i=k.x;c=k.y;g=k.width;f=k.height}if(i>=0&&i+g-1<this.width&&c>=0&&c+f-1<this.height){k=(i+g)/this.zoneSize<<0;var m=c/this.zoneSize<<0,n=(c+f)/this.zoneSize<<0,o=0,r=[];for(i=i/this.zoneSize<<0;i<=k;i++)for(c=m;c<=n;c++)r[o++]=this.zones[i][c];return r}else return[]};
OGE.World.prototype.step=function(b){b=arguments.length===0?1:b;for(var c=0;c<b;c++)for(var g=0;g<this.activeBodies.length;g++){var f=this.activeBodies[g];f.speed>0&&f.direction!==null&&this.moveBody(f)}};OGE.World.prototype.addBodyToZones=function(b){var c=this.getZones(b);if(c.length===0)return false;for(var g=0;g<c.length;g++)c[g].addBody(b);return true};OGE.World.prototype.removeBodyFromZones=function(b){for(var c=this.getZones(b),g=0;g<c.length;g++)c[g].removeBody(b)};
OGE.World.prototype.moveBody=function(b,c,g){var f,k,i;if(arguments.length===1){c=b.direction;g=b.speed}for(var m=0;m<g;m++){f=b.x;k=b.y;this.removeBodyFromZones(b);b.x+=c.cos;b.y+=c.sin;if(b.x>=0&&b.y>=0&&b.x+b.width<=this.width&&b.y+b.height<=this.height){i=this.getBodies(b);for(var n=0;n<i.length;n++){var o=i[n];if(b!==o&&!o.intersects(f,k,b.width,b.height)&&o.intersects(b)){var r=b.collide(o)===true;o=o.collide(b)===true;if(r&&o){b.x=f;b.y=k;this.addBodyToZones(b);if(b.slide&&n>=0)this.slideBody(b,
c);else return}}}this.addBodyToZones(b)}else{b.x=f;b.y=k;break}}};
OGE.World.prototype.slideBody=function(b,c){var g=this,f=function(i){var m=[],n=g.getBodies(b),o,r,w,l,x,u;for(r=0;r<n.length;r++){x=n[r];x!==b&&x.intersects(b)&&m.push(x)}o=0;w=b.x+i.cos*1.9<<0;if(w!==b.x)w=b.x+(w>b.x?1:-1);l=b.y+i.sin*1.9<<0;if(l!==b.y)l=b.y+(l>b.y?1:-1);n=g.getBodies(w,l,b.width,b.height);for(r=0;r<n.length;r++){x=n[r];if(x!==b&&x.intersects(w,l,b.width,b.height)){u=false;for(i=0;i<m.length;i++)if(x===m[i]){u=true;break}u||(o+=x.intersection(w,l,b.width,b.height))}}return o<<0},
k=f(c.clone().rotate(-45));f=f(c.clone().rotate(45));if(k<f)this.moveBody(b,c.clone().rotate(-90),1);else k>f&&this.moveBody(b,c.clone().rotate(90),1)};Object.construct_prototype=function(b){var c=function(){};c.prototype=b.prototype;return new c};Player=function(b,c,g,f,k){this.nick=k;if(arguments.length===1)this.nick=arguments[0];OGE.Body.apply(this,arguments);this.speed=3;this.slide=true;this.bombPower=this.bombSize=1;this.life=3;this.armor=0;this.power=this.bombs=1};Player.prototype=Object.construct_prototype(OGE.Body);
Player.prototype.serialize=function(){return{nick:this.nick,x:this.x,y:this.y,width:this.width,height:this.height,speed:this.speed,armor:this.armor}};Player.deserialize=function(b){return _.extend(new Player(b.x,b.y,b.width,b.height,b.nick),b)};Box=function(){OGE.Body.apply(this,arguments);this.armor=1};Box.prototype=Object.construct_prototype(OGE.Body);Bomb=function(){OGE.Body.apply(this,arguments);this.size=1;this.timer=4;this.power=1};Bomb.prototype=Object.construct_prototype(OGE.Body);
Fire=function(){OGE.Body.apply(this,arguments);this.timer=10;this.power=1};Fire.prototype=Object.construct_prototype(OGE.Body);Powerup=function(){OGE.Body.apply(this,arguments)};Powerup.prototype=Object.construct_prototype(OGE.Body);Game=function(b,c){this.world=new OGE.World(b,c,16);this.players=[];this.bombs=[];this.fires=[];this.blocks=[];this.bricks=[];this.maxPlayers=4};Game.version=0.7;
Game.prototype.getBomb=function(b,c){for(var g=0;g<this.bombs.length;g++)if(this.bombs[g].x===b&&this.bombs[g].y===c)return this.bombs[g];return null};Game.prototype.removeBodies=function(b,c){var g=this;_.each(b,function(f){f instanceof c&&g.removeBody(f)})};
Game.prototype.explodeBomb=function(b,c){if(arguments.length===1)c={x:b.x,y:b.y,bodies:[],fires:[],bombs:[]};var g=this,f=function(i,m,n){var o=function(r){return r.x===i&&r.y===m};if(typeof _.detect(c.bodies,o)==="undefined"){n={x:i,y:m,firevar:n};o=_.detect(c.fires,o);if(typeof o!=="undefined"){if(o.firevar!=="c"&&_.contains("c","v","h",n.firevar)){c.fires=_.without(c.fires,o);c.fires.push(n)}}else c.fires.push(n)}};c.bombs.push(b);f(b.x,b.y,"c");var k=function(i,m,n,o){i=i*b.width;var r=b.x+i,
w=b.x+b.size*i;m=m*b.height;var l=b.y+m,x=b.y+b.size*m;actualCheck=function(u,z,v){if(u>=0&&z>=0&&u<g.world.width&&z<g.world.height){for(var A=g.world.getBodies(u,z,b.width,b.height),t=0;t<A.length;t++){var C=A[t];if(C!==b&&C.intersects(u+2,z+2,b.width-2,b.height-2)){if(C.armor>b.power)return false;else{!(C instanceof Bomb)&&!_.contains(c.bodies,C)&&c.bodies.push(C);if(C.armor===b.power)return false}C instanceof Bomb&&!_.contains(c.bombs,C)&&g.explodeBomb(C,c)}}f(u,z,v)}return true};for(r=r;r!==w+
i;r+=i)if(!actualCheck(r,b.y,r!==w?n:o))break;for(i=l;i!==x+m;i+=m)if(!actualCheck(b.x,i,i!==x?n:o))break};k(-1,0,"h","l");k(1,0,"h","r");k(0,-1,"v","u");k(0,1,"v","d");return c};Game.prototype.addBody=function(b,c){if(!this.world.addBody(b,c))return false;if(b instanceof Player){if(this.players.length==this.maxPlayers)return false;else if(this.players.length===0)this.owner=b;this.players.push(b)}else b instanceof Bomb&&this.bombs.push(b);return true};
Game.prototype.serialize=function(){var b=this,c={width:this.world.width,height:this.world.height,guid:this.guid},g=function(f,k){if(b[f].length>0){var i=b[f][0].width;c[f]={};c[f].size=i;c[f].pos=[];c[f].attrs={};_.each(b[f],function(m){c[f].pos.push(m.y/i*Math.floor(b.world.width/i)+m.x/i);_.each(k,function(n){c[f].attrs[n]=m[n]})})}};if(this.players.length>0){c.players=[];_.each(this.players,function(f){c.players.push(f.serialize())})}g("blocks",["armor"]);g("bricks");return c};
Game.prototype.removeBody=function(b){this.world.removeBody(b);this.players=_.without(this.players,b);this.bombs=_.without(this.bombs,b);this.blocks=_.without(this.blocks,b);this.bricks=_.without(this.bricks,b)};Game.prototype.getPlayer=function(b){for(var c=0;c<this.players.length;c++)if(this.players[c].nick===b)return this.players[c]};
Game.prototype.createBlocks=function(b){for(var c=1;c<this.world.height/b-2;c+=2)for(var g=1;g<this.world.width/b-2;g+=2){var f=new Box(g*b,c*b,b,b);f.armor=2;this.blocks.push(f);this.addBody(f)}return this};Game.prototype.createBricks=function(b,c){for(var g=this.world.width/b,f=this.world.height/b,k=0;k<f-1;k++)for(var i=0;i<g-1;i++)if(Math.random()*100<c&&!(i%2===1&&k%2===1))if((i>1||k>1)&&(i>1||k<f-2)&&(i<g-2||k>1)&&(i<g-2||k<f-2)){var m=new Box(i*b,k*b,b,b);this.bricks.push(m);this.addBody(m)}return this};
Game.deserialize=function(b){var c=new Game(b.width,b.height),g=function(f){if(b[f].pos.length>0){var k=b[f].size,i=Math.floor(b.width/k);_.each(b[f].pos,function(m){var n=new Box(m%i*k,Math.floor(m/i)*k,k,k);_.each(b[f].attrs,function(o,r){n[r]=b[f].attrs[r]});c[f].push(n);c.addBody(n)})}};g("blocks");g("bricks");b.players&&b.players.length>0&&_.each(b.players,function(f){c.addBody(Player.deserialize(f),true)});c.guid=b.guid;return c};var $infoArea,utils={};
utils.log=function(b,c){if(arguments.length===1){c=b;b=c.cmd}typeof console!=="undefined"&&console!==null&&console.log(b,c);c=b+" - "+c.result;$infoArea.val($infoArea.val()+($infoArea.val().length>0?"\n":"")+c);$infoArea.attr("scrollTop",$infoArea.attr("scrollHeight"))};
$(function(){$infoArea=$("#infoArea");var b=new HttpClient,c=new SocketClient,g=new GameHandler(void 0,c);new GamePanel(g);new LobbyPanel(void 0);new LobbyHandler(g,b,c);utils.log({cmd:"versions",result:"OGE: "+OGE.version+". Game: "+Game.version+". Client: 0.1"})});
LobbyHandler=function(b,c,g){var f;this.createGame=function(k){c.createGame(function(i){if(i.result==="OK"){i=Game.deserialize(i.data);b.startGame(i,f.nick);k(true)}else k(fale)})};this.playNow=function(k){c.playNow(function(i){if(i.result==="OK"){i=Game.deserialize(i.data);b.startGame(i,f.nick);k(true)}else k(false)})};this.login=function(k,i){c.login(k,function(m){if(m.result==="OK"){f=m.data;g.send("authPlayer",{guid:f.guid});i(true)}else i(false)})}};
HttpClient=function(){var b;this.createGame=function(c){$.getJSON("/lobby?cmd=createGame&guid="+b.guid,function(g){utils.log("createGame",g);c(g)})};this.playNow=function(c){$.getJSON("/lobby?cmd=joinGame&guid="+b.guid,function(g){utils.log("playNow",g);c(g)})};this.login=function(c,g){$.getJSON("/lobby?cmd=loginPlayer&nick="+c,function(f){utils.log("loginPlayer",f);if(f.result==="OK")b=f.data;g(f)})}};
LobbyPanel=function(b){var c=$("#loginPanel"),g=$("#loginButton"),f=$("#lobbyPanel"),k=$("#nickField"),i=$("#playNowButton"),m=$("#createGameButton"),n=function(){b.createGame(function(w){w&&f.hide()})},o=function(){b.playNow(function(){f.hide()})},r=function(){k.val().length>0&&b.login(k.val(),function(w){if(w){c.hide();f.show()}else{k.focus();c.children("span").text("Nick taken!")}})};(function(){k.keypress(function(w){if(w.keyCode===13){k.blur();r()}});g.click(function(){r()});i.click(function(){o()});
m.click(function(){n()});k.focus()})()};
GameHandler=function(b,c){var g,f,k;listeners={};this.addListener=function(i,m){if(typeof listeners[i]==="undefined")listeners[i]=[];listeners[i].push(m)};this.removeBody=function(i){g.removeBody(i)};this.startGame=function(i,m){g=i;f=g.getPlayer(m);k=new FactorialTimer;var n=(new Date).getTime(),o;k.start(function(){n=(new Date).getTime()-n;o=(new Date).getTime();g.world.step();o=(new Date).getTime()-o;var r=Math.floor(1E3/n);_.each(listeners.step,function(w){w(n,r,o)});n=(new Date).getTime()});
_.each(listeners.startGame,function(r){r(g)})};this.startMove=function(i,m){if(!f.dead){f.direction=new OGE.Direction(i,m);c.send("startMove",{cos:i,sin:m,x:f.x,y:f.y})}};this.endMove=function(){if(!f.dead){f.direction=null;c.send("endMove",{x:f.x,y:f.y})}};this.placeBomb=function(){if(!f.dead)if(f.bombs>0){var i=new Bomb(Math.floor((f.x+8)/16)*16,Math.floor((f.y+8)/16)*16,16,16);i.size=2;g.addBody(i);i.power=f.power;c.send("placeBomb",{x:i.x,y:i.y});return i}};c.addListener("joinGame",function(i,
m){p=Player.deserialize(m.player);g.addBody(p,true);_.each(listeners.addPlayer,function(n){n(p)})});c.addListener("startMove",function(i,m){p=g.getPlayer(m.player);p.direction=new OGE.Direction(m.cos,m.sin);p.x=m.x;p.y=m.y});c.addListener("endMove",function(i,m){p=g.getPlayer(m.player);p.direction=null;p.x=m.x;p.y=m.y});c.addListener("logoutPlayer",function(i,m){p=g.getPlayer(m.player);p.$img.remove();g.removeBody(p)});c.addListener("placeBomb",function(i,m){var n=new Bomb(m.x,m.y,16,16);g.addBody(n);
_.each(listeners.placeBomb,function(o){o(n)})});c.addListener("explodeBomb",function(i,m){var n=g.getBomb(m.x,m.y);g.getPlayer(m.player).bombs++;if(n!==null){var o=g.explodeBomb(n);g.removeBodies(o.bombs,Bomb);if(_.include(o.bodies,f)){f.x=0;f.y=0;c.send("playerDead",{})}_.each(listeners.explodeBomb,function(r){r(n,o)})}});c.addListener("playerDead",function(i,m){var n=g.getPlayer(m.player);n.x=0;n.y=0;_.each(listeners.playerDead,function(){})});c.addListener("resurectPlayer",function(i,m){var n=
g.getPlayer(m.player);g.addBody(n);_.each(listeners.resurectPlayer,function(o){o(n)})})};SocketClient=function(){var b=new io.Socket,c={};this.addListener=function(g,f){if(typeof c[g]==="undefined")c[g]=[];c[g].push(f)};this.send=function(g,f){b.send({cmd:g,data:f})};b.connect();b.on("message",function(g){utils.log(g);_.each(c[g.cmd],function(f){f(g.result,g.data)})})};
GamePanel=function(b){var c=$("#gamePanel"),g=$("#fpsLabel"),f,k=[],i=[];b.addListener("startGame",function(l){f=new KeyboardHandler;c.find("*").remove();c.show();c.width(l.world.width).height(l.world.height);_.each(l.blocks,function(u){m(u,"objects")});_.each(l.bricks,function(u){m(u,"objects");u.offsetSprite=1;w(u)});_.each(l.players,function(u){n(u)});f.keydown(function(u){var z=0,v=0;switch(u){case "space":(u=b.placeBomb())&&o(u);break;case "left":z=-1;break;case "up":v=-1;break;case "right":z=
1;break;case "down":v=1}if(z!==0||v!==0)b.startMove(z,v)}).keyup(function(){b.endMove()});var x=0;b.addListener("step",function(u,z,v){var A=(new Date).getTime();_.each(l.players,function(t){if(t.animate===0&&t.direction!==null&&t.speed>0){t.animate=5;t.sprite=0}else if(t.animate>0&&t.direction===null||t.speed===0)t.animate=0;r(t)});_.each(l.bombs,function(t){r(t)});_.each(k,function(t){r(t);if(t.sprite===t.sprites.length-1&&t.animate===1){k=_.without(k,t);t.$img.remove()}});_.each(i,function(t){r(t);
if(t.sprite===t.sprites.length-1&&t.animate===1){i=_.without(i,t);t.$img.remove();b.removeBody(t)}});if(++x===20){A=(new Date).getTime()-A;g.text("Total time: "+u+". Engine time: "+v+". Drawing time: "+A+" . fps: "+z);x=0}});b.addListener("explodeBomb",function(u,z){_.each(z.bombs,function(v){v.$img.remove()});_.each(z.fires,function(v){var A=0;switch(v.firevar){case "l":A=2;break;case "r":A=3;break;case "u":A=4;break;case "d":A=1;break;case "h":A=5;break;case "v":A=6}m(v,"fires");v.direction=null;
v.sprites=[0,1,2,3];v.offsetSprite=A;v.animate=5;k.push(v)});_.each(z.bodies,function(v){if(v instanceof Box){v.animate=5;v.sprite=0;v.offsetSprite=1;v.sprites=[1,2];v.animateTimer=10;i.push(v)}else v instanceof Bomb&&v.$img.remove()})})});b.addListener("addPlayer",function(l){n(l)});b.addListener("placeBomb",function(l){o(l)});b.addListener("meDead",function(l){l.$img.remove()});b.addListener("playerDead",function(l){l.$img.remove()});b.addListener("resurectPlayer",function(l){c.append(l.$img)});
var m=function(l,x){var u=$("<div>").css("background","url(images/"+x+".png)").css("left",l.x).css("top",l.y).addClass("body");l.$img=u;l.sprite=0;l.offsetSprite=0;l.animate=0;l.animateCount=0;l.sprites=[0];l.animateTimer=5;w(l);c.append(u);return u},n=function(l){m(l,"players").addClass("player");l.sprites=[0,1,0,2]},o=function(l){m(l,"objects");l.sprites=[0,1,2];l.animate=5;l.offsetSprite=2},r=function(l){l.direction!==null&&l.speed>0&&l.$img.css("left",l.x).css("top",l.y-4);if(l.animate>0){if(l.lastDirection!==
l.direction){l.animate=0;l.lastDirection=l.direction}if(--l.animate<=0){l.animate=l.animateTimer;if(++l.sprite>=l.sprites.length)l.sprite=0;var x=0;if(l.direction!==null)if(l.direction.cos!==0)x=l.direction.cos>0?3:2;else if(l.direction.sin!==0)x=l.direction.sin>0?0:1;w(l,x)}}},w=function(l,x){if(arguments.length===1)x=0;l.$img.css("background-position",-(18*(x+l.offsetSprite))+"px "+-(22*l.sprites[l.sprite])+"px")}};
KeyboardHandler=function(){var b,c,g;this.keydown=function(f){c=f;return this};this.keyup=function(f){g=f;return this};$(document).keydown(function(f){var k=null;switch(f.keyCode){case 32:k="space";break;case 37:case 65:k="left";break;case 38:case 87:k="up";break;case 39:case 68:k="right";break;case 40:case 83:k="down"}if(k!==null){if(b!==f.keyCode){b=k!=="space"?f.keyCode:b;c(k)}f.stopPropagation();f.preventDefault();return false}}).keyup(function(f){if(f.keyCode===b){b=0;g()}}).keypress(function(f){switch(f.keyCode){case 32:case 37:case 38:case 39:case 40:f.stopPropagation();
f.preventDefault();return false}})};FactorialTimer=function(){(new Date).getTime();var b;this.start=function(g){b=g;setInterval(c,50)};var c=function(){b()}};
